<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Super Learning | [ENAR 2023 Short Course] Targeted Learning</title>
<meta name="author" content="Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips">
<meta name="description" content="Rachael Phillips Based on the sl3 R package by Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips, and Oleg Sofrygin. Learning Objectives By the end of this chapter you will be able to:...">
<meta name="generator" content="bookdown 0.32.2 with bs4_book()">
<meta property="og:title" content="Chapter 3 Super Learning | [ENAR 2023 Short Course] Targeted Learning">
<meta property="og:type" content="book">
<meta property="og:url" content="https://tlverse.org/enar2023-workshop/sl3.html">
<meta property="og:description" content="Rachael Phillips Based on the sl3 R package by Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips, and Oleg Sofrygin. Learning Objectives By the end of this chapter you will be able to:...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Super Learning | [ENAR 2023 Short Course] Targeted Learning">
<meta name="twitter:description" content="Rachael Phillips Based on the sl3 R package by Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips, and Oleg Sofrygin. Learning Objectives By the end of this chapter you will be able to:...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body>
<span class="math inline">
  \(\DeclareMathOperator{\expit}{expit}\)
  \(\DeclareMathOperator{\logit}{logit}\)
  \(\DeclareMathOperator*{\argmin}{\arg\!\min}\)
  \(\newcommand{\indep}{\perp\!\!\!\perp}\)
  \(\newcommand{\coloneqq}{\mathrel{=}}\)
  \(\newcommand{\R}{\mathbb{R}}\)
  \(\newcommand{\E}{\mathbb{E}}\)
  \(\newcommand{\M}{\mathcal{M}}\)
  \(\renewcommand{\P}{\mathbb{P}}\)
  \(\newcommand{\I}{\mathbb{I}}\)
  \(\newcommand{\1}{\mathbbm{1}}\)
  </span>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Advanced Methods for Causal Machine Learning">[ENAR 2023 Short Course] Targeted Learning</a>:
        <small class="text-muted">Advanced Methods for Causal Machine Learning</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Course Information</a></li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li class="book-part">Part 1: Preliminaries</li>
<li><a class="" href="setting-up-r-and-rstudio.html">Setting up R and RStudio</a></li>
<li><a class="" href="install-software-packages.html">Install Software Packages</a></li>
<li><a class="" href="supplemental-learning-resources.html">Supplemental Learning Resources</a></li>
<li class="book-part">Part 2: The tlverse</li>
<li><a class="" href="what-is-the-tlverse.html">What is the tlverse?</a></li>
<li><a class="" href="primer-on-the-r6-class-system.html">Primer on the R6 Class System</a></li>
<li class="book-part">Part 3: Foundations</li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> The Roadmap for Targeted Learning</a></li>
<li><a class="" href="example-dataset.html">Example Dataset</a></li>
<li><a class="" href="origami.html"><span class="header-section-number">2</span> Cross-validation</a></li>
<li><a class="active" href="sl3.html"><span class="header-section-number">3</span> Super Learning</a></li>
<li><a class="" href="tmle3.html"><span class="header-section-number">4</span> The TMLE Framework</a></li>
<li class="book-part">Part 4: Advanced Topics</li>
<li><a class="" href="optimal-individualized-treatment-regimes.html"><span class="header-section-number">5</span> Optimal Individualized Treatment Regimes</a></li>
<li><a class="" href="stochastic-treatment-regimes.html"><span class="header-section-number">6</span> Stochastic Treatment Regimes</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tlverse/enar2023-workshop">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="sl3" class="section level1">
<h1>
<span class="header-section-number">3</span> Super Learning<a class="anchor" aria-label="anchor" href="#sl3"><i class="fas fa-link"></i></a>
</h1>
<p><em>Rachael Phillips</em></p>
<p>Based on the <a href="https://github.com/tlverse/sl3"><code>sl3</code> <code>R</code> package</a> by <em>Jeremy
Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips, and Oleg Sofrygin</em>.</p>
<div id="learning-objectives-2" class="section level3 unnumbered">
<h3>Learning Objectives<a class="anchor" aria-label="anchor" href="#learning-objectives-2"><i class="fas fa-link"></i></a>
</h3>
<p>By the end of this chapter you will be able to:</p>
<ol style="list-style-type: decimal">
<li><p>Select a performance metric that is optimized by the true prediction
function, or define the true prediction prediction of interest as the
optimizer of the performance metric.</p></li>
<li>
<p>Assemble a diverse set (“library”) of learners to be considered in the super
learner. In particular, you should be able to:</p>
<ol style="list-style-type: lower-alpha">
<li>Customize a learner by modifying its tuning parameters.</li>
<li>Create variations of the same base learner with different tuning
parameter specifications.</li>
<li>Couple screener(s) with learner(s) to create learners that consider as
covariates a reduced, screener-selected subset of them.</li>
</ol>
</li>
<li><p>Specify a meta-learner that optimizes the objective function of interest.</p></li>
<li><p>Justify the library and the meta-learner in terms of the prediction problem
at hand, intended use of the analysis in the real world, statistical model,
sample size, number of covariates, and outcome prevalence for discrete
outcomes.</p></li>
<li><p>Interpret the fit for a super learner from the table of cross-validated risk
estimates and the super learner coefficients.</p></li>
</ol>
</div>
<div id="introduction-3" class="section level2">
<h2>
<span class="header-section-number">3.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-3"><i class="fas fa-link"></i></a>
</h2>
<p>A common task in data analysis is prediction, or using the observed data to
learn a function that takes as input data on covariates/predictors and outputs a
predicted value. Occasionally, the scientific question of interest lends itself
to causal effect estimation. Even in these scenarios, where prediction is not in
the forefront, prediction tasks are embedded in the procedure. For instance, in
targeted minimum loss-based estimation (TMLE), predictive modeling is necessary
for estimating outcome regressions and propensity scores.</p>
<p>There are various strategies that can be employed to model relationships from
data, which we refer to interchangeably as “estimators”, “algorithms”, and
“learners”. For some data algorithms that can pick up on complex relationships
in the data are necessary to adequately model it, and for other data parametric
regression learners might fit the data reasonably well. It is generally
impossible to know in advance which approach will be the best for a given data
set and prediction problem.</p>
<p>The Super Learner (SL) solves the issue of selecting an algorithm, as it can
consider many of them, from the simplest parametric regressions to the most
complex machine learning algorithms (e.g., neural nets, support vector machines,
etc). Additionally, it is proven to perform as well as possible in large
samples, given the learners specified <span class="citation">(van der Laan, Polley, and Hubbard <a href="references.html#ref-vdl2007super" role="doc-biblioref">2007</a>)</span>. The SL represents an
entirely pre-specified, flexible, and theoretically grounded approach for
predictive modeling. It has been shown to be adaptive and robust in a variety of
applications, and in even in very small samples. Detailed descriptions outlining
the SL procedure are widely available <span class="citation">(Polley and van der Laan <a href="references.html#ref-polley2010super" role="doc-biblioref">2010</a>; Naimi and Balzer <a href="references.html#ref-naimi2018stacked" role="doc-biblioref">2018</a>)</span>.
Practical considerations for specifying the SL, including how to specify a rich
and diverse library of learners, choose a performance metric for the SL, and
specify a cross-validation (CV) scheme, are described in a pre-print article
<span class="citation">(Phillips et al. <a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>. Here, we focus on introducing <code>sl3</code>, the standard <code>tlverse</code>
software package for SL.</p>
<!--
Add more about sl3: how it's different from SuperLearner, supported features,
GitHub, filing issues, support, documentation, etc.
-->
</div>
<div id="super-learning-with-sl3" class="section level2 unnumbered">
<h2>Super Learning with <code>sl3</code>:<a class="anchor" aria-label="anchor" href="#super-learning-with-sl3"><i class="fas fa-link"></i></a>
</h2>
</div>
<div id="how-to-fit-the-super-learner" class="section level2">
<h2>
<span class="header-section-number">3.2</span> How to Fit the Super Learner<a class="anchor" aria-label="anchor" href="#how-to-fit-the-super-learner"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, the core functionality for fitting any SL with <code>sl3</code> is
illustrated. In the sections that follow, additional <code>sl3</code> functionality is
presented.</p>
<p>Fitting any SL with <code>sl3</code> consists of the following three steps:</p>
<ol style="list-style-type: decimal">
<li>Define the prediction task with <code>make_sl3_Task</code>.</li>
<li>Instantiate the SL with <code>Lrnr_sl</code>.</li>
<li>Fit the SL to the task with <code>train</code>.</li>
</ol>
<div id="running-example-with-wash-benefits-dataset" class="section level4 unnumbered">
<h4>Running example with WASH Benefits dataset<a class="anchor" aria-label="anchor" href="#running-example-with-wash-benefits-dataset"><i class="fas fa-link"></i></a>
</h4>
<p>We will use the WASH Benefits Bangladesh study as an example to guide this
overview of <code>sl3</code>. In this study, say we are interested in predicting the child development outcome, weight-for-height z-score, from covariates/predictors,
including socio-economic status variables, gestational age, and maternal
features. More information on this dataset is described in the <a href="https://tlverse.org/tlverse-handbook/data.html#wash">“Meet
the Data”</a> chapter of the
<code>tlverse</code> handbook.</p>
</div>
<div id="preliminaries" class="section level4 unnumbered">
<h4>Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"><i class="fas fa-link"></i></a>
</h4>
<p>First, we need to load the data and relevant packages into the R session.</p>
<div id="load-the-data" class="section level5 unnumbered">
<h5>Load the data<a class="anchor" aria-label="anchor" href="#load-the-data"><i class="fas fa-link"></i></a>
</h5>
<p>We will use the <code>fread</code> function in the <code>data.table</code> R package to load the
WASH Benefits example dataset:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span></span>
<span><span class="va">washb_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://raw.githubusercontent.com/tlverse/tlverse-data/master/"</span>,</span>
<span>    <span class="st">"wash-benefits/washb_data.csv"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we will take a peek at the first few rows of our dataset:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
whz
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
month
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
aged
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
sex
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momage
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momedu
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momheight
</th>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
hfiacat
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Nlt18
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Ncomp
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
watmin
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
elec
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
floor
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
walls
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
roof
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_wardrobe
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_table
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_chair
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_khat
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_chouki
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_tv
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_refrig
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_bike
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_moto
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_sewmach
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_mobile
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:left;">
Control
</td>
<td style="text-align:left;">
N05265
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
268
</td>
<td style="text-align:left;">
male
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:left;">
Primary (1-5y)
</td>
<td style="text-align:right;">
146.40
</td>
<td style="text-align:left;">
Food Secure
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
-1.16
</td>
<td style="text-align:left;">
Control
</td>
<td style="text-align:left;">
N05265
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
286
</td>
<td style="text-align:left;">
male
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:left;">
Primary (1-5y)
</td>
<td style="text-align:right;">
148.75
</td>
<td style="text-align:left;">
Moderately Food Insecure
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
-1.05
</td>
<td style="text-align:left;">
Control
</td>
<td style="text-align:left;">
N08002
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
264
</td>
<td style="text-align:left;">
male
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:left;">
Primary (1-5y)
</td>
<td style="text-align:right;">
152.15
</td>
<td style="text-align:left;">
Food Secure
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
-1.26
</td>
<td style="text-align:left;">
Control
</td>
<td style="text-align:left;">
N08002
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
252
</td>
<td style="text-align:left;">
female
</td>
<td style="text-align:right;">
28
</td>
<td style="text-align:left;">
Primary (1-5y)
</td>
<td style="text-align:right;">
140.25
</td>
<td style="text-align:left;">
Food Secure
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.59
</td>
<td style="text-align:left;">
Control
</td>
<td style="text-align:left;">
N06531
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
336
</td>
<td style="text-align:left;">
female
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:left;">
Secondary (&gt;5y)
</td>
<td style="text-align:right;">
150.95
</td>
<td style="text-align:left;">
Food Secure
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.51
</td>
<td style="text-align:left;">
Control
</td>
<td style="text-align:left;">
N06531
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
304
</td>
<td style="text-align:left;">
male
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:left;">
Secondary (&gt;5y)
</td>
<td style="text-align:right;">
154.20
</td>
<td style="text-align:left;">
Severely Food Insecure
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="install-sl3-software-as-needed" class="section level5 unnumbered">
<h5>Install <code>sl3</code> software (as needed)<a class="anchor" aria-label="anchor" href="#install-sl3-software-as-needed"><i class="fas fa-link"></i></a>
</h5>
<p>To install any package, we recommend first clearing the R workspace and then
restarting the R session. In RStudio, this can be achieved by clicking the
tab “Session” then “Clear Workspace”, and then clicking “Session” again then
“Restart R”.</p>
<p>We can install <code>sl3</code> using the function <code>install_github</code> provided in the
<code>devtools</code> R package. We are using the development (“devel”) version of <code>sl3</code>
in these materials, so we show how to install that version below.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/">devtools</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"tlverse/sl3@devel"</span><span class="op">)</span></span></code></pre></div>
<p>Once the R package is installed, we recommend restarting the R session again.</p>
<!--
If you would like to use newer `sl3` functionality that is available in the
devel branch of the `sl3` GitHub repository, you need to install that version
of the package (i.e., `usethis::install_github(tlverse/sl3@devel)`), re-start
your `R` session, and then re-load the `sl3` package.
-->
</div>
<div id="load-sl3-software" class="section level5 unnumbered">
<h5>Load <code>sl3</code> software<a class="anchor" aria-label="anchor" href="#load-sl3-software"><i class="fas fa-link"></i></a>
</h5>
<p>Once <code>sl3</code> is installed, we can load it like any other <code>R</code> package:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tlverse.org/sl3">sl3</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="define-the-prediction-task-with-make_sl3_task" class="section level3 unnumbered">
<h3>1. Define the prediction task with <code>make_sl3_Task</code><a class="anchor" aria-label="anchor" href="#define-the-prediction-task-with-make_sl3_task"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>sl3_Task</code> object defines the prediction task of interest. Recall that
our task in this illustrative example is to use the WASH Benefits Bangladesh
example dataset to learn a function of the covariates for predicting
weight-for-height Z-score <code>whz</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="sl3.html#cb29-1"></a><span class="co"># create the task (i.e., use washb_data to predict outcome using covariates)</span></span>
<span id="cb29-2"><a href="sl3.html#cb29-2"></a>task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(</span>
<span id="cb29-3"><a href="sl3.html#cb29-3"></a>  <span class="dt">data =</span> washb_data,</span>
<span id="cb29-4"><a href="sl3.html#cb29-4"></a>  <span class="dt">outcome =</span> <span class="st">"whz"</span>,</span>
<span id="cb29-5"><a href="sl3.html#cb29-5"></a>  <span class="dt">covariates =</span> <span class="kw">c</span>(</span>
<span id="cb29-6"><a href="sl3.html#cb29-6"></a>    <span class="st">"tr"</span>, <span class="st">"fracode"</span>, <span class="st">"month"</span>, <span class="st">"aged"</span>, <span class="st">"sex"</span>, <span class="st">"momage"</span>, <span class="st">"momedu"</span>,</span>
<span id="cb29-7"><a href="sl3.html#cb29-7"></a>    <span class="st">"momheight"</span>, <span class="st">"hfiacat"</span>, <span class="st">"Nlt18"</span>, <span class="st">"Ncomp"</span>, <span class="st">"watmin"</span>, <span class="st">"elec"</span>,</span>
<span id="cb29-8"><a href="sl3.html#cb29-8"></a>    <span class="st">"floor"</span>, <span class="st">"walls"</span>, <span class="st">"roof"</span>, <span class="st">"asset_wardrobe"</span>, <span class="st">"asset_table"</span>,</span>
<span id="cb29-9"><a href="sl3.html#cb29-9"></a>    <span class="st">"asset_chair"</span>, <span class="st">"asset_khat"</span>, <span class="st">"asset_chouki"</span>, <span class="st">"asset_tv"</span>,</span>
<span id="cb29-10"><a href="sl3.html#cb29-10"></a>    <span class="st">"asset_refrig"</span>, <span class="st">"asset_bike"</span>, <span class="st">"asset_moto"</span>, <span class="st">"asset_sewmach"</span>,</span>
<span id="cb29-11"><a href="sl3.html#cb29-11"></a>    <span class="st">"asset_mobile"</span></span>
<span id="cb29-12"><a href="sl3.html#cb29-12"></a>  )</span>
<span id="cb29-13"><a href="sl3.html#cb29-13"></a>)</span>
<span id="cb29-14"><a href="sl3.html#cb29-14"></a></span>
<span id="cb29-15"><a href="sl3.html#cb29-15"></a><span class="co"># let's examine the task</span></span>
<span id="cb29-16"><a href="sl3.html#cb29-16"></a>task</span>
<span id="cb29-17"><a href="sl3.html#cb29-17"></a>An sl3 Task with <span class="dv">4695</span> obs and these nodes<span class="op">:</span></span>
<span id="cb29-18"><a href="sl3.html#cb29-18"></a><span class="er">$</span>covariates</span>
<span id="cb29-19"><a href="sl3.html#cb29-19"></a> [<span class="dv">1</span>] <span class="st">"tr"</span>              <span class="st">"fracode"</span>         <span class="st">"month"</span>           <span class="st">"aged"</span>           </span>
<span id="cb29-20"><a href="sl3.html#cb29-20"></a> [<span class="dv">5</span>] <span class="st">"sex"</span>             <span class="st">"momage"</span>          <span class="st">"momedu"</span>          <span class="st">"momheight"</span>      </span>
<span id="cb29-21"><a href="sl3.html#cb29-21"></a> [<span class="dv">9</span>] <span class="st">"hfiacat"</span>         <span class="st">"Nlt18"</span>           <span class="st">"Ncomp"</span>           <span class="st">"watmin"</span>         </span>
<span id="cb29-22"><a href="sl3.html#cb29-22"></a>[<span class="dv">13</span>] <span class="st">"elec"</span>            <span class="st">"floor"</span>           <span class="st">"walls"</span>           <span class="st">"roof"</span>           </span>
<span id="cb29-23"><a href="sl3.html#cb29-23"></a>[<span class="dv">17</span>] <span class="st">"asset_wardrobe"</span>  <span class="st">"asset_table"</span>     <span class="st">"asset_chair"</span>     <span class="st">"asset_khat"</span>     </span>
<span id="cb29-24"><a href="sl3.html#cb29-24"></a>[<span class="dv">21</span>] <span class="st">"asset_chouki"</span>    <span class="st">"asset_tv"</span>        <span class="st">"asset_refrig"</span>    <span class="st">"asset_bike"</span>     </span>
<span id="cb29-25"><a href="sl3.html#cb29-25"></a>[<span class="dv">25</span>] <span class="st">"asset_moto"</span>      <span class="st">"asset_sewmach"</span>   <span class="st">"asset_mobile"</span>    <span class="st">"delta_momage"</span>   </span>
<span id="cb29-26"><a href="sl3.html#cb29-26"></a>[<span class="dv">29</span>] <span class="st">"delta_momheight"</span></span>
<span id="cb29-27"><a href="sl3.html#cb29-27"></a></span>
<span id="cb29-28"><a href="sl3.html#cb29-28"></a><span class="op">$</span>outcome</span>
<span id="cb29-29"><a href="sl3.html#cb29-29"></a>[<span class="dv">1</span>] <span class="st">"whz"</span></span>
<span id="cb29-30"><a href="sl3.html#cb29-30"></a></span>
<span id="cb29-31"><a href="sl3.html#cb29-31"></a><span class="op">$</span>id</span>
<span id="cb29-32"><a href="sl3.html#cb29-32"></a><span class="ot">NULL</span></span>
<span id="cb29-33"><a href="sl3.html#cb29-33"></a></span>
<span id="cb29-34"><a href="sl3.html#cb29-34"></a><span class="op">$</span>weights</span>
<span id="cb29-35"><a href="sl3.html#cb29-35"></a><span class="ot">NULL</span></span>
<span id="cb29-36"><a href="sl3.html#cb29-36"></a></span>
<span id="cb29-37"><a href="sl3.html#cb29-37"></a><span class="op">$</span>offset</span>
<span id="cb29-38"><a href="sl3.html#cb29-38"></a><span class="ot">NULL</span></span>
<span id="cb29-39"><a href="sl3.html#cb29-39"></a></span>
<span id="cb29-40"><a href="sl3.html#cb29-40"></a><span class="op">$</span>time</span>
<span id="cb29-41"><a href="sl3.html#cb29-41"></a><span class="ot">NULL</span></span></code></pre></div>
<p>The <code>sl3_Task</code> keeps track of the roles the variables play in the prediction
problem. Additional information relevant to the prediction task (such as
observational-level weights, offset, id, CV folds) can also be specified in
<code>make_sl3_Task</code>. The default CV fold structure in <code>sl3</code> is V-fold CV (VFCV)
with V=10 folds; if <code>id</code> is specified in the task then a clustered V=10 VFCV
scheme is considered, and if the outcome type is binary or categorical then
a stratified V=10 VFCV scheme is considered. Different CV schemes can be
specified by inputting an <code>origami</code> folds object, as generated by the
<code>make_folds</code> function in the <code>origami</code> R package. Refer to the documentation
on <code>origami</code>’s <code>make_folds</code> function for more information (e.g., in RStudio, by
loading the <code>origami</code> R package and then inputting “?make_folds” in the
Console). For more details on <code>sl3_Task</code>, refer to its documentation (e.g., by
inputting “?sl3_Task” in R).</p>
<p><em>Tip:</em> If you type <code>task$</code> and then press the tab key (press tab twice if not in
RStudio), you can view all of the active and public fields, and methods that
can be accessed from the <code>task$</code> object. This <code>$</code> is like the key to access
many internals of an object. In the next section, will see how we can use <code>$</code>
to dig into SL fit objects as well, to obtain predictions from an SL fit or
candidate learners, examine an SL fit or its candidates, and summarize an SL
fit.</p>
</div>
<div id="instantiate-the-super-learner-with-lrnr_sl" class="section level3 unnumbered">
<h3>2. Instantiate the Super Learner with <code>Lrnr_sl</code><a class="anchor" aria-label="anchor" href="#instantiate-the-super-learner-with-lrnr_sl"><i class="fas fa-link"></i></a>
</h3>
<p>In order to create <code>Lrnr_sl</code> we need to specify, at the minimum, a set of
learners for the SL to consider as candidates. This set of algorithms is
also commonly referred to as the “library”. We might also specify the
meta-learner, which is the algorithm that ensembles the learners, but this is
optional since there are already defaults set up in <code>sl3</code>. See “Practical
considerations for specifying a super learner” for step-by-step guidelines for
tailoring the SL specification, including the library and meta-learner(s), to
perform well for the prediction task at hand <span class="citation">(Phillips et al. <a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>.</p>
<p>Learners have properties that indicate what features they support. We may use
the <code><a href="https://tlverse.org/sl3/reference/list_learners.html">sl3_list_properties()</a></code> function to get a list of all properties supported
by at least one learner:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="sl3.html#cb30-1"></a><span class="kw">sl3_list_properties</span>()</span>
<span id="cb30-2"><a href="sl3.html#cb30-2"></a> [<span class="dv">1</span>] <span class="st">"binomial"</span>      <span class="st">"categorical"</span>   <span class="st">"continuous"</span>    <span class="st">"cv"</span>           </span>
<span id="cb30-3"><a href="sl3.html#cb30-3"></a> [<span class="dv">5</span>] <span class="st">"density"</span>       <span class="st">"h2o"</span>           <span class="st">"ids"</span>           <span class="st">"importance"</span>   </span>
<span id="cb30-4"><a href="sl3.html#cb30-4"></a> [<span class="dv">9</span>] <span class="st">"offset"</span>        <span class="st">"preprocessing"</span> <span class="st">"sampling"</span>      <span class="st">"screener"</span>     </span>
<span id="cb30-5"><a href="sl3.html#cb30-5"></a>[<span class="dv">13</span>] <span class="st">"timeseries"</span>    <span class="st">"weights"</span>       <span class="st">"wrapper"</span>      </span></code></pre></div>
<p>Since <code>whz</code> is a continuous outcome, we can identify the learners that support
this outcome type with <code><a href="https://tlverse.org/sl3/reference/list_learners.html">sl3_list_learners()</a></code>:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="sl3.html#cb31-1"></a><span class="kw">sl3_list_learners</span>(<span class="dt">properties =</span> <span class="st">"continuous"</span>)</span>
<span id="cb31-2"><a href="sl3.html#cb31-2"></a> [<span class="dv">1</span>] <span class="st">"Lrnr_arima"</span>                     <span class="st">"Lrnr_bartMachine"</span>              </span>
<span id="cb31-3"><a href="sl3.html#cb31-3"></a> [<span class="dv">3</span>] <span class="st">"Lrnr_bayesglm"</span>                  <span class="st">"Lrnr_bilstm"</span>                   </span>
<span id="cb31-4"><a href="sl3.html#cb31-4"></a> [<span class="dv">5</span>] <span class="st">"Lrnr_bound"</span>                     <span class="st">"Lrnr_caret"</span>                    </span>
<span id="cb31-5"><a href="sl3.html#cb31-5"></a> [<span class="dv">7</span>] <span class="st">"Lrnr_cv_selector"</span>               <span class="st">"Lrnr_dbarts"</span>                   </span>
<span id="cb31-6"><a href="sl3.html#cb31-6"></a> [<span class="dv">9</span>] <span class="st">"Lrnr_earth"</span>                     <span class="st">"Lrnr_expSmooth"</span>                </span>
<span id="cb31-7"><a href="sl3.html#cb31-7"></a>[<span class="dv">11</span>] <span class="st">"Lrnr_ga"</span>                        <span class="st">"Lrnr_gam"</span>                      </span>
<span id="cb31-8"><a href="sl3.html#cb31-8"></a>[<span class="dv">13</span>] <span class="st">"Lrnr_gbm"</span>                       <span class="st">"Lrnr_glm"</span>                      </span>
<span id="cb31-9"><a href="sl3.html#cb31-9"></a>[<span class="dv">15</span>] <span class="st">"Lrnr_glm_fast"</span>                  <span class="st">"Lrnr_glm_semiparametric"</span>       </span>
<span id="cb31-10"><a href="sl3.html#cb31-10"></a>[<span class="dv">17</span>] <span class="st">"Lrnr_glmnet"</span>                    <span class="st">"Lrnr_glmtree"</span>                  </span>
<span id="cb31-11"><a href="sl3.html#cb31-11"></a>[<span class="dv">19</span>] <span class="st">"Lrnr_grf"</span>                       <span class="st">"Lrnr_grfcate"</span>                  </span>
<span id="cb31-12"><a href="sl3.html#cb31-12"></a>[<span class="dv">21</span>] <span class="st">"Lrnr_gru_keras"</span>                 <span class="st">"Lrnr_gts"</span>                      </span>
<span id="cb31-13"><a href="sl3.html#cb31-13"></a>[<span class="dv">23</span>] <span class="st">"Lrnr_h2o_glm"</span>                   <span class="st">"Lrnr_h2o_grid"</span>                 </span>
<span id="cb31-14"><a href="sl3.html#cb31-14"></a>[<span class="dv">25</span>] <span class="st">"Lrnr_hal9001"</span>                   <span class="st">"Lrnr_HarmonicReg"</span>              </span>
<span id="cb31-15"><a href="sl3.html#cb31-15"></a>[<span class="dv">27</span>] <span class="st">"Lrnr_hts"</span>                       <span class="st">"Lrnr_lightgbm"</span>                 </span>
<span id="cb31-16"><a href="sl3.html#cb31-16"></a>[<span class="dv">29</span>] <span class="st">"Lrnr_lstm_keras"</span>                <span class="st">"Lrnr_mean"</span>                     </span>
<span id="cb31-17"><a href="sl3.html#cb31-17"></a>[<span class="dv">31</span>] <span class="st">"Lrnr_multiple_ts"</span>               <span class="st">"Lrnr_nnet"</span>                     </span>
<span id="cb31-18"><a href="sl3.html#cb31-18"></a>[<span class="dv">33</span>] <span class="st">"Lrnr_nnls"</span>                      <span class="st">"Lrnr_optim"</span>                    </span>
<span id="cb31-19"><a href="sl3.html#cb31-19"></a>[<span class="dv">35</span>] <span class="st">"Lrnr_pkg_SuperLearner"</span>          <span class="st">"Lrnr_pkg_SuperLearner_method"</span>  </span>
<span id="cb31-20"><a href="sl3.html#cb31-20"></a>[<span class="dv">37</span>] <span class="st">"Lrnr_pkg_SuperLearner_screener"</span> <span class="st">"Lrnr_polspline"</span>                </span>
<span id="cb31-21"><a href="sl3.html#cb31-21"></a>[<span class="dv">39</span>] <span class="st">"Lrnr_randomForest"</span>              <span class="st">"Lrnr_ranger"</span>                   </span>
<span id="cb31-22"><a href="sl3.html#cb31-22"></a>[<span class="dv">41</span>] <span class="st">"Lrnr_rpart"</span>                     <span class="st">"Lrnr_rugarch"</span>                  </span>
<span id="cb31-23"><a href="sl3.html#cb31-23"></a>[<span class="dv">43</span>] <span class="st">"Lrnr_screener_correlation"</span>      <span class="st">"Lrnr_solnp"</span>                    </span>
<span id="cb31-24"><a href="sl3.html#cb31-24"></a>[<span class="dv">45</span>] <span class="st">"Lrnr_stratified"</span>                <span class="st">"Lrnr_svm"</span>                      </span>
<span id="cb31-25"><a href="sl3.html#cb31-25"></a>[<span class="dv">47</span>] <span class="st">"Lrnr_tsDyn"</span>                     <span class="st">"Lrnr_xgboost"</span>                  </span></code></pre></div>
<p>Now that we have an idea of some learners, let’s instantiate a few of them.
Below we instantiate <code>Lrnr_glm</code> and <code>Lrnr_mean</code>, a main terms generalized
linear model (GLM) and a mean model, respectively.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrn_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm.html">Lrnr_glm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lrn_mean</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>For both of the learners created above, we just used the default tuning
parameters. We can also customize a learner’s tuning parameters to incorporate
a diversity of different settings, and consider the same learner with different
tuning parameter specifications.</p>
<p>Below, we consider the same base learner, <code>Lrnr_glmnet</code> (i.e., GLMs
with elastic net regression), and create two different candidates from it:
an L2-penalized/ridge regression and an L1-penalized/lasso regression.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># penalized regressions:</span></span>
<span><span class="va">lrn_ridge</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">lrn_lasso</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>By setting <code>alpha</code> in <code>Lrnr_glmnet</code> above, we customized this learner’s tuning
parameter. When we instantiate <code>Lrnr_hal9001</code> below we show how multiple tuning
parameters (specifically, <code>max_degree</code>and <code>num_knots</code>) can be modified at the
same time.</p>
<p>Let’s also instantiate some more learners that do not enforce relationships to
be linear or monotonic, and to further diversify the set of candidates to
include nonparametric learners, since up to this point all of the learners we’ve
instantiated have been parametric.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># spline regressions:</span></span>
<span><span class="va">lrn_polspline</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_polspline.html">Lrnr_polspline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lrn_earth</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_earth.html">Lrnr_earth</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fast highly adaptive lasso (HAL) implementation</span></span>
<span><span class="va">lrn_hal</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_hal9001.html">Lrnr_hal9001</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>max_degree <span class="op">=</span> <span class="fl">2</span>, num_knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, nfolds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># tree-based methods</span></span>
<span><span class="va">lrn_ranger</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_ranger.html">Lrnr_ranger</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lrn_xgb</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Let’s also include a generalized additive model (GAM) and Bayesian GLM to
further diversify the pool that we will consider as candidates in the SL.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrn_gam</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_gam.html">Lrnr_gam</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lrn_bayesglm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_bayesglm.html">Lrnr_bayesglm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now that we’ve instantiated a set of learners, we need to put them together so
the SL can consider them as candidates. In <code>sl3</code>, we do this by creating a
so-called <code>Stack</code> of learners. A <code>Stack</code> is created in the same way we
created the learners. This is because <code>Stack</code> is a learner itself; it has the
same interface as all of the other learners. What makes a stack special is that
it considers multiple learners at once: it can train them simultaneously, so
that their predictions can be combined and/or compared.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="sl3.html#cb36-1"></a>stack &lt;-<span class="st"> </span>Stack<span class="op">$</span><span class="kw">new</span>(</span>
<span id="cb36-2"><a href="sl3.html#cb36-2"></a>  lrn_glm, lrn_mean, lrn_ridge, lrn_lasso, lrn_polspline, lrn_earth, lrn_hal,</span>
<span id="cb36-3"><a href="sl3.html#cb36-3"></a>  lrn_ranger, lrn_xgb, lrn_gam, lrn_bayesglm</span>
<span id="cb36-4"><a href="sl3.html#cb36-4"></a>)</span>
<span id="cb36-5"><a href="sl3.html#cb36-5"></a>stack</span>
<span id="cb36-6"><a href="sl3.html#cb36-6"></a> [<span class="dv">1</span>] <span class="st">"Lrnr_glm_TRUE"</span>                          </span>
<span id="cb36-7"><a href="sl3.html#cb36-7"></a> [<span class="dv">2</span>] <span class="st">"Lrnr_mean"</span>                              </span>
<span id="cb36-8"><a href="sl3.html#cb36-8"></a> [<span class="dv">3</span>] <span class="st">"Lrnr_glmnet_NULL_deviance_10_0_100_TRUE"</span></span>
<span id="cb36-9"><a href="sl3.html#cb36-9"></a> [<span class="dv">4</span>] <span class="st">"Lrnr_glmnet_NULL_deviance_10_1_100_TRUE"</span></span>
<span id="cb36-10"><a href="sl3.html#cb36-10"></a> [<span class="dv">5</span>] <span class="st">"Lrnr_polspline"</span>                         </span>
<span id="cb36-11"><a href="sl3.html#cb36-11"></a> [<span class="dv">6</span>] <span class="st">"Lrnr_earth_2_3_backward_0_1_0_0"</span>        </span>
<span id="cb36-12"><a href="sl3.html#cb36-12"></a> [<span class="dv">7</span>] <span class="st">"Lrnr_hal9001_2_1_c(3, 2)_5"</span>             </span>
<span id="cb36-13"><a href="sl3.html#cb36-13"></a> [<span class="dv">8</span>] <span class="st">"Lrnr_ranger_500_TRUE_none_1"</span>            </span>
<span id="cb36-14"><a href="sl3.html#cb36-14"></a> [<span class="dv">9</span>] <span class="st">"Lrnr_xgboost_20_1"</span>                      </span>
<span id="cb36-15"><a href="sl3.html#cb36-15"></a>[<span class="dv">10</span>] <span class="st">"Lrnr_gam_NULL_NULL_GCV.Cp"</span>              </span>
<span id="cb36-16"><a href="sl3.html#cb36-16"></a>[<span class="dv">11</span>] <span class="st">"Lrnr_bayesglm_TRUE"</span>                     </span></code></pre></div>
<p>We can see that the names of the learners in the stack are long. This is
because the default naming of a learner in <code>sl3</code> is clunky: for each learner,
every tuning parameter in <code>sl3</code> is contained in the name. In the next section,
<a href="https://tlverse.org/tlverse-handbook/sl3.html#naming-learners">“Naming
Learners”</a>,
we show a few different ways for the user to name learners as they wish.</p>
<p>Now that we have instantiated a set of learners and stacked them together, we
are ready to instantiate the SL. We will use the default meta-learner, which is
non-negative least squares (NNLS) regression (<code>Lrnr_nnls</code>) for continuous
outcomes, and we will still go ahead and specify it for illustrative purposes.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sl</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="fit-the-super-learner-to-the-prediction-task-with-train" class="section level3 unnumbered">
<h3>3. Fit the Super Learner to the prediction task with <code>train</code><a class="anchor" aria-label="anchor" href="#fit-the-super-learner-to-the-prediction-task-with-train"><i class="fas fa-link"></i></a>
</h3>
<p>The last step for fitting the SL to the prediction task is to call <code>train</code> and
supply the task. Before we call <code>train</code>, we will set a random number generator
so the results are reproducible, and we will also time it.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="sl3.html#cb38-1"></a>start_time &lt;-<span class="st"> </span><span class="kw">proc.time</span>() <span class="co"># start time</span></span>
<span id="cb38-2"><a href="sl3.html#cb38-2"></a></span>
<span id="cb38-3"><a href="sl3.html#cb38-3"></a><span class="kw">set.seed</span>(<span class="dv">4197</span>)</span>
<span id="cb38-4"><a href="sl3.html#cb38-4"></a>sl_fit &lt;-<span class="st"> </span>sl<span class="op">$</span><span class="kw">train</span>(<span class="dt">task =</span> task)</span>
<span id="cb38-5"><a href="sl3.html#cb38-5"></a></span>
<span id="cb38-6"><a href="sl3.html#cb38-6"></a>runtime_sl_fit &lt;-<span class="st"> </span><span class="kw">proc.time</span>() <span class="op">-</span><span class="st"> </span>start_time <span class="co"># end time - start time = run time</span></span>
<span id="cb38-7"><a href="sl3.html#cb38-7"></a>runtime_sl_fit</span>
<span id="cb38-8"><a href="sl3.html#cb38-8"></a>   user  system elapsed </span>
<span id="cb38-9"><a href="sl3.html#cb38-9"></a> <span class="fl">253.17</span>    <span class="fl">4.62</span>  <span class="fl">250.56</span> </span></code></pre></div>
<p>It took 250.6 seconds
(4.2 minutes) to fit the SL.</p>
<div id="summary" class="section level4 unnumbered">
<h4>Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h4>
<p>In this section, the core functionality for fitting any SL with <code>sl3</code> was
illustrated. This consists of the following three steps:</p>
<ol style="list-style-type: decimal">
<li>Define the prediction task with <code>make_sl3_Task</code>.</li>
<li>Instantiate the SL with <code>Lrnr_sl</code>.</li>
<li>Fit the SL to the task with <code>train</code>.</li>
</ol>
<p>This example was for demonstrative purposes only. See <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span> for
step-by-step guidelines for constructing a SL that is well-specified for the
prediction task at hand.</p>
</div>
</div>
</div>
<div id="additional-sl3-topics" class="section level2 unnumbered">
<h2>Additional <code>sl3</code> Topics:<a class="anchor" aria-label="anchor" href="#additional-sl3-topics"><i class="fas fa-link"></i></a>
</h2>
</div>
<div id="obtaining-predictions" class="section level2">
<h2>
<span class="header-section-number">3.3</span> Obtaining Predictions<a class="anchor" aria-label="anchor" href="#obtaining-predictions"><i class="fas fa-link"></i></a>
</h2>
<div id="super-learner-and-candidate-learner-predictions" class="section level3">
<h3>
<span class="header-section-number">3.3.1</span> Super learner and candidate learner predictions<a class="anchor" aria-label="anchor" href="#super-learner-and-candidate-learner-predictions"><i class="fas fa-link"></i></a>
</h3>
<p>We will draw on the fitted SL object from above, <code>sl_fit</code>, to obtain the
SL’s predicted <code>whz</code> value for each subject.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="sl3.html#cb39-1"></a>sl_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span><span class="kw">predict</span>(<span class="dt">task =</span> task)</span>
<span id="cb39-2"><a href="sl3.html#cb39-2"></a><span class="kw">head</span>(sl_preds)</span>
<span id="cb39-3"><a href="sl3.html#cb39-3"></a>[<span class="dv">1</span>] <span class="fl">-0.55036</span> <span class="fl">-0.87149</span> <span class="fl">-0.71521</span> <span class="fl">-0.75967</span> <span class="fl">-0.63134</span> <span class="fl">-0.67732</span></span></code></pre></div>
<p>We can also obtain predicted values from a candidate learner in the SL. Below
we obtain predictions for the GLM learner.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="sl3.html#cb40-1"></a>glm_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>learner_fits<span class="op">$</span>Lrnr_glm_TRUE<span class="op">$</span><span class="kw">predict</span>(<span class="dt">task =</span> task)</span>
<span id="cb40-2"><a href="sl3.html#cb40-2"></a><span class="kw">head</span>(glm_preds)</span>
<span id="cb40-3"><a href="sl3.html#cb40-3"></a>[<span class="dv">1</span>] <span class="fl">-0.72617</span> <span class="fl">-0.93615</span> <span class="fl">-0.70850</span> <span class="fl">-0.64918</span> <span class="fl">-0.70132</span> <span class="fl">-0.84618</span></span></code></pre></div>
<p>Note that the predicted values for the SL correspond to so-called “full fits”
of the candidate learners, in which the candidates are fit to the entire
analytic dataset, i.e., all of the data supplied as <code>data</code> to <code>make_sl3_Task</code>.
Figure 2 in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span> provides a visual overview of the SL fitting
procedure.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="sl3.html#cb41-1"></a><span class="co"># we can also access the candidate learner full fits directly and obtain</span></span>
<span id="cb41-2"><a href="sl3.html#cb41-2"></a><span class="co"># the same "full fit" candidate predictions from there</span></span>
<span id="cb41-3"><a href="sl3.html#cb41-3"></a><span class="co"># (we split this into two lines to avoid overflow)</span></span>
<span id="cb41-4"><a href="sl3.html#cb41-4"></a>stack_full_fits &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>full_fit<span class="op">$</span>learner_fits<span class="op">$</span>Stack<span class="op">$</span>learner_fits</span>
<span id="cb41-5"><a href="sl3.html#cb41-5"></a>glm_preds_full_fit &lt;-<span class="st"> </span>stack_full_fits<span class="op">$</span>Lrnr_glm_TRUE<span class="op">$</span><span class="kw">predict</span>(task)</span>
<span id="cb41-6"><a href="sl3.html#cb41-6"></a></span>
<span id="cb41-7"><a href="sl3.html#cb41-7"></a><span class="co"># check that they are identical</span></span>
<span id="cb41-8"><a href="sl3.html#cb41-8"></a><span class="kw">identical</span>(glm_preds, glm_preds_full_fit)</span>
<span id="cb41-9"><a href="sl3.html#cb41-9"></a>[<span class="dv">1</span>] <span class="ot">TRUE</span></span></code></pre></div>
<p>Below we visualize the observed values for <code>whz</code> and predicted <code>whz</code> values for
SL, GLM and the mean.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># table of observed and predicted outcome values and arrange by observed values</span></span>
<span><span class="va">df_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span></span>
<span>  Obs <span class="op">=</span> <span class="va">washb_data</span><span class="op">[[</span><span class="st">"whz"</span><span class="op">]</span><span class="op">]</span>, SL_Pred <span class="op">=</span> <span class="va">sl_preds</span>, GLM_Pred <span class="op">=</span> <span class="va">glm_preds</span>,</span>
<span>  Mean_Pred <span class="op">=</span> <span class="va">sl_fit</span><span class="op">$</span><span class="va">learner_fits</span><span class="op">$</span><span class="va">Lrnr_mean</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df_plot</span> <span class="op">&lt;-</span> <span class="va">df_plot</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">df_plot</span><span class="op">$</span><span class="va">Obs</span><span class="op">)</span>, <span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">df_plot</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Obs
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
SL_Pred
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
GLM_Pred
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Mean_Pred
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
-4.67
</td>
<td style="text-align:right;">
-1.5371
</td>
<td style="text-align:right;">
-0.90956
</td>
<td style="text-align:right;">
-0.58608
</td>
</tr>
<tr>
<td style="text-align:right;">
-4.18
</td>
<td style="text-align:right;">
-1.2411
</td>
<td style="text-align:right;">
-0.63906
</td>
<td style="text-align:right;">
-0.58608
</td>
</tr>
<tr>
<td style="text-align:right;">
-4.17
</td>
<td style="text-align:right;">
-1.2141
</td>
<td style="text-align:right;">
-0.80981
</td>
<td style="text-align:right;">
-0.58608
</td>
</tr>
<tr>
<td style="text-align:right;">
-4.03
</td>
<td style="text-align:right;">
-1.5101
</td>
<td style="text-align:right;">
-0.89602
</td>
<td style="text-align:right;">
-0.58608
</td>
</tr>
<tr>
<td style="text-align:right;">
-3.95
</td>
<td style="text-align:right;">
-1.6594
</td>
<td style="text-align:right;">
-1.19523
</td>
<td style="text-align:right;">
-0.58608
</td>
</tr>
<tr>
<td style="text-align:right;">
-3.90
</td>
<td style="text-align:right;">
-1.3279
</td>
<td style="text-align:right;">
-0.98492
</td>
<td style="text-align:right;">
-0.58608
</td>
</tr>
</tbody>
</table></div>
</div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># melt the table so we can plot observed and predicted values</span></span>
<span><span class="va">df_plot</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">df_plot</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_plot_melted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span></span>
<span>  <span class="va">df_plot</span>,</span>
<span>  id.vars <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Obs"</span>, <span class="st">"SL_Pred"</span>, <span class="st">"GLM_Pred"</span>, <span class="st">"Mean_Pred"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df_plot_melted</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">value</span>, color <span class="op">=</span> <span class="va">variable</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Subjects (ordered by increasing whz)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"whz"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:predobs-plot"></span>
<img src="07-sl3_files/figure-html/predobs-plot-1.png" alt="Observed and predicted values for weight-for-height z-score (whz)" width="80%"><p class="caption">
FIGURE 3.1: Observed and predicted values for weight-for-height z-score (whz)
</p>
</div>
</div>
<div id="cross-validated-predictions" class="section level3">
<h3>
<span class="header-section-number">3.3.2</span> Cross-validated predictions<a class="anchor" aria-label="anchor" href="#cross-validated-predictions"><i class="fas fa-link"></i></a>
</h3>
<p>We can also obtain the cross-validated (CV) predictions for the candidate
learners. We can do this is a few different ways.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="sl3.html#cb45-1"></a><span class="co"># one way to obtain the CV predictions for the candidate learners</span></span>
<span id="cb45-2"><a href="sl3.html#cb45-2"></a>cv_preds_option1 &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_fit<span class="op">$</span><span class="kw">predict_fold</span>(</span>
<span id="cb45-3"><a href="sl3.html#cb45-3"></a>  <span class="dt">task =</span> task, <span class="dt">fold_number =</span> <span class="st">"validation"</span></span>
<span id="cb45-4"><a href="sl3.html#cb45-4"></a>)</span>
<span id="cb45-5"><a href="sl3.html#cb45-5"></a><span class="co"># another way to obtain the CV predictions for the candidate learners</span></span>
<span id="cb45-6"><a href="sl3.html#cb45-6"></a>cv_preds_option2 &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_fit<span class="op">$</span><span class="kw">predict</span>(<span class="dt">task =</span> task)</span>
<span id="cb45-7"><a href="sl3.html#cb45-7"></a></span>
<span id="cb45-8"><a href="sl3.html#cb45-8"></a><span class="co"># we can check that they are identical</span></span>
<span id="cb45-9"><a href="sl3.html#cb45-9"></a><span class="kw">identical</span>(cv_preds_option1, cv_preds_option2)</span>
<span id="cb45-10"><a href="sl3.html#cb45-10"></a>[<span class="dv">1</span>] <span class="ot">TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">cv_preds_option1</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_glm_TRUE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_mean
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_glmnet_NULL_deviance_10_0_100_TRUE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_glmnet_NULL_deviance_10_1_100_TRUE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_polspline
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_earth_2_3_backward_0_1_0_0
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_hal9001_2_1_c(3, 2)_5
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_ranger_500_TRUE_none_1
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_xgboost_20_1
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_gam_NULL_NULL_GCV.Cp
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_bayesglm_TRUE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
-0.74535
</td>
<td style="text-align:right;">
-0.59308
</td>
<td style="text-align:right;">
-0.69823
</td>
<td style="text-align:right;">
-0.69772
</td>
<td style="text-align:right;">
-0.72502
</td>
<td style="text-align:right;">
-0.71555
</td>
<td style="text-align:right;">
-0.69465
</td>
<td style="text-align:right;">
-0.72504
</td>
<td style="text-align:right;">
-0.78828
</td>
<td style="text-align:right;">
-0.72444
</td>
<td style="text-align:right;">
-0.74525
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.94468
</td>
<td style="text-align:right;">
-0.58647
</td>
<td style="text-align:right;">
-0.82777
</td>
<td style="text-align:right;">
-0.79474
</td>
<td style="text-align:right;">
-0.84489
</td>
<td style="text-align:right;">
-0.83517
</td>
<td style="text-align:right;">
-0.85505
</td>
<td style="text-align:right;">
-0.73837
</td>
<td style="text-align:right;">
-0.59828
</td>
<td style="text-align:right;">
-0.93238
</td>
<td style="text-align:right;">
-0.94452
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.64941
</td>
<td style="text-align:right;">
-0.59308
</td>
<td style="text-align:right;">
-0.69920
</td>
<td style="text-align:right;">
-0.72559
</td>
<td style="text-align:right;">
-0.71400
</td>
<td style="text-align:right;">
-0.60895
</td>
<td style="text-align:right;">
-0.70451
</td>
<td style="text-align:right;">
-0.51159
</td>
<td style="text-align:right;">
-0.64530
</td>
<td style="text-align:right;">
-0.61107
</td>
<td style="text-align:right;">
-0.64946
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.62111
</td>
<td style="text-align:right;">
-0.58460
</td>
<td style="text-align:right;">
-0.62242
</td>
<td style="text-align:right;">
-0.65938
</td>
<td style="text-align:right;">
-0.65248
</td>
<td style="text-align:right;">
-0.69157
</td>
<td style="text-align:right;">
-0.68570
</td>
<td style="text-align:right;">
-0.56976
</td>
<td style="text-align:right;">
-0.46965
</td>
<td style="text-align:right;">
-0.59100
</td>
<td style="text-align:right;">
-0.62137
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.76466
</td>
<td style="text-align:right;">
-0.58460
</td>
<td style="text-align:right;">
-0.66531
</td>
<td style="text-align:right;">
-0.70686
</td>
<td style="text-align:right;">
-0.70006
</td>
<td style="text-align:right;">
-0.69693
</td>
<td style="text-align:right;">
-0.67454
</td>
<td style="text-align:right;">
-0.68531
</td>
<td style="text-align:right;">
-0.65883
</td>
<td style="text-align:right;">
-0.79748
</td>
<td style="text-align:right;">
-0.76495
</td>
</tr>
<tr>
<td style="text-align:right;">
-0.88726
</td>
<td style="text-align:right;">
-0.57635
</td>
<td style="text-align:right;">
-0.80557
</td>
<td style="text-align:right;">
-0.72485
</td>
<td style="text-align:right;">
-0.71248
</td>
<td style="text-align:right;">
-0.47698
</td>
<td style="text-align:right;">
-0.67666
</td>
<td style="text-align:right;">
-0.79139
</td>
<td style="text-align:right;">
-0.69626
</td>
<td style="text-align:right;">
-0.91322
</td>
<td style="text-align:right;">
-0.88716
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="predict_fold" class="section level5 unnumbered">
<h5>
<code>predict_fold</code><a class="anchor" aria-label="anchor" href="#predict_fold"><i class="fas fa-link"></i></a>
</h5>
<p>Our first option to get CV predictions, <code>cv_preds_option1</code>, used the
<code>predict_fold</code> function to obtain validation set predictions across all folds.
This function only exists for learner fits that are cross-validated in <code>sl3</code>,
like those in <code>Lrnr_sl</code>. In addition to supplying <code>fold_number = "validation"</code>
in <code>predict_fold</code>, we can set <code>fold_number = "full"</code> to obtain predictions from
learners fit to the entire analytic dataset (i.e., all of the data supplied to
<code>make_sl3_Task</code>). For instance, below we show that <code>glm_preds</code> we calculated
above can also be obtained by setting <code>fold_number = "full"</code>.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="sl3.html#cb47-1"></a>full_fit_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_fit<span class="op">$</span><span class="kw">predict_fold</span>(</span>
<span id="cb47-2"><a href="sl3.html#cb47-2"></a>  <span class="dt">task =</span> task, <span class="dt">fold_number =</span> <span class="st">"full"</span></span>
<span id="cb47-3"><a href="sl3.html#cb47-3"></a>)</span>
<span id="cb47-4"><a href="sl3.html#cb47-4"></a>glm_full_fit_preds &lt;-<span class="st"> </span>full_fit_preds<span class="op">$</span>Lrnr_glm_TRUE</span>
<span id="cb47-5"><a href="sl3.html#cb47-5"></a></span>
<span id="cb47-6"><a href="sl3.html#cb47-6"></a><span class="co"># check that they are identical</span></span>
<span id="cb47-7"><a href="sl3.html#cb47-7"></a><span class="kw">identical</span>(glm_preds, glm_full_fit_preds)</span>
<span id="cb47-8"><a href="sl3.html#cb47-8"></a>[<span class="dv">1</span>] <span class="ot">TRUE</span></span></code></pre></div>
<p>We can also supply a specific an integer between 1 and the number of CV folds
to the <code>fold_number</code> argument in <code>predict_fold</code>, and an example of this
functionality is shown in the next part.</p>
</div>
<div id="cross-validated-predictions-by-hand" class="section level5 unnumbered">
<h5>Cross-validated predictions by hand<a class="anchor" aria-label="anchor" href="#cross-validated-predictions-by-hand"><i class="fas fa-link"></i></a>
</h5>
<p>We can get the CV predictions “by hand”, by tapping into each of the folds, and
then using the fitted candidate learners (which were trained to the training
set for each fold) to predict validation set outcomes (which were not seen in
training).</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="sl3.html#cb48-1"></a><span class="co">##### CV predictions "by hand" #####</span></span>
<span id="cb48-2"><a href="sl3.html#cb48-2"></a><span class="co"># for each fold, i, we obtain validation set predictions:</span></span>
<span id="cb48-3"><a href="sl3.html#cb48-3"></a>cv_preds_list &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(task<span class="op">$</span>folds), <span class="cf">function</span>(i) {</span>
<span id="cb48-4"><a href="sl3.html#cb48-4"></a></span>
<span id="cb48-5"><a href="sl3.html#cb48-5"></a>  <span class="co"># get validation dataset for fold i:</span></span>
<span id="cb48-6"><a href="sl3.html#cb48-6"></a>  v_data &lt;-<span class="st"> </span>task<span class="op">$</span>data[task<span class="op">$</span>folds[[i]]<span class="op">$</span>validation_set, ]</span>
<span id="cb48-7"><a href="sl3.html#cb48-7"></a></span>
<span id="cb48-8"><a href="sl3.html#cb48-8"></a>  <span class="co"># get observed outcomes in fold i's validation dataset:</span></span>
<span id="cb48-9"><a href="sl3.html#cb48-9"></a>  v_outcomes &lt;-<span class="st"> </span>v_data[[<span class="st">"whz"</span>]]</span>
<span id="cb48-10"><a href="sl3.html#cb48-10"></a></span>
<span id="cb48-11"><a href="sl3.html#cb48-11"></a>  <span class="co"># make task (for prediction) using fold i's validation dataset as data,</span></span>
<span id="cb48-12"><a href="sl3.html#cb48-12"></a>  <span class="co"># and keeping all else the same:</span></span>
<span id="cb48-13"><a href="sl3.html#cb48-13"></a>  v_task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(<span class="dt">covariates =</span> task<span class="op">$</span>nodes<span class="op">$</span>covariates, <span class="dt">data =</span> v_data)</span>
<span id="cb48-14"><a href="sl3.html#cb48-14"></a></span>
<span id="cb48-15"><a href="sl3.html#cb48-15"></a>  <span class="co"># get predicted outcomes for fold i's validation dataset, using candidates</span></span>
<span id="cb48-16"><a href="sl3.html#cb48-16"></a>  <span class="co"># trained to fold i's training dataset</span></span>
<span id="cb48-17"><a href="sl3.html#cb48-17"></a>  v_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_fit<span class="op">$</span><span class="kw">predict_fold</span>(</span>
<span id="cb48-18"><a href="sl3.html#cb48-18"></a>    <span class="dt">task =</span> v_task, <span class="dt">fold_number =</span> i</span>
<span id="cb48-19"><a href="sl3.html#cb48-19"></a>  )</span>
<span id="cb48-20"><a href="sl3.html#cb48-20"></a>  <span class="co"># note: v_preds is a matrix of candidate learner predictions, where the</span></span>
<span id="cb48-21"><a href="sl3.html#cb48-21"></a>  <span class="co"># number of rows is the number of observations in fold i's validation dataset</span></span>
<span id="cb48-22"><a href="sl3.html#cb48-22"></a>  <span class="co"># and the number of columns is the number of candidate learners (excluding</span></span>
<span id="cb48-23"><a href="sl3.html#cb48-23"></a>  <span class="co"># any that might have failed)</span></span>
<span id="cb48-24"><a href="sl3.html#cb48-24"></a></span>
<span id="cb48-25"><a href="sl3.html#cb48-25"></a>  <span class="co"># an identical way to get v_preds, which is used when we calculate the</span></span>
<span id="cb48-26"><a href="sl3.html#cb48-26"></a>  <span class="co"># cv risk by hand in a later part of this chapter:</span></span>
<span id="cb48-27"><a href="sl3.html#cb48-27"></a>  <span class="co"># v_preds &lt;- sl_fit$fit_object$cv_fit$fit_object$fold_fits[[i]]$predict(</span></span>
<span id="cb48-28"><a href="sl3.html#cb48-28"></a>  <span class="co">#   task = v_task</span></span>
<span id="cb48-29"><a href="sl3.html#cb48-29"></a>  <span class="co"># )</span></span>
<span id="cb48-30"><a href="sl3.html#cb48-30"></a></span>
<span id="cb48-31"><a href="sl3.html#cb48-31"></a>  <span class="co"># we will also return the row indices for fold i's validation set, so we</span></span>
<span id="cb48-32"><a href="sl3.html#cb48-32"></a>  <span class="co"># can later reorder the CV predictions and make sure they are equal to what</span></span>
<span id="cb48-33"><a href="sl3.html#cb48-33"></a>  <span class="co"># we obtained above</span></span>
<span id="cb48-34"><a href="sl3.html#cb48-34"></a>  <span class="kw">return</span>(<span class="kw">list</span>(<span class="st">"v_preds"</span> =<span class="st"> </span>v_preds, <span class="st">"v_index"</span> =<span class="st"> </span>task<span class="op">$</span>folds[[i]]<span class="op">$</span>validation_set))</span>
<span id="cb48-35"><a href="sl3.html#cb48-35"></a>})</span>
<span id="cb48-36"><a href="sl3.html#cb48-36"></a></span>
<span id="cb48-37"><a href="sl3.html#cb48-37"></a><span class="co"># extract the validation set predictions across all folds</span></span>
<span id="cb48-38"><a href="sl3.html#cb48-38"></a>cv_preds_byhand &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(cv_preds_list, <span class="st">"[["</span>, <span class="st">"v_preds"</span>))</span>
<span id="cb48-39"><a href="sl3.html#cb48-39"></a></span>
<span id="cb48-40"><a href="sl3.html#cb48-40"></a><span class="co"># extract the indices of validation set observations across all folds</span></span>
<span id="cb48-41"><a href="sl3.html#cb48-41"></a><span class="co"># then reorder cv_preds_byhand to correspond to the ordering in the data</span></span>
<span id="cb48-42"><a href="sl3.html#cb48-42"></a>row_index_in_data &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">lapply</span>(cv_preds_list, <span class="st">"[["</span>, <span class="st">"v_index"</span>))</span>
<span id="cb48-43"><a href="sl3.html#cb48-43"></a>cv_preds_byhand_ordered &lt;-<span class="st"> </span>cv_preds_byhand[<span class="kw">order</span>(row_index_in_data), ]</span>
<span id="cb48-44"><a href="sl3.html#cb48-44"></a><span class="co"># now we can check that they are identical</span></span>
<span id="cb48-45"><a href="sl3.html#cb48-45"></a><span class="kw">identical</span>(cv_preds_option1, cv_preds_byhand_ordered)</span>
<span id="cb48-46"><a href="sl3.html#cb48-46"></a>[<span class="dv">1</span>] <span class="ot">TRUE</span></span></code></pre></div>
</div>
</div>
<div id="predictions-with-new-data" class="section level3">
<h3>
<span class="header-section-number">3.3.3</span> Predictions with new data<a class="anchor" aria-label="anchor" href="#predictions-with-new-data"><i class="fas fa-link"></i></a>
</h3>
<p>If we wanted to obtain predicted values for new data then we would need to
create a new <code>sl3_Task</code> from the new data. Also, the covariates in this new
<code>sl3_Task</code> must be identical to the covariates in the <code>sl3_Task</code> for training.
As an example, let’s assume we have new covariate data <code>washb_data_new</code> for
which we want to use the fitted SL to obtain predicted weight-for-height
z-score values.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># we do not evaluate this code chunk, as `washb_data_new` does not exist</span></span>
<span><span class="va">prediction_task</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/sl3_Task.html">make_sl3_Task</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">washb_data_new</span>, <span class="co"># assuming we have some new data for predictions</span></span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"tr"</span>, <span class="st">"fracode"</span>, <span class="st">"month"</span>, <span class="st">"aged"</span>, <span class="st">"sex"</span>, <span class="st">"momage"</span>, <span class="st">"momedu"</span>,</span>
<span>    <span class="st">"momheight"</span>, <span class="st">"hfiacat"</span>, <span class="st">"Nlt18"</span>, <span class="st">"Ncomp"</span>, <span class="st">"watmin"</span>, <span class="st">"elec"</span>,</span>
<span>    <span class="st">"floor"</span>, <span class="st">"walls"</span>, <span class="st">"roof"</span>, <span class="st">"asset_wardrobe"</span>, <span class="st">"asset_table"</span>,</span>
<span>    <span class="st">"asset_chair"</span>, <span class="st">"asset_khat"</span>, <span class="st">"asset_chouki"</span>, <span class="st">"asset_tv"</span>,</span>
<span>    <span class="st">"asset_refrig"</span>, <span class="st">"asset_bike"</span>, <span class="st">"asset_moto"</span>, <span class="st">"asset_sewmach"</span>,</span>
<span>    <span class="st">"asset_mobile"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sl_preds_new_task</span> <span class="op">&lt;-</span> <span class="va">sl_fit</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span>task <span class="op">=</span> <span class="va">prediction_task</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="counterfactual-predictions" class="section level3">
<h3>
<span class="header-section-number">3.3.4</span> Counterfactual predictions<a class="anchor" aria-label="anchor" href="#counterfactual-predictions"><i class="fas fa-link"></i></a>
</h3>
<p>Counterfactual predictions are predicted values under an intervention of
interest. Recall from above that we can obtain predicted values for new data by
creating a <code>sl3_Task</code> with the new data whose covariates match the set
considered for training. As an example that draws on the WASH Benefits
Bangladesh study, suppose we would like to obtain predictions for every
subject’s weight-for-height z-score (<code>whz</code>) outcome under an intervention on
treatment (<code>tr</code>) that sets it to the nutrition, water, sanitation, and
handwashing regime.</p>
<p>First we need to create a copy of the dataset, and then we can intervene on
<code>tr</code> in the copied dataset, create a new <code>sl3_Task</code> using the copied data and
the same covariates as the training task, and finally obtain predictions
from the fitted SL (which we named <code>sl_fit</code> in the previous section).</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="sl3.html#cb50-1"></a><span class="co">### 1. Copy data</span></span>
<span id="cb50-2"><a href="sl3.html#cb50-2"></a>tr_intervention_data &lt;-<span class="st"> </span>data.table<span class="op">::</span><span class="kw">copy</span>(washb_data)</span>
<span id="cb50-3"><a href="sl3.html#cb50-3"></a></span>
<span id="cb50-4"><a href="sl3.html#cb50-4"></a><span class="co">### 2. Define intervention in copied dataset</span></span>
<span id="cb50-5"><a href="sl3.html#cb50-5"></a>tr_intervention &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">"Nutrition + WSH"</span>, <span class="kw">nrow</span>(washb_data))</span>
<span id="cb50-6"><a href="sl3.html#cb50-6"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: When we intervene on a categorical variable (such as "tr"), we need to</span></span>
<span id="cb50-7"><a href="sl3.html#cb50-7"></a><span class="co">#       define the intervention as a categorical variable (ie a factor).</span></span>
<span id="cb50-8"><a href="sl3.html#cb50-8"></a><span class="co">#       Also, even though not all levels of the factor will be represented in</span></span>
<span id="cb50-9"><a href="sl3.html#cb50-9"></a><span class="co">#       the intervention, we still need this factor to reflect all of the</span></span>
<span id="cb50-10"><a href="sl3.html#cb50-10"></a><span class="co">#       levels that are present in the observed data</span></span>
<span id="cb50-11"><a href="sl3.html#cb50-11"></a>tr_levels &lt;-<span class="st"> </span><span class="kw">levels</span>(washb_data[[<span class="st">"tr"</span>]])</span>
<span id="cb50-12"><a href="sl3.html#cb50-12"></a>tr_levels</span>
<span id="cb50-13"><a href="sl3.html#cb50-13"></a>[<span class="dv">1</span>] <span class="st">"Control"</span>         <span class="st">"Handwashing"</span>     <span class="st">"Nutrition"</span>       <span class="st">"Nutrition + WSH"</span></span>
<span id="cb50-14"><a href="sl3.html#cb50-14"></a>[<span class="dv">5</span>] <span class="st">"Sanitation"</span>      <span class="st">"WSH"</span>             <span class="st">"Water"</span>          </span>
<span id="cb50-15"><a href="sl3.html#cb50-15"></a>tr_intervention &lt;-<span class="st"> </span><span class="kw">factor</span>(tr_intervention, <span class="dt">levels =</span> tr_levels)</span>
<span id="cb50-16"><a href="sl3.html#cb50-16"></a>tr_intervention_data[, <span class="st">"tr"</span> <span class="op">:</span><span class="er">=</span><span class="st"> </span>tr_intervention, ]</span>
<span id="cb50-17"><a href="sl3.html#cb50-17"></a></span>
<span id="cb50-18"><a href="sl3.html#cb50-18"></a><span class="co">### 3. Create a new sl3_Task</span></span>
<span id="cb50-19"><a href="sl3.html#cb50-19"></a><span class="co"># note that we do not need to specify the outcome in this new task since we are</span></span>
<span id="cb50-20"><a href="sl3.html#cb50-20"></a><span class="co"># only using it to obtain predictions</span></span>
<span id="cb50-21"><a href="sl3.html#cb50-21"></a>tr_intervention_task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(</span>
<span id="cb50-22"><a href="sl3.html#cb50-22"></a>  <span class="dt">data =</span> tr_intervention_data,</span>
<span id="cb50-23"><a href="sl3.html#cb50-23"></a>  <span class="dt">covariates =</span> <span class="kw">c</span>(</span>
<span id="cb50-24"><a href="sl3.html#cb50-24"></a>    <span class="st">"tr"</span>, <span class="st">"fracode"</span>, <span class="st">"month"</span>, <span class="st">"aged"</span>, <span class="st">"sex"</span>, <span class="st">"momage"</span>, <span class="st">"momedu"</span>,</span>
<span id="cb50-25"><a href="sl3.html#cb50-25"></a>    <span class="st">"momheight"</span>, <span class="st">"hfiacat"</span>, <span class="st">"Nlt18"</span>, <span class="st">"Ncomp"</span>, <span class="st">"watmin"</span>, <span class="st">"elec"</span>,</span>
<span id="cb50-26"><a href="sl3.html#cb50-26"></a>    <span class="st">"floor"</span>, <span class="st">"walls"</span>, <span class="st">"roof"</span>, <span class="st">"asset_wardrobe"</span>, <span class="st">"asset_table"</span>,</span>
<span id="cb50-27"><a href="sl3.html#cb50-27"></a>    <span class="st">"asset_chair"</span>, <span class="st">"asset_khat"</span>, <span class="st">"asset_chouki"</span>, <span class="st">"asset_tv"</span>,</span>
<span id="cb50-28"><a href="sl3.html#cb50-28"></a>    <span class="st">"asset_refrig"</span>, <span class="st">"asset_bike"</span>, <span class="st">"asset_moto"</span>, <span class="st">"asset_sewmach"</span>,</span>
<span id="cb50-29"><a href="sl3.html#cb50-29"></a>    <span class="st">"asset_mobile"</span></span>
<span id="cb50-30"><a href="sl3.html#cb50-30"></a>  )</span>
<span id="cb50-31"><a href="sl3.html#cb50-31"></a>)</span>
<span id="cb50-32"><a href="sl3.html#cb50-32"></a><span class="co">### 4. Get predicted values under intervention of interest</span></span>
<span id="cb50-33"><a href="sl3.html#cb50-33"></a><span class="co"># SL predictions of what "whz" would have been had everyone received "tr"</span></span>
<span id="cb50-34"><a href="sl3.html#cb50-34"></a><span class="co"># equal to "Nutrition + WSH"</span></span>
<span id="cb50-35"><a href="sl3.html#cb50-35"></a>counterfactual_pred &lt;-<span class="st"> </span>sl_fit<span class="op">$</span><span class="kw">predict</span>(tr_intervention_task)</span></code></pre></div>
<p>Note that this type of intervention, where every subject receives the same
intervention, is referred to as “static”. Interventions that vary depending on
the characteristics of the subject are referred to as “dynamic”. For instance,
we might consider an intervention that sets the treatment to the desired
(nutrition, water, sanitation, and handwashing) regime if the subject has
a refridgerator, and a nutrition-omitted (water, sanitation, and handwashing)
regime otherwise.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dynamic_tr_intervention_data</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">washb_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dynamic_tr_intervention</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>  <span class="va">washb_data</span><span class="op">[[</span><span class="st">"asset_refrig"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"Nutrition + WSH"</span>, <span class="st">"WSH"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dynamic_tr_intervention</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">dynamic_tr_intervention</span>, levels <span class="op">=</span> <span class="va">tr_levels</span><span class="op">)</span></span>
<span><span class="va">dynamic_tr_intervention_data</span><span class="op">[</span>, <span class="st">"tr"</span> <span class="op">:=</span> <span class="va">dynamic_tr_intervention</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">dynamic_tr_intervention_task</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/sl3_Task.html">make_sl3_Task</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">dynamic_tr_intervention_data</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"tr"</span>, <span class="st">"fracode"</span>, <span class="st">"month"</span>, <span class="st">"aged"</span>, <span class="st">"sex"</span>, <span class="st">"momage"</span>, <span class="st">"momedu"</span>,</span>
<span>    <span class="st">"momheight"</span>, <span class="st">"hfiacat"</span>, <span class="st">"Nlt18"</span>, <span class="st">"Ncomp"</span>, <span class="st">"watmin"</span>, <span class="st">"elec"</span>,</span>
<span>    <span class="st">"floor"</span>, <span class="st">"walls"</span>, <span class="st">"roof"</span>, <span class="st">"asset_wardrobe"</span>, <span class="st">"asset_table"</span>,</span>
<span>    <span class="st">"asset_chair"</span>, <span class="st">"asset_khat"</span>, <span class="st">"asset_chouki"</span>, <span class="st">"asset_tv"</span>,</span>
<span>    <span class="st">"asset_refrig"</span>, <span class="st">"asset_bike"</span>, <span class="st">"asset_moto"</span>, <span class="st">"asset_sewmach"</span>,</span>
<span>    <span class="st">"asset_mobile"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">### 4. Get predicted values under intervention of interest</span></span>
<span><span class="co"># SL predictions of what "whz" would have been had every subject received "tr"</span></span>
<span><span class="co"># equal to "Nutrition + WSH" if they had a fridge and "WSH" if they didn't have</span></span>
<span><span class="co"># a fridge</span></span>
<span><span class="va">counterfactual_pred</span> <span class="op">&lt;-</span> <span class="va">sl_fit</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span><span class="va">dynamic_tr_intervention_task</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="summarizing-super-learner-fits" class="section level2">
<h2>
<span class="header-section-number">3.4</span> Summarizing Super Learner Fits<a class="anchor" aria-label="anchor" href="#summarizing-super-learner-fits"><i class="fas fa-link"></i></a>
</h2>
<div id="super-learner-coefficients-fitted-meta-learner-summary" class="section level3">
<h3>
<span class="header-section-number">3.4.1</span> Super Learner coefficients / fitted meta-learner summary<a class="anchor" aria-label="anchor" href="#super-learner-coefficients-fitted-meta-learner-summary"><i class="fas fa-link"></i></a>
</h3>
<p>We can see how the meta-learner created a function of the learners in a few
ways. In our illustrative example, we considered the default, NNLS meta-learner
for continuous outcomes. For meta-learners that simply learn a weighted
combination, we can examine their coefficients.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="sl3.html#cb52-1"></a><span class="kw">round</span>(sl_fit<span class="op">$</span>coefficients, <span class="dv">3</span>)</span>
<span id="cb52-2"><a href="sl3.html#cb52-2"></a>                          Lrnr_glm_TRUE                               Lrnr_mean </span>
<span id="cb52-3"><a href="sl3.html#cb52-3"></a>                                  <span class="fl">0.000</span>                                   <span class="fl">0.000</span> </span>
<span id="cb52-4"><a href="sl3.html#cb52-4"></a>Lrnr_glmnet_NULL_deviance_<span class="dv">10</span>_<span class="dv">0</span>_<span class="dv">100</span>_TRUE Lrnr_glmnet_NULL_deviance_<span class="dv">10</span>_<span class="dv">1</span>_<span class="dv">100</span>_TRUE </span>
<span id="cb52-5"><a href="sl3.html#cb52-5"></a>                                  <span class="fl">0.076</span>                                   <span class="fl">0.000</span> </span>
<span id="cb52-6"><a href="sl3.html#cb52-6"></a>                         Lrnr_polspline         Lrnr_earth_<span class="dv">2</span>_<span class="dv">3</span>_backward_<span class="dv">0</span>_<span class="dv">1</span>_<span class="dv">0</span>_<span class="dv">0</span> </span>
<span id="cb52-7"><a href="sl3.html#cb52-7"></a>                                  <span class="fl">0.164</span>                                   <span class="fl">0.389</span> </span>
<span id="cb52-8"><a href="sl3.html#cb52-8"></a>             <span class="kw">Lrnr_hal9001_2_1_c</span>(<span class="dv">3</span>, <span class="dv">2</span>)_<span class="dv">5</span>             Lrnr_ranger_<span class="dv">500</span>_TRUE_none_<span class="dv">1</span> </span>
<span id="cb52-9"><a href="sl3.html#cb52-9"></a>                                  <span class="fl">0.000</span>                                   <span class="fl">0.372</span> </span>
<span id="cb52-10"><a href="sl3.html#cb52-10"></a>                      Lrnr_xgboost_<span class="dv">20</span>_<span class="dv">1</span>               Lrnr_gam_NULL_NULL_GCV.Cp </span>
<span id="cb52-11"><a href="sl3.html#cb52-11"></a>                                  <span class="fl">0.000</span>                                   <span class="fl">0.000</span> </span>
<span id="cb52-12"><a href="sl3.html#cb52-12"></a>                     Lrnr_bayesglm_TRUE </span>
<span id="cb52-13"><a href="sl3.html#cb52-13"></a>                                  <span class="fl">0.000</span> </span></code></pre></div>
<p>We can also examine the coefficients by directly accessing the meta-learner’s
fit object.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="sl3.html#cb53-1"></a>metalrnr_fit &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_meta_fit<span class="op">$</span>fit_object</span>
<span id="cb53-2"><a href="sl3.html#cb53-2"></a><span class="kw">round</span>(metalrnr_fit<span class="op">$</span>coefficients, <span class="dv">3</span>)</span>
<span id="cb53-3"><a href="sl3.html#cb53-3"></a>                          Lrnr_glm_TRUE                               Lrnr_mean </span>
<span id="cb53-4"><a href="sl3.html#cb53-4"></a>                                  <span class="fl">0.000</span>                                   <span class="fl">0.000</span> </span>
<span id="cb53-5"><a href="sl3.html#cb53-5"></a>Lrnr_glmnet_NULL_deviance_<span class="dv">10</span>_<span class="dv">0</span>_<span class="dv">100</span>_TRUE Lrnr_glmnet_NULL_deviance_<span class="dv">10</span>_<span class="dv">1</span>_<span class="dv">100</span>_TRUE </span>
<span id="cb53-6"><a href="sl3.html#cb53-6"></a>                                  <span class="fl">0.076</span>                                   <span class="fl">0.000</span> </span>
<span id="cb53-7"><a href="sl3.html#cb53-7"></a>                         Lrnr_polspline         Lrnr_earth_<span class="dv">2</span>_<span class="dv">3</span>_backward_<span class="dv">0</span>_<span class="dv">1</span>_<span class="dv">0</span>_<span class="dv">0</span> </span>
<span id="cb53-8"><a href="sl3.html#cb53-8"></a>                                  <span class="fl">0.164</span>                                   <span class="fl">0.389</span> </span>
<span id="cb53-9"><a href="sl3.html#cb53-9"></a>             <span class="kw">Lrnr_hal9001_2_1_c</span>(<span class="dv">3</span>, <span class="dv">2</span>)_<span class="dv">5</span>             Lrnr_ranger_<span class="dv">500</span>_TRUE_none_<span class="dv">1</span> </span>
<span id="cb53-10"><a href="sl3.html#cb53-10"></a>                                  <span class="fl">0.000</span>                                   <span class="fl">0.372</span> </span>
<span id="cb53-11"><a href="sl3.html#cb53-11"></a>                      Lrnr_xgboost_<span class="dv">20</span>_<span class="dv">1</span>               Lrnr_gam_NULL_NULL_GCV.Cp </span>
<span id="cb53-12"><a href="sl3.html#cb53-12"></a>                                  <span class="fl">0.000</span>                                   <span class="fl">0.000</span> </span>
<span id="cb53-13"><a href="sl3.html#cb53-13"></a>                     Lrnr_bayesglm_TRUE </span>
<span id="cb53-14"><a href="sl3.html#cb53-14"></a>                                  <span class="fl">0.000</span> </span></code></pre></div>
<p>Direct access to the meta-learner fit object is also handy for more
complex meta-learners (e.g., non-parametric meta-learners) that are not defined
by a simple set of main terms regression coefficients.</p>
</div>
<div id="cross-validated-predictive-performance" class="section level3">
<h3>
<span class="header-section-number">3.4.2</span> Cross-validated predictive performance<a class="anchor" aria-label="anchor" href="#cross-validated-predictive-performance"><i class="fas fa-link"></i></a>
</h3>
<p>We can obtain a table of the cross-validated (CV) predictive performance, i.e.,
the CV risk, for each learner included in the SL. Below, we use the
squared error loss for the evaluation function, which equates to the mean
squared error (MSE) as the metric to summarize predictive performance. The
reason why we use the MSE is because it is a valid metric for estimating the
conditional mean, which is what we’re learning the prediction function for in
the WASH Benefits example. For more information on selecting an appropriate
performance metric, see <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_risk_table</span> <span class="op">&lt;-</span> <span class="va">sl_fit</span><span class="op">$</span><span class="fu">cv_risk</span><span class="op">(</span>eval_fun <span class="op">=</span> <span class="va">loss_squared_error</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_risk_table</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
learner
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
coefficients
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
MSE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Lrnr_glm_TRUE
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0224
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_mean
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0654
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_0_100_TRUE
</td>
<td style="text-align:right;">
0.07582
</td>
<td style="text-align:right;">
1.0166
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_1_100_TRUE
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0144
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_polspline
</td>
<td style="text-align:right;">
0.16359
</td>
<td style="text-align:right;">
1.0163
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_earth_2_3_backward_0_1_0_0
</td>
<td style="text-align:right;">
0.38900
</td>
<td style="text-align:right;">
1.0131
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_hal9001_2_1_c(3, 2)_5
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0176
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_ranger_500_TRUE_none_1
</td>
<td style="text-align:right;">
0.37159
</td>
<td style="text-align:right;">
1.0128
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_xgboost_20_1
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0793
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_gam_NULL_NULL_GCV.Cp
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0235
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_bayesglm_TRUE
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0224
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="cross-validated-predictive-performance-by-hand" class="section level5 unnumbered">
<h5>Cross-validated predictive performance by hand<a class="anchor" aria-label="anchor" href="#cross-validated-predictive-performance-by-hand"><i class="fas fa-link"></i></a>
</h5>
<p>Similar to how we got the CV predictions “by hand”, we can also calculate the CV
performance/risk in a way that exposes the procedure. Specifically, this is done
by tapping into each of the folds, and then using the fitted candidate learners
(which were trained to the training set for each fold) to predict validation set
outcomes (which were not seen in training) and then measure the predictive
performance (i.e., risk). Each candidate learner’s fold-specific risk is then
averaged across all folds to obtain the CV risk. The function <code>cv_risk</code> does
all of this internally and we show how to do it by hand below, which can be
helpful for understanding the CV risk and how it is calculated.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="sl3.html#cb56-1"></a><span class="co">##### CV risk "by hand" #####</span></span>
<span id="cb56-2"><a href="sl3.html#cb56-2"></a><span class="co"># for each fold, i, we obtain predictive performance/risk for each candidate:</span></span>
<span id="cb56-3"><a href="sl3.html#cb56-3"></a>cv_risks_list &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(task<span class="op">$</span>folds), <span class="cf">function</span>(i) {</span>
<span id="cb56-4"><a href="sl3.html#cb56-4"></a></span>
<span id="cb56-5"><a href="sl3.html#cb56-5"></a>  <span class="co"># get validation dataset for fold i:</span></span>
<span id="cb56-6"><a href="sl3.html#cb56-6"></a>  v_data &lt;-<span class="st"> </span>task<span class="op">$</span>data[task<span class="op">$</span>folds[[i]]<span class="op">$</span>validation_set, ]</span>
<span id="cb56-7"><a href="sl3.html#cb56-7"></a></span>
<span id="cb56-8"><a href="sl3.html#cb56-8"></a>  <span class="co"># get observed outcomes in fold i's validation dataset:</span></span>
<span id="cb56-9"><a href="sl3.html#cb56-9"></a>  v_outcomes &lt;-<span class="st"> </span>v_data[[<span class="st">"whz"</span>]]</span>
<span id="cb56-10"><a href="sl3.html#cb56-10"></a></span>
<span id="cb56-11"><a href="sl3.html#cb56-11"></a>  <span class="co"># make task (for prediction) using fold i's validation dataset as data,</span></span>
<span id="cb56-12"><a href="sl3.html#cb56-12"></a>  <span class="co"># and keeping all else the same:</span></span>
<span id="cb56-13"><a href="sl3.html#cb56-13"></a>  v_task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(<span class="dt">covariates =</span> task<span class="op">$</span>nodes<span class="op">$</span>covariates, <span class="dt">data =</span> v_data)</span>
<span id="cb56-14"><a href="sl3.html#cb56-14"></a></span>
<span id="cb56-15"><a href="sl3.html#cb56-15"></a>  <span class="co"># get predicted outcomes for fold i's validation dataset, using candidates</span></span>
<span id="cb56-16"><a href="sl3.html#cb56-16"></a>  <span class="co"># trained to fold i's training dataset</span></span>
<span id="cb56-17"><a href="sl3.html#cb56-17"></a>  v_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_fit<span class="op">$</span>fit_object<span class="op">$</span>fold_fits[[i]]<span class="op">$</span><span class="kw">predict</span>(v_task)</span>
<span id="cb56-18"><a href="sl3.html#cb56-18"></a>  <span class="co"># note: v_preds is a matrix of candidate learner predictions, where the</span></span>
<span id="cb56-19"><a href="sl3.html#cb56-19"></a>  <span class="co"># number of rows is the number of observations in fold i's validation dataset</span></span>
<span id="cb56-20"><a href="sl3.html#cb56-20"></a>  <span class="co"># and the number of columns is the number of candidate learners (excluding</span></span>
<span id="cb56-21"><a href="sl3.html#cb56-21"></a>  <span class="co"># any that might have failed)</span></span>
<span id="cb56-22"><a href="sl3.html#cb56-22"></a></span>
<span id="cb56-23"><a href="sl3.html#cb56-23"></a>  <span class="co"># calculate predictive performance for fold i for each candidate</span></span>
<span id="cb56-24"><a href="sl3.html#cb56-24"></a>  eval_function &lt;-<span class="st"> </span>loss_squared_error <span class="co"># valid for estimation of conditional mean</span></span>
<span id="cb56-25"><a href="sl3.html#cb56-25"></a>  v_losses &lt;-<span class="st"> </span><span class="kw">apply</span>(v_preds, <span class="dv">2</span>, eval_function, v_outcomes)</span>
<span id="cb56-26"><a href="sl3.html#cb56-26"></a>  cv_risks &lt;-<span class="st"> </span><span class="kw">colMeans</span>(v_losses)</span>
<span id="cb56-27"><a href="sl3.html#cb56-27"></a>  <span class="kw">return</span>(cv_risks)</span>
<span id="cb56-28"><a href="sl3.html#cb56-28"></a>})</span>
<span id="cb56-29"><a href="sl3.html#cb56-29"></a><span class="co"># average the predictive performance across all folds for each candidate</span></span>
<span id="cb56-30"><a href="sl3.html#cb56-30"></a>cv_risks_byhand &lt;-<span class="st"> </span><span class="kw">colMeans</span>(<span class="kw">do.call</span>(rbind, cv_risks_list))</span>
<span id="cb56-31"><a href="sl3.html#cb56-31"></a>cv_risk_table_byhand &lt;-<span class="st"> </span><span class="kw">data.table</span>(</span>
<span id="cb56-32"><a href="sl3.html#cb56-32"></a>  <span class="dt">learner =</span> <span class="kw">names</span>(cv_risks_byhand), <span class="dt">MSE =</span> cv_risks_byhand</span>
<span id="cb56-33"><a href="sl3.html#cb56-33"></a>)</span>
<span id="cb56-34"><a href="sl3.html#cb56-34"></a><span class="co"># check that the CV risks are identical when calculated by hand and function</span></span>
<span id="cb56-35"><a href="sl3.html#cb56-35"></a><span class="co"># (ignoring small differences by rounding to the fourth decimal place)</span></span>
<span id="cb56-36"><a href="sl3.html#cb56-36"></a><span class="kw">identical</span>(</span>
<span id="cb56-37"><a href="sl3.html#cb56-37"></a>  <span class="kw">round</span>(cv_risk_table_byhand<span class="op">$</span>MSE, <span class="dv">4</span>), <span class="kw">round</span>(<span class="kw">as.numeric</span>(cv_risk_table<span class="op">$</span>MSE), <span class="dv">4</span>)</span>
<span id="cb56-38"><a href="sl3.html#cb56-38"></a>)</span>
<span id="cb56-39"><a href="sl3.html#cb56-39"></a>[<span class="dv">1</span>] <span class="ot">TRUE</span></span></code></pre></div>
<!--
We can plot the CV risks as well. 

```r

# Column "se" in the CV risk table is the standard error across all losses for
# a learner, i.e., se = sd(loss)/sqrt(n), where loss is an n length vector of
# validation set predictions across all folds, and n is the number of
# validation set observations across all folds. We can use this to
cv_risk_table[, "lower" := MSE - qnorm(.975) * se]
cv_risk_table[, "upper" := MSE + qnorm(.975) * se]

ggplot(
  cv_risk_table,
  aes_string(x = "learner", y = "MSE", ymin = "lower", ymax = "upper")
) +
  geom_pointrange() +
  coord_flip() +
  ylab("V-fold CV Risk Estimate") +
  xlab("Learner")
```
-->
<!--
Column "se" in the CV risk table is the standard error across all losses for a learner, i.e., se = sd(loss)/sqrt(n), where loss is an n length vector of validation set predictions across all folds, and n is the number of validation set observations across all folds.
Column "fold_sd" in the CV risk table is the standard deviation of the V-fold-specific risks, i.e., fold_sd = sd(risk), where risk is a V length vector of the mean loss across the folds.
-->
</div>
</div>
<div id="cross-validated-super-learner" class="section level3">
<h3>
<span class="header-section-number">3.4.3</span> Cross-validated Super Learner<a class="anchor" aria-label="anchor" href="#cross-validated-super-learner"><i class="fas fa-link"></i></a>
</h3>
<p>We can see from the CV risk table above that the SL is not listed. This is
because we do not have a CV risk for the SL unless we cross-validate it or
include it as a candidate in another SL; the latter is shown in <a href="https://tlverse.org/tlverse-handbook/sl3.html#discrete-super-learner">the next
subsection</a>.
Below, we show how to obtain a CV risk estimate for the SL using function
<code>cv_sl</code>. Like before when we called <code>sl$train</code>, we will set a random number
generator so the results are reproducible, and we will also time this.</p>
<!--
(Note: we did not evaluate this part of the code, as it was 
taking too long).
-->
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">569</span><span class="op">)</span></span>
<span><span class="va">cv_sl_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/cv_sl.html">cv_sl</a></span><span class="op">(</span>lrnr_sl <span class="op">=</span> <span class="va">sl_fit</span>, task <span class="op">=</span> <span class="va">task</span>, eval_fun <span class="op">=</span> <span class="va">loss_squared_error</span><span class="op">)</span></span>
<span></span>
<span><span class="va">runtime_cv_sl_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="va">runtime_cv_sl_fit</span></span></code></pre></div>
<pre><code>   user  system elapsed 
2792.55  159.65 3051.41 </code></pre>
<p>It took 3051.4 seconds (50.9 minutes) to fit the CV SL.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_sl_fit</span><span class="op">$</span><span class="va">cv_risk</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
learner
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
MSE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
se
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Lrnr_glm_TRUE
</td>
<td style="text-align:right;">
1.0224
</td>
<td style="text-align:right;">
0.02398
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_mean
</td>
<td style="text-align:right;">
1.0654
</td>
<td style="text-align:right;">
0.02503
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_0_100_TRUE
</td>
<td style="text-align:right;">
1.0166
</td>
<td style="text-align:right;">
0.02374
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_1_100_TRUE
</td>
<td style="text-align:right;">
1.0142
</td>
<td style="text-align:right;">
0.02362
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_polspline
</td>
<td style="text-align:right;">
1.0163
</td>
<td style="text-align:right;">
0.02365
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_earth_2_3_backward_0_1_0_0
</td>
<td style="text-align:right;">
1.0131
</td>
<td style="text-align:right;">
0.02352
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_hal9001_2_1_c(3, 2)_5
</td>
<td style="text-align:right;">
1.0175
</td>
<td style="text-align:right;">
0.02369
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_ranger_500_TRUE_none_1
</td>
<td style="text-align:right;">
1.0142
</td>
<td style="text-align:right;">
0.02356
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_xgboost_20_1
</td>
<td style="text-align:right;">
1.0793
</td>
<td style="text-align:right;">
0.02479
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_gam_NULL_NULL_GCV.Cp
</td>
<td style="text-align:right;">
1.0235
</td>
<td style="text-align:right;">
0.02394
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_bayesglm_TRUE
</td>
<td style="text-align:right;">
1.0224
</td>
<td style="text-align:right;">
0.02398
</td>
</tr>
<tr>
<td style="text-align:left;">
SuperLearner
</td>
<td style="text-align:right;">
1.0068
</td>
<td style="text-align:right;">
0.02343
</td>
</tr>
</tbody>
</table></div>
</div>
<p>The CV risk of the SL is
0.0234, which is lower
than all of the candidates’ CV risks.</p>
<p>We can see how the SL fits varied across the folds by the coefficients for the
SL on each fold.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">cv_sl_fit</span><span class="op">$</span><span class="va">coef</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fold
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_glm_TRUE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_mean
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_glmnet_NULL_deviance_10_0_100_TRUE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_glmnet_NULL_deviance_10_1_100_TRUE
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_polspline
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_earth_2_3_backward_0_1_0_0
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_hal9001_2_1_c(3, 2)_5
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_ranger_500_TRUE_none_1
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_xgboost_20_1
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_gam_NULL_NULL_GCV.Cp
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Lrnr_bayesglm_TRUE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.047
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.243
</td>
<td style="text-align:right;">
0.253
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.456
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.257
</td>
<td style="text-align:right;">
0.161
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.071
</td>
<td style="text-align:right;">
0.473
</td>
<td style="text-align:right;">
0.038
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.030
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.079
</td>
<td style="text-align:right;">
0.175
</td>
<td style="text-align:right;">
0.147
</td>
<td style="text-align:right;">
0.415
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.154
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0.050
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.459
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.111
</td>
<td style="text-align:right;">
0.020
</td>
<td style="text-align:right;">
0.360
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.075
</td>
<td style="text-align:right;">
0.275
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.315
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.318
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.017
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
0.025
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.248
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.110
</td>
<td style="text-align:right;">
0.351
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.267
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.236
</td>
<td style="text-align:right;">
0.114
</td>
<td style="text-align:right;">
0.084
</td>
<td style="text-align:right;">
0.139
</td>
<td style="text-align:right;">
0.406
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.020
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
0.189
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.007
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.196
</td>
<td style="text-align:right;">
0.029
</td>
<td style="text-align:right;">
0.207
</td>
<td style="text-align:right;">
0.372
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
0.113
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.103
</td>
<td style="text-align:right;">
0.106
</td>
<td style="text-align:right;">
0.129
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.548
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.185
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.154
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.661
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="revere-cross-validated-predictive-performance-of-super-learner" class="section level3">
<h3>
<span class="header-section-number">3.4.4</span> Revere-cross-validated predictive performance of Super Learner<a class="anchor" aria-label="anchor" href="#revere-cross-validated-predictive-performance-of-super-learner"><i class="fas fa-link"></i></a>
</h3>
<p>We can also use so-called “revere”, to obtain a partial CV risk for the SL,
where the SL candidate learner fits are cross-validated but the meta-learner fit
is not. It takes essentially no extra time to calculate a revere-CV
performance/risk estimate of the SL, since we already have the CV fits of the
candidates. This isn’t to say that revere-CV SL performance can replace that
obtained from actual CV SL. Revere can be used to very quickly examine an
approximate lower bound on the SL’s CV risk <em>when the meta-learner is a simple model</em>,
like NNLS. We can output the revere-based CV risk estimate by setting
<code>get_sl_revere_risk = TRUE</code> in <code>cv_risk</code>.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_risk_w_sl_revere</span> <span class="op">&lt;-</span> <span class="va">sl_fit</span><span class="op">$</span><span class="fu">cv_risk</span><span class="op">(</span></span>
<span>  eval_fun <span class="op">=</span> <span class="va">loss_squared_error</span>, get_sl_revere_risk <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_risk_w_sl_revere</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
learner
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
coefficients
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
MSE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Lrnr_glm_TRUE
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0224
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_mean
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0654
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_0_100_TRUE
</td>
<td style="text-align:right;">
0.07582
</td>
<td style="text-align:right;">
1.0166
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_1_100_TRUE
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0144
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_polspline
</td>
<td style="text-align:right;">
0.16359
</td>
<td style="text-align:right;">
1.0163
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_earth_2_3_backward_0_1_0_0
</td>
<td style="text-align:right;">
0.38900
</td>
<td style="text-align:right;">
1.0131
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_hal9001_2_1_c(3, 2)_5
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0176
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_ranger_500_TRUE_none_1
</td>
<td style="text-align:right;">
0.37159
</td>
<td style="text-align:right;">
1.0128
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_xgboost_20_1
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0793
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_gam_NULL_NULL_GCV.Cp
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0235
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_bayesglm_TRUE
</td>
<td style="text-align:right;">
0.00000
</td>
<td style="text-align:right;">
1.0224
</td>
</tr>
<tr>
<td style="text-align:left;">
SuperLearner
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1.0028
</td>
</tr>
</tbody>
</table></div>
</div>
<div id="revere-cross-validated-predictive-performance-of-super-learner-by-hand" class="section level5 unnumbered">
<h5>Revere-cross-validated predictive performance of Super Learner by hand<a class="anchor" aria-label="anchor" href="#revere-cross-validated-predictive-performance-of-super-learner-by-hand"><i class="fas fa-link"></i></a>
</h5>
<p>We show how to calculate the revere-CV predictive performance/risk of
the SL by hand below, as this might be helpful for understanding revere and
how it can be used to obtain a partial CV performance/risk estimate for the
SL.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="sl3.html#cb63-1"></a><span class="co">##### revere-based risk "by hand" #####</span></span>
<span id="cb63-2"><a href="sl3.html#cb63-2"></a><span class="co"># for each fold, i, we obtain predictive performance/risk for the SL</span></span>
<span id="cb63-3"><a href="sl3.html#cb63-3"></a>sl_revere_risk_list &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(task<span class="op">$</span>folds), <span class="cf">function</span>(i) {</span>
<span id="cb63-4"><a href="sl3.html#cb63-4"></a>  <span class="co"># get validation dataset for fold i:</span></span>
<span id="cb63-5"><a href="sl3.html#cb63-5"></a>  v_data &lt;-<span class="st"> </span>task<span class="op">$</span>data[task<span class="op">$</span>folds[[i]]<span class="op">$</span>validation_set, ]</span>
<span id="cb63-6"><a href="sl3.html#cb63-6"></a></span>
<span id="cb63-7"><a href="sl3.html#cb63-7"></a>  <span class="co"># get observed outcomes in fold i's validation dataset:</span></span>
<span id="cb63-8"><a href="sl3.html#cb63-8"></a>  v_outcomes &lt;-<span class="st"> </span>v_data[[<span class="st">"whz"</span>]]</span>
<span id="cb63-9"><a href="sl3.html#cb63-9"></a></span>
<span id="cb63-10"><a href="sl3.html#cb63-10"></a>  <span class="co"># make task (for prediction) using fold i's validation dataset as data,</span></span>
<span id="cb63-11"><a href="sl3.html#cb63-11"></a>  <span class="co"># and keeping all else the same:</span></span>
<span id="cb63-12"><a href="sl3.html#cb63-12"></a>  v_task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(</span>
<span id="cb63-13"><a href="sl3.html#cb63-13"></a>    <span class="dt">covariates =</span> task<span class="op">$</span>nodes<span class="op">$</span>covariates, <span class="dt">data =</span> v_data</span>
<span id="cb63-14"><a href="sl3.html#cb63-14"></a>  )</span>
<span id="cb63-15"><a href="sl3.html#cb63-15"></a></span>
<span id="cb63-16"><a href="sl3.html#cb63-16"></a>  <span class="co"># get predicted outcomes for fold i's validation dataset, using candidates</span></span>
<span id="cb63-17"><a href="sl3.html#cb63-17"></a>  <span class="co"># trained to fold i's training dataset</span></span>
<span id="cb63-18"><a href="sl3.html#cb63-18"></a>  v_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_fit<span class="op">$</span>fit_object<span class="op">$</span>fold_fits[[i]]<span class="op">$</span><span class="kw">predict</span>(v_task)</span>
<span id="cb63-19"><a href="sl3.html#cb63-19"></a></span>
<span id="cb63-20"><a href="sl3.html#cb63-20"></a>  <span class="co"># make a metalevel task (for prediction with sl):</span></span>
<span id="cb63-21"><a href="sl3.html#cb63-21"></a>  v_meta_task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(</span>
<span id="cb63-22"><a href="sl3.html#cb63-22"></a>    <span class="dt">covariates =</span> sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_meta_task<span class="op">$</span>nodes<span class="op">$</span>covariates,</span>
<span id="cb63-23"><a href="sl3.html#cb63-23"></a>    <span class="dt">data =</span> v_preds</span>
<span id="cb63-24"><a href="sl3.html#cb63-24"></a>  )</span>
<span id="cb63-25"><a href="sl3.html#cb63-25"></a></span>
<span id="cb63-26"><a href="sl3.html#cb63-26"></a>  <span class="co"># get predicted outcomes for fold i's metalevel dataset, using the fitted</span></span>
<span id="cb63-27"><a href="sl3.html#cb63-27"></a>  <span class="co"># metalearner, cv_meta_fit</span></span>
<span id="cb63-28"><a href="sl3.html#cb63-28"></a>  sl_revere_v_preds &lt;-<span class="st"> </span>sl_fit<span class="op">$</span>fit_object<span class="op">$</span>cv_meta_fit<span class="op">$</span><span class="kw">predict</span>(<span class="dt">task =</span> v_meta_task)</span>
<span id="cb63-29"><a href="sl3.html#cb63-29"></a>  <span class="co"># note: cv_meta_fit was trained on the metalevel dataset, which contains the</span></span>
<span id="cb63-30"><a href="sl3.html#cb63-30"></a>  <span class="co"># candidates' cv predictions and validation dataset outcomes across ALL folds,</span></span>
<span id="cb63-31"><a href="sl3.html#cb63-31"></a>  <span class="co"># so cv_meta_fit has already seen fold i's validation dataset outcomes.</span></span>
<span id="cb63-32"><a href="sl3.html#cb63-32"></a></span>
<span id="cb63-33"><a href="sl3.html#cb63-33"></a>  <span class="co"># calculate predictive performance for fold i for the SL</span></span>
<span id="cb63-34"><a href="sl3.html#cb63-34"></a>  eval_function &lt;-<span class="st"> </span>loss_squared_error <span class="co"># valid for estimation of conditional mean</span></span>
<span id="cb63-35"><a href="sl3.html#cb63-35"></a>  <span class="co"># note: by evaluating the predictive performance of the SL using outcomes</span></span>
<span id="cb63-36"><a href="sl3.html#cb63-36"></a>  <span class="co"># that were already seen by the metalearner, this is not a cross-validated</span></span>
<span id="cb63-37"><a href="sl3.html#cb63-37"></a>  <span class="co"># measure of predictive performance for the SL.</span></span>
<span id="cb63-38"><a href="sl3.html#cb63-38"></a>  sl_revere_v_loss &lt;-<span class="st"> </span><span class="kw">eval_function</span>(</span>
<span id="cb63-39"><a href="sl3.html#cb63-39"></a>    <span class="dt">pred =</span> sl_revere_v_preds, <span class="dt">observed =</span> v_outcomes</span>
<span id="cb63-40"><a href="sl3.html#cb63-40"></a>  )</span>
<span id="cb63-41"><a href="sl3.html#cb63-41"></a>  sl_revere_v_risk &lt;-<span class="st"> </span><span class="kw">mean</span>(sl_revere_v_loss)</span>
<span id="cb63-42"><a href="sl3.html#cb63-42"></a>  <span class="kw">return</span>(sl_revere_v_risk)</span>
<span id="cb63-43"><a href="sl3.html#cb63-43"></a>})</span>
<span id="cb63-44"><a href="sl3.html#cb63-44"></a><span class="co"># average the predictive performance across all folds for the SL</span></span>
<span id="cb63-45"><a href="sl3.html#cb63-45"></a>sl_revere_risk_byhand &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(sl_revere_risk_list))</span>
<span id="cb63-46"><a href="sl3.html#cb63-46"></a>sl_revere_risk_byhand</span>
<span id="cb63-47"><a href="sl3.html#cb63-47"></a>[<span class="dv">1</span>] <span class="fl">1.0028</span></span>
<span id="cb63-48"><a href="sl3.html#cb63-48"></a></span>
<span id="cb63-49"><a href="sl3.html#cb63-49"></a><span class="co"># check that our calculation by hand equals what is output in cv_risk_table_revere</span></span>
<span id="cb63-50"><a href="sl3.html#cb63-50"></a>sl_revere_risk &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(cv_risk_w_sl_revere[learner <span class="op">==</span><span class="st"> "SuperLearner"</span>, <span class="st">"MSE"</span>])</span>
<span id="cb63-51"><a href="sl3.html#cb63-51"></a>sl_revere_risk</span>
<span id="cb63-52"><a href="sl3.html#cb63-52"></a>[<span class="dv">1</span>] <span class="fl">1.0028</span></span></code></pre></div>
<p>The reason why this is not a fully cross-validated risk estimate is because the
<code>cv_meta_fit</code> object above (which is the trained meta-learner), was previously
fit to the <em>entire</em> matrix of CV predictions from <em>every</em> fold (i.e., the
meta-level dataset; see Figure 2 in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span> for more detail). This is why
revere-based risks are not a true CV risk. If the meta-learner is not a simple
regression function, and instead a more flexible learner (e.g., random
forest) is used as the meta-learner, then the revere-CV risk estimate of the
resulting SL will be a worse approximation of the CV risk estimate. This is
because more flexible learners are more likely to overfit. When simple
parametric regressions are used as a meta-learner, like what we considered in
our SL (NNLS with <code>Lrnr_nnls</code>), and like all of the default meta-learners in
<code>sl3</code>, then the revere-CV risk is a quick way to examine an approximation of
the CV risk estimate of the SL and it can thought of as a ballpark lower bound
on it. This idea holds in our example; that is, with the simple NNLS
meta-learner the revere risk estimate of the SL (1.0028)
is very close to, and slightly lower than, the CV risk estimate for the SL
(1.0067).</p>
</div>
</div>
</div>
<div id="discrete-super-learner" class="section level2">
<h2>
<span class="header-section-number">3.5</span> Discrete Super Learner<a class="anchor" aria-label="anchor" href="#discrete-super-learner"><i class="fas fa-link"></i></a>
</h2>
<p>From the glossary (Table 1) entry for discrete SL (dSL) in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>,
the dSL is “a SL that uses a winner-take-all meta-learner called
the cross-validated selector. The dSL is therefore identical to the candidate
with the best cross-validated performance; its predictions will be the same as
this candidate’s predictions”. The cross-validated selector is
<code>Lrnr_cv_selector</code> in <code>sl3</code> (see <code>Lrnr_cv_selector</code> documentation for more
detail) and a dSL is instantiated in <code>sl3</code> by using <code>Lrnr_cv_selector</code> as the
meta-learner in <code>Lrnr_sl</code>.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_selector</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_cv_selector.html">Lrnr_cv_selector</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>eval_function <span class="op">=</span> <span class="va">loss_squared_error</span><span class="op">)</span></span>
<span><span class="va">dSL</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va">cv_selector</span><span class="op">)</span></span></code></pre></div>
<p>Just like before, we use the learner’s <code>train</code> method to fit it to the
prediction task.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">4197</span><span class="op">)</span></span>
<span><span class="va">dSL_fit</span> <span class="op">&lt;-</span> <span class="va">dSL</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<p>Following from subsection <a href="https://tlverse.org/tlverse-handbook/sl3.html#summarizing-super-learner-fits">“Summarizing Super Learner
Fits”</a>
above, we can see how the <code>Lrnr_cv_selector</code> meta-learner created a function of
the candidates.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="sl3.html#cb66-1"></a><span class="kw">round</span>(dSL_fit<span class="op">$</span>coefficients, <span class="dv">3</span>)</span>
<span id="cb66-2"><a href="sl3.html#cb66-2"></a>                          Lrnr_glm_TRUE                               Lrnr_mean </span>
<span id="cb66-3"><a href="sl3.html#cb66-3"></a>                                      <span class="dv">0</span>                                       <span class="dv">0</span> </span>
<span id="cb66-4"><a href="sl3.html#cb66-4"></a>Lrnr_glmnet_NULL_deviance_<span class="dv">10</span>_<span class="dv">0</span>_<span class="dv">100</span>_TRUE Lrnr_glmnet_NULL_deviance_<span class="dv">10</span>_<span class="dv">1</span>_<span class="dv">100</span>_TRUE </span>
<span id="cb66-5"><a href="sl3.html#cb66-5"></a>                                      <span class="dv">0</span>                                       <span class="dv">0</span> </span>
<span id="cb66-6"><a href="sl3.html#cb66-6"></a>                         Lrnr_polspline         Lrnr_earth_<span class="dv">2</span>_<span class="dv">3</span>_backward_<span class="dv">0</span>_<span class="dv">1</span>_<span class="dv">0</span>_<span class="dv">0</span> </span>
<span id="cb66-7"><a href="sl3.html#cb66-7"></a>                                      <span class="dv">0</span>                                       <span class="dv">0</span> </span>
<span id="cb66-8"><a href="sl3.html#cb66-8"></a>             <span class="kw">Lrnr_hal9001_2_1_c</span>(<span class="dv">3</span>, <span class="dv">2</span>)_<span class="dv">5</span>             Lrnr_ranger_<span class="dv">500</span>_TRUE_none_<span class="dv">1</span> </span>
<span id="cb66-9"><a href="sl3.html#cb66-9"></a>                                      <span class="dv">0</span>                                       <span class="dv">1</span> </span>
<span id="cb66-10"><a href="sl3.html#cb66-10"></a>                      Lrnr_xgboost_<span class="dv">20</span>_<span class="dv">1</span>               Lrnr_gam_NULL_NULL_GCV.Cp </span>
<span id="cb66-11"><a href="sl3.html#cb66-11"></a>                                      <span class="dv">0</span>                                       <span class="dv">0</span> </span>
<span id="cb66-12"><a href="sl3.html#cb66-12"></a>                     Lrnr_bayesglm_TRUE </span>
<span id="cb66-13"><a href="sl3.html#cb66-13"></a>                                      <span class="dv">0</span> </span></code></pre></div>
<p>We can also examine the CV risk of the candidates alongside the coefficients:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dSL_cv_risk_table</span> <span class="op">&lt;-</span> <span class="va">dSL_fit</span><span class="op">$</span><span class="fu">cv_risk</span><span class="op">(</span>eval_fun <span class="op">=</span> <span class="va">loss_squared_error</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dSL_cv_risk_table</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
learner
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
coefficients
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
MSE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
Lrnr_glm_TRUE
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0224
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_mean
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0654
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_0_100_TRUE
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0167
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_glmnet_NULL_deviance_10_1_100_TRUE
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0143
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_polspline
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0163
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_earth_2_3_backward_0_1_0_0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0131
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_hal9001_2_1_c(3, 2)_5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0191
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_ranger_500_TRUE_none_1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1.0131
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_xgboost_20_1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0793
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_gam_NULL_NULL_GCV.Cp
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0235
</td>
</tr>
<tr>
<td style="text-align:left;">
Lrnr_bayesglm_TRUE
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0224
</td>
</tr>
</tbody>
</table></div>
</div>
<p>The multivariate adaptive splines regression candidate (<code>Lrnr_earth</code>) has the
lowest CV risk. Indeed, our winner-take-all meta-learner <code>Lrnr_cv_selector</code>
gave it a weight of one and all others zero weight; the resulting dSL will be
defined by this weighted combination, i.e., <code>dSL_fit</code> will be identical to the
full fit <code>Lrnr_earth</code>. We verify that the <code>dSL_fit</code>’s predictions are identical
to <code>Lrnr_earth</code>’s below.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="sl3.html#cb69-1"></a>dSL_pred &lt;-<span class="st"> </span>dSL_fit<span class="op">$</span><span class="kw">predict</span>(task)</span>
<span id="cb69-2"><a href="sl3.html#cb69-2"></a>earth_pred &lt;-<span class="st"> </span>dSL_fit<span class="op">$</span>learner_fits<span class="op">$</span>Lrnr_earth_<span class="dv">2</span>_<span class="dv">3</span>_backward_<span class="dv">0</span>_<span class="dv">1</span>_<span class="dv">0</span>_<span class="dv">0</span><span class="op">$</span><span class="kw">predict</span>(task)</span>
<span id="cb69-3"><a href="sl3.html#cb69-3"></a><span class="kw">identical</span>(dSL_pred, earth_pred)</span>
<span id="cb69-4"><a href="sl3.html#cb69-4"></a>[<span class="dv">1</span>] <span class="ot">FALSE</span></span></code></pre></div>
<div id="including-ensemble-super-learners-as-candidates-in-discrete-super-learner" class="section level3">
<h3>
<span class="header-section-number">3.5.1</span> Including ensemble Super Learner(s) as candidate(s) in discrete Super Learner<a class="anchor" aria-label="anchor" href="#including-ensemble-super-learners-as-candidates-in-discrete-super-learner"><i class="fas fa-link"></i></a>
</h3>
<p>We recommend using CV to evaluate the predictive performance of the SL. We
showed how to do this with <code>cv_sl</code> above. We have also seen that when we
include a learner as a candidate in the SL (in <code>sl3</code> terms, when we include a
learner in the <code>Stack</code> passed to <code>Lrnr_sl</code> as <code>learners</code>), we are able to
examine its CV risk. Also, when we use the dSL, the candidate that achieved the
lowest CV risk defines the resulting SL. We therefore can use the dSL automate
a procedure for obtaining a final SL that represents the candidate with the
best cross-validated predictive performance. When the ensemble SL (eSL) and
its candidate learners are considered in a dSL as candidates, the eSL’s CV
performance can be compared to that from the learners from which it was
constructed, and the final SL will be the candidate that achieved the lowest CV
risk. From the glossary (Table 1) entry for eSL in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>, an
eSL is “a SL that uses any parametric or non-parametric algorithm as its
meta-learner. Therefore, the eSL is defined by a combination of multiple
candidates; its predictions are defined by a combination of multiple candidates’
predictions.” In the following, we show how to include the eSL, and multiple
eSLs, as candidates in the dSL.</p>
<p>Recall the SL object, <code>sl</code>, defined in section 2:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># in the section 2 we defined Lrnr_sl as</span></span>
<span><span class="co"># sl &lt;- Lrnr_sl$new(learners = stack, metalearner = Lrnr_nnls$new())</span></span></code></pre></div>
<p><code>sl</code> is an eSL since it used NNLS as the meta-learner. We rename <code>sl</code> to
<code>eSL_metaNNLS</code> below to clarify that this is an eSL that uses NNLS as its
meta-learner. Note that the candidate learners in this eSL are those passed
to the <code>learners</code> argument, i.e., <code>stack</code>.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># let's rename it to clarify that this is an eSL that uses NNLS as meta-learner</span></span>
<span><span class="va">eSL_metaNNLS</span> <span class="op">&lt;-</span> <span class="va">sl</span></span></code></pre></div>
<p>To consider the <code>eSL_metaNNLS</code> as an additional candidate in <code>stack</code>, we can
create a new stack that includes the original candidate learners and the eSL.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stack_with_eSL</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">stack</span>, <span class="va">eSL_metaNNLS</span><span class="op">)</span></span></code></pre></div>
<p>To instantiate the dSL that considers as its candidates <code>eSL_metaNNLS</code> and the
individual learners from which <code>eSL_metaNNLS</code> was constructed, we define
a new <code>Lrnr_sl</code> that considers <code>stack_with_eSL</code> as candidates and
<code>Lrnr_cv_selector</code> as the meta-learner.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_selector</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_cv_selector.html">Lrnr_cv_selector</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>eval_function <span class="op">=</span> <span class="va">loss_squared_error</span><span class="op">)</span></span>
<span><span class="va">dSL</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack_with_eSL</span>, metalearner <span class="op">=</span> <span class="va">cv_selector</span><span class="op">)</span></span></code></pre></div>
<p>When we include an eSL as a candidate in the dSL, this allows the eSL’s CV
performance to be compared to that from the other learners from which it was
constructed. This is similar to calling CV SL, <code>cv_sl</code>, above. The difference
between including the eSL as a candidate in the dSL and calling <code>cv_sl</code> is that
the former automates a procedure for the final SL to be the learner that
achieved the best CV predictive performance, i.e., lowest CV risk. If the eSL
outperforms any other candidate, the dSL will end up selecting it and the
resulting SL will be the eSL. As mentioned in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>, “another advantage
of this approach is that multiple eSLs that use more flexible meta-learner
methods (e.g., non-parametric machine learning algorithms like HAL) can be
evaluated simultaneously.”</p>
<p>Below, we show how multiple eSLs can be included as candidates in a dSL:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># instantiate more eSLs</span></span>
<span><span class="va">eSL_metaNNLSconvex</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_nnls.html">Lrnr_nnls</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>convex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">eSL_metaLasso</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va">lrn_lasso</span><span class="op">)</span></span>
<span><span class="va">eSL_metaEarth</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va">lrn_earth</span><span class="op">)</span></span>
<span><span class="va">eSL_metaRanger</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va">lrn_ranger</span><span class="op">)</span></span>
<span><span class="va">eSL_metaHAL</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack</span>, metalearner <span class="op">=</span> <span class="va">lrn_hal</span><span class="op">)</span></span>
<span><span class="co"># adding the eSLs to the stack that defined them</span></span>
<span><span class="va">stack_with_eSLs</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="va">stack</span>, <span class="va">eSL_metaNNLS</span>, <span class="va">eSL_metaNNLSconvex</span>, <span class="va">eSL_metaLasso</span>, <span class="va">eSL_metaEarth</span>,</span>
<span>  <span class="va">eSL_metaRanger</span>, <span class="va">eSL_metaHAL</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># specify dSL</span></span>
<span><span class="va">dSL</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learners <span class="op">=</span> <span class="va">stack_with_eSLs</span>, metalearner <span class="op">=</span> <span class="va">cv_selector</span><span class="op">)</span></span></code></pre></div>
<p>We included as candidates in the dSL:</p>
<ol style="list-style-type: decimal">
<li>the same eSL as before, <code>eSL_metaNNLS</code>;</li>
<li>the learners considered as candidates in (1);</li>
<li>an eSL that considered the same candidate learners as (1) and a convex
combination-constrained NNLS as the meta-learner;</li>
<li>an eSL that considered the same candidate learners as (1) and a lasso
meta-learner, using <code>lrn_lasso</code> which was instantiated in section 2;</li>
<li>an eSL that considered the same candidate learners as (1) and a
multivariate adaptive regression splines (earth) meta-learner, using
<code>lrn_earth</code> which was instantiated in section 2;</li>
<li>an eSL that considered the same candidate learners as (1) and a
ranger meta-learner, using <code>lrn_ranger</code> which was instantiated in section 2; and</li>
<li>an eSL that considered the same candidate learners as (1) and a
HAL meta-learner, using <code>lrn_hal</code> which was instantiated in section 2.</li>
</ol>
<p>Running this many eSLs in the dSL is currently very computationally intensive
in <code>sl3</code>, as it is akin to running cross-validated SL for each eSL. Parallel
programming (reviewed below) is recommended for training learners that are
computationally intensive, like the <code>dSL</code> defined above. That is, a parallel
processing scheme should be defined before calling <code>dSL$train(task)</code> in order
to speed up the run time.</p>
</div>
</div>
<div id="parallel-processing" class="section level2">
<h2>
<span class="header-section-number">3.6</span> Parallel Processing<a class="anchor" aria-label="anchor" href="#parallel-processing"><i class="fas fa-link"></i></a>
</h2>
<p>It’s straightforward to take advantage of <code>sl3</code>’s built-in parallel processing
support, which draws on the <a href="https://cran.r-project.org/web/packages/future/index.html"><code>future</code> R
package</a>, which
provides a lightweight, unified Future API for sequential and parallel
processing of R expressions via futures. From the <code>future</code> package
documentation: “This package implements sequential, multicore, multisession, and cluster futures. With these, R expressions can be evaluated on the local
machine, in parallel a set of local machines, or distributed on a mix of local
and remote machines. Extensions to this package implement additional backends
for processing futures via compute cluster schedulers, etc. Because of its
unified API, there is no need to modify any code in order switch from
sequential on the local machine to, say, distributed processing on a remote
compute cluster. Another strength of this package is that global variables and
functions are automatically identified and exported as needed, making it
straightforward to tweak existing code to make use of futures.”</p>
<p>To use <code>future</code> with <code>sl3</code>, you can simply choose a futures <code>plan()</code>, as shown
below.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="sl3.html#cb75-1"></a><span class="co"># let's load the future package and set n-1 cores for parallel processing</span></span>
<span id="cb75-2"><a href="sl3.html#cb75-2"></a><span class="kw">library</span>(future)</span>
<span id="cb75-3"><a href="sl3.html#cb75-3"></a>ncores &lt;-<span class="st"> </span><span class="kw">availableCores</span>() <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb75-4"><a href="sl3.html#cb75-4"></a>ncores</span>
<span id="cb75-5"><a href="sl3.html#cb75-5"></a>system </span>
<span id="cb75-6"><a href="sl3.html#cb75-6"></a>     <span class="dv">1</span> </span>
<span id="cb75-7"><a href="sl3.html#cb75-7"></a><span class="kw">plan</span>(multicore, <span class="dt">workers =</span> ncores)</span>
<span id="cb75-8"><a href="sl3.html#cb75-8"></a><span class="co"># now, let's re-train sl in parallel for demonstrative purposes</span></span>
<span id="cb75-9"><a href="sl3.html#cb75-9"></a><span class="co"># we will also set a stopwatch so we can see how long this takes</span></span>
<span id="cb75-10"><a href="sl3.html#cb75-10"></a>start_time &lt;-<span class="st"> </span><span class="kw">proc.time</span>()</span>
<span id="cb75-11"><a href="sl3.html#cb75-11"></a></span>
<span id="cb75-12"><a href="sl3.html#cb75-12"></a><span class="kw">set.seed</span>(<span class="dv">4197</span>)</span>
<span id="cb75-13"><a href="sl3.html#cb75-13"></a>sl_fit_parallel &lt;-<span class="st"> </span>sl<span class="op">$</span><span class="kw">train</span>(task)</span>
<span id="cb75-14"><a href="sl3.html#cb75-14"></a></span>
<span id="cb75-15"><a href="sl3.html#cb75-15"></a>runtime_sl_fit_parallel &lt;-<span class="st"> </span><span class="kw">proc.time</span>() <span class="op">-</span><span class="st"> </span>start_time</span>
<span id="cb75-16"><a href="sl3.html#cb75-16"></a>runtime_sl_fit_parallel</span>
<span id="cb75-17"><a href="sl3.html#cb75-17"></a>   user  system elapsed </span>
<span id="cb75-18"><a href="sl3.html#cb75-18"></a><span class="fl">248.754</span>   <span class="fl">4.427</span> <span class="fl">246.089</span> </span></code></pre></div>
</div>
<div id="default-data-pre-processing" class="section level2">
<h2>
<span class="header-section-number">3.7</span> Default Data Pre-processing<a class="anchor" aria-label="anchor" href="#default-data-pre-processing"><i class="fas fa-link"></i></a>
</h2>
<p>In <code>sl3</code> it is required that the analytic dataset (i.e., the dataset
consisting of observations on an outcome and covariates) does not contain any
missing values, and it does not contain character and factor covariates.
In this subsection, we review the default functionality in <code>sl3</code> that takes care
of this internally; specifically, this data pre-processing occurs when
<code>make_sl3_Task</code> is called.</p>
<p>Users can also perform any pre-processing before creating the <code>sl3_Task</code>
(as needed) to bypass the default functionality discussed in the following.
See <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>, section “Preliminaries: Analytic dataset pre-processing”
for more information and general guidelines to follow for pre-processing of the
analytic dataset, including considerations for pre-processing in high
dimensional settings.</p>
<p>Recall that the <code>sl3_Task</code> object defines the prediction task of interest. Our
task in the illustrative example from above was to use the WASH Benefits
Bangladesh data to learn a function of the covariates for predicting
weight-for-height Z-score <code>whz</code>. For more details on <code>sl3_Task</code>, refer to the
documentation (e.g., by inputting “?sl3_Task” in R). We will instantiate the
task in order to examine the pre-processing of <code>washb_data</code>.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="sl3.html#cb76-1"></a><span class="co"># create the task (i.e., use washb_data to predict outcome using covariates)</span></span>
<span id="cb76-2"><a href="sl3.html#cb76-2"></a>task &lt;-<span class="st"> </span><span class="kw">make_sl3_Task</span>(</span>
<span id="cb76-3"><a href="sl3.html#cb76-3"></a>  <span class="dt">data =</span> washb_data,</span>
<span id="cb76-4"><a href="sl3.html#cb76-4"></a>  <span class="dt">outcome =</span> <span class="st">"whz"</span>,</span>
<span id="cb76-5"><a href="sl3.html#cb76-5"></a>  <span class="dt">covariates =</span> <span class="kw">c</span>(</span>
<span id="cb76-6"><a href="sl3.html#cb76-6"></a>    <span class="st">"tr"</span>, <span class="st">"fracode"</span>, <span class="st">"month"</span>, <span class="st">"aged"</span>, <span class="st">"sex"</span>, <span class="st">"momage"</span>, <span class="st">"momedu"</span>,</span>
<span id="cb76-7"><a href="sl3.html#cb76-7"></a>    <span class="st">"momheight"</span>, <span class="st">"hfiacat"</span>, <span class="st">"Nlt18"</span>, <span class="st">"Ncomp"</span>, <span class="st">"watmin"</span>, <span class="st">"elec"</span>,</span>
<span id="cb76-8"><a href="sl3.html#cb76-8"></a>    <span class="st">"floor"</span>, <span class="st">"walls"</span>, <span class="st">"roof"</span>, <span class="st">"asset_wardrobe"</span>, <span class="st">"asset_table"</span>,</span>
<span id="cb76-9"><a href="sl3.html#cb76-9"></a>    <span class="st">"asset_chair"</span>, <span class="st">"asset_khat"</span>, <span class="st">"asset_chouki"</span>, <span class="st">"asset_tv"</span>,</span>
<span id="cb76-10"><a href="sl3.html#cb76-10"></a>    <span class="st">"asset_refrig"</span>, <span class="st">"asset_bike"</span>, <span class="st">"asset_moto"</span>, <span class="st">"asset_sewmach"</span>,</span>
<span id="cb76-11"><a href="sl3.html#cb76-11"></a>    <span class="st">"asset_mobile"</span></span>
<span id="cb76-12"><a href="sl3.html#cb76-12"></a>  )</span>
<span id="cb76-13"><a href="sl3.html#cb76-13"></a>)</span>
<span id="cb76-14"><a href="sl3.html#cb76-14"></a>Warning <span class="cf">in</span> <span class="kw">process_data</span>(data, nodes, <span class="dt">column_names =</span> column_names, <span class="dt">flag =</span> flag,</span>
<span id="cb76-15"><a href="sl3.html#cb76-15"></a><span class="op">:</span><span class="st"> </span>Imputing missing values and adding missingness indicators <span class="cf">for</span> the following</span>
<span id="cb76-16"><a href="sl3.html#cb76-16"></a>covariates with missing values<span class="op">:</span><span class="st"> </span>momage, momheight. See documentation of the</span>
<span id="cb76-17"><a href="sl3.html#cb76-17"></a>process_data <span class="cf">function</span> <span class="cf">for</span> details.</span></code></pre></div>
<div id="imputation-and-missingness-indicators" class="section level3">
<h3>
<span class="header-section-number">3.7.1</span> Imputation and missingness indicators<a class="anchor" aria-label="anchor" href="#imputation-and-missingness-indicators"><i class="fas fa-link"></i></a>
</h3>
<p>Notice the warning that appeared when we created the task above. (We muted this
warning when we created the task in the previous section). This warning states
that missing covariate data was detected and imputed. For each covariate column
with missing values, <code>sl3</code> uses the median to impute missing continuous
covariates, and the mode to impute discrete (binary and categorical) covariates.</p>
<p>Also, for each covariate with missing values, an additional column indicating
whether the value was imputed is incorporated. The so-called “missingness
indicator” covariates can be helpful, as the pattern of covariate missingness
might be informative for predicting the outcome.</p>
<p>Users are free to handle missingness in their covariate data before creating
the sl3 task. In any case, we do recommend the inclusion of the
missingness indicator as a covariate. Let’s examine this in greater detail for
completeness. It’s also easier to see what’s going on here by examining it with
an example.</p>
<p>First, let’s examine the missingness in the data:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="sl3.html#cb77-1"></a><span class="co"># which columns have missing values, and how many observations are missing?</span></span>
<span id="cb77-2"><a href="sl3.html#cb77-2"></a><span class="kw">colSums</span>(<span class="kw">is.na</span>(washb_data))</span>
<span id="cb77-3"><a href="sl3.html#cb77-3"></a>           whz             tr        fracode          month           aged </span>
<span id="cb77-4"><a href="sl3.html#cb77-4"></a>             <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span> </span>
<span id="cb77-5"><a href="sl3.html#cb77-5"></a>           sex         momage         momedu      momheight        hfiacat </span>
<span id="cb77-6"><a href="sl3.html#cb77-6"></a>             <span class="dv">0</span>             <span class="dv">18</span>              <span class="dv">0</span>             <span class="dv">31</span>              <span class="dv">0</span> </span>
<span id="cb77-7"><a href="sl3.html#cb77-7"></a>         Nlt18          Ncomp         watmin           elec          floor </span>
<span id="cb77-8"><a href="sl3.html#cb77-8"></a>             <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span> </span>
<span id="cb77-9"><a href="sl3.html#cb77-9"></a>         walls           roof asset_wardrobe    asset_table    asset_chair </span>
<span id="cb77-10"><a href="sl3.html#cb77-10"></a>             <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span> </span>
<span id="cb77-11"><a href="sl3.html#cb77-11"></a>    asset_khat   asset_chouki       asset_tv   asset_refrig     asset_bike </span>
<span id="cb77-12"><a href="sl3.html#cb77-12"></a>             <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span> </span>
<span id="cb77-13"><a href="sl3.html#cb77-13"></a>    asset_moto  asset_sewmach   asset_mobile </span>
<span id="cb77-14"><a href="sl3.html#cb77-14"></a>             <span class="dv">0</span>              <span class="dv">0</span>              <span class="dv">0</span> </span></code></pre></div>
<p>We can see that covariates <code>momage</code> and <code>momheight</code> have missing observations.
Let’s check out a few rows in the data with missing values:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="sl3.html#cb78-1"></a>some_rows_with_missingness &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="op">!</span><span class="kw">complete.cases</span>(washb_data))[<span class="dv">31</span><span class="op">:</span><span class="dv">33</span>]</span>
<span id="cb78-2"><a href="sl3.html#cb78-2"></a><span class="co"># note: we chose 31:33 because missingness in momage &amp; momheight is there</span></span>
<span id="cb78-3"><a href="sl3.html#cb78-3"></a>washb_data[some_rows_with_missingness, <span class="kw">c</span>(<span class="st">"momage"</span>, <span class="st">"momheight"</span>)]</span>
<span id="cb78-4"><a href="sl3.html#cb78-4"></a>   momage momheight</span>
<span id="cb78-5"><a href="sl3.html#cb78-5"></a><span class="dv">1</span><span class="op">:</span><span class="st">     </span><span class="ot">NA</span>     <span class="fl">153.2</span></span>
<span id="cb78-6"><a href="sl3.html#cb78-6"></a><span class="dv">2</span><span class="op">:</span><span class="st">     </span><span class="dv">17</span>        <span class="ot">NA</span></span>
<span id="cb78-7"><a href="sl3.html#cb78-7"></a><span class="dv">3</span><span class="op">:</span><span class="st">     </span><span class="dv">23</span>        <span class="ot">NA</span></span></code></pre></div>
<p>When we called <code>make_sl3_Task</code> using <code>washb_data</code> with missing covariate values,
<code>momage</code> and <code>momheight</code> were imputed with their respective medians (since they
are continuous), and a missingness indicator (denoted by prefix “delta_”) was
added for each of them. See below:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="sl3.html#cb79-1"></a>task<span class="op">$</span>data[</span>
<span id="cb79-2"><a href="sl3.html#cb79-2"></a>  some_rows_with_missingness,</span>
<span id="cb79-3"><a href="sl3.html#cb79-3"></a>  <span class="kw">c</span>(<span class="st">"momage"</span>, <span class="st">"momheight"</span>, <span class="st">"delta_momage"</span>, <span class="st">"delta_momheight"</span>)</span>
<span id="cb79-4"><a href="sl3.html#cb79-4"></a>]</span>
<span id="cb79-5"><a href="sl3.html#cb79-5"></a>   momage momheight delta_momage delta_momheight</span>
<span id="cb79-6"><a href="sl3.html#cb79-6"></a><span class="dv">1</span><span class="op">:</span><span class="st">     </span><span class="dv">23</span>     <span class="fl">153.2</span>            <span class="dv">0</span>               <span class="dv">1</span></span>
<span id="cb79-7"><a href="sl3.html#cb79-7"></a><span class="dv">2</span><span class="op">:</span><span class="st">     </span><span class="dv">17</span>     <span class="fl">150.6</span>            <span class="dv">1</span>               <span class="dv">0</span></span>
<span id="cb79-8"><a href="sl3.html#cb79-8"></a><span class="dv">3</span><span class="op">:</span><span class="st">     </span><span class="dv">23</span>     <span class="fl">150.6</span>            <span class="dv">1</span>               <span class="dv">0</span></span>
<span id="cb79-9"><a href="sl3.html#cb79-9"></a><span class="kw">colSums</span>(<span class="kw">is.na</span>(task<span class="op">$</span>data))</span>
<span id="cb79-10"><a href="sl3.html#cb79-10"></a>             tr         fracode           month            aged             sex </span>
<span id="cb79-11"><a href="sl3.html#cb79-11"></a>              <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span> </span>
<span id="cb79-12"><a href="sl3.html#cb79-12"></a>         momage          momedu       momheight         hfiacat           Nlt18 </span>
<span id="cb79-13"><a href="sl3.html#cb79-13"></a>              <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span> </span>
<span id="cb79-14"><a href="sl3.html#cb79-14"></a>          Ncomp          watmin            elec           floor           walls </span>
<span id="cb79-15"><a href="sl3.html#cb79-15"></a>              <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span> </span>
<span id="cb79-16"><a href="sl3.html#cb79-16"></a>           roof  asset_wardrobe     asset_table     asset_chair      asset_khat </span>
<span id="cb79-17"><a href="sl3.html#cb79-17"></a>              <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span> </span>
<span id="cb79-18"><a href="sl3.html#cb79-18"></a>   asset_chouki        asset_tv    asset_refrig      asset_bike      asset_moto </span>
<span id="cb79-19"><a href="sl3.html#cb79-19"></a>              <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span> </span>
<span id="cb79-20"><a href="sl3.html#cb79-20"></a>  asset_sewmach    asset_mobile    delta_momage delta_momheight             whz </span>
<span id="cb79-21"><a href="sl3.html#cb79-21"></a>              <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span>               <span class="dv">0</span> </span></code></pre></div>
<p>Indeed, we can see that <code>washb_task$data</code> has no missing values. The missingness
indicators take a value of 0 when the observation <em>was not</em> in the original data
and a value of 1 when the observation <em>was</em> in the original data.</p>
<p>If the data supplied to <code>make_sl3_Task</code> contains missing outcome values, then an
error will be thrown. Missing outcomes in the data can easily be dropped when
the task is created, by setting <code>drop_missing_outcome = TRUE</code>. In general, we do
not recommend dropping missing outcomes during data pre-processing, unless the
problem of interest is purely prediction. This is because complete case analyses
are generally biased; it is typically unrealistic to assume the missingness is
completely random and therefore unsafe to just drop the observations with
missing outcomes. For instance, in the estimation of estimands that admit
Targeted Minimum Loss-based Estimators (i.e., pathwise differentiable estimands,
including most parameters arising in causal inference that do not violate
positivity, and those reviewed in the following chapters), the missingness that
should be reflected in the expression of the question of interest (e.g., what
would have been the average effect of treatment with Drug A compared to standard
of care under no loss to follow-up) is also incorporated in the estimation
procedure. That is, the probability of loss to follow-up is a prediction
function that is approximated (e.g., with SL) and incorporated that in the
estimation of the target parameter and the inference / uncertainty
quantification.</p>
</div>
<div id="character-and-categorical-covariates" class="section level3">
<h3>
<span class="header-section-number">3.7.2</span> Character and categorical covariates<a class="anchor" aria-label="anchor" href="#character-and-categorical-covariates"><i class="fas fa-link"></i></a>
</h3>
<p>First any character covariates are converted to factors. Then all factor
covariates are one-hot encoded, i.e., the levels of a factor become a set of
binary indicators. For example, the factor <code>cats</code> and it’s one-hot encoding are
shown below:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="sl3.html#cb80-1"></a>cats &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"calico"</span>, <span class="st">"tabby"</span>, <span class="st">"cow"</span>, <span class="st">"ragdoll"</span>, <span class="st">"mancoon"</span>, <span class="st">"dwarf"</span>, <span class="st">"calico"</span>)</span>
<span id="cb80-2"><a href="sl3.html#cb80-2"></a>cats &lt;-<span class="st"> </span><span class="kw">factor</span>(cats)</span>
<span id="cb80-3"><a href="sl3.html#cb80-3"></a>cats_onehot &lt;-<span class="st"> </span><span class="kw">factor_to_indicators</span>(cats)</span>
<span id="cb80-4"><a href="sl3.html#cb80-4"></a>cats_onehot</span>
<span id="cb80-5"><a href="sl3.html#cb80-5"></a>     cow dwarf mancoon ragdoll tabby</span>
<span id="cb80-6"><a href="sl3.html#cb80-6"></a>[<span class="dv">1</span>,]   <span class="dv">0</span>     <span class="dv">0</span>       <span class="dv">0</span>       <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb80-7"><a href="sl3.html#cb80-7"></a>[<span class="dv">2</span>,]   <span class="dv">0</span>     <span class="dv">0</span>       <span class="dv">0</span>       <span class="dv">0</span>     <span class="dv">1</span></span>
<span id="cb80-8"><a href="sl3.html#cb80-8"></a>[<span class="dv">3</span>,]   <span class="dv">1</span>     <span class="dv">0</span>       <span class="dv">0</span>       <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb80-9"><a href="sl3.html#cb80-9"></a>[<span class="dv">4</span>,]   <span class="dv">0</span>     <span class="dv">0</span>       <span class="dv">0</span>       <span class="dv">1</span>     <span class="dv">0</span></span>
<span id="cb80-10"><a href="sl3.html#cb80-10"></a>[<span class="dv">5</span>,]   <span class="dv">0</span>     <span class="dv">0</span>       <span class="dv">1</span>       <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb80-11"><a href="sl3.html#cb80-11"></a>[<span class="dv">6</span>,]   <span class="dv">0</span>     <span class="dv">1</span>       <span class="dv">0</span>       <span class="dv">0</span>     <span class="dv">0</span></span>
<span id="cb80-12"><a href="sl3.html#cb80-12"></a>[<span class="dv">7</span>,]   <span class="dv">0</span>     <span class="dv">0</span>       <span class="dv">0</span>       <span class="dv">0</span>     <span class="dv">0</span></span></code></pre></div>
<p>The second value for <code>cats</code> was “tabby” so the second row of <code>cats_onehot</code> has
value 1 under tabby. Every level of <code>cats</code> except for one is represented in the
<code>cats_onehot</code> table. The first and last <code>cats</code> are “calico” so the first and
last rows of <code>cats_onehot</code> are zero across all columns, to denote this level
that does not appear explicitly in the table.</p>
<p>The learners in <code>sl3</code> are trained to the object <code>X</code> in the task, or a sample of
<code>X</code> for learners that use CV. Let’s check out the first six rows of our task’s
<code>X</code> object:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">task</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr.Handwashing
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr.Nutrition
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr.Nutrition…WSH
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr.Sanitation
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr.WSH
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
tr.Water
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N04681
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N05160
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N05265
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N05359
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06229
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06453
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06458
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06473
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06479
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06489
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06500
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06502
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06505
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06516
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06524
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06528
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06531
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N06862
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fracode.N08002
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
month
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
aged
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
sex.male
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momage
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momedu.Primary..1.5y.
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momedu.Secondary…5y.
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
momheight
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
hfiacat.Mildly.Food.Insecure
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
hfiacat.Moderately.Food.Insecure
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
hfiacat.Severely.Food.Insecure
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Nlt18
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
Ncomp
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
watmin
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
elec
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
floor
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
walls
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
roof
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_wardrobe
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_table
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_chair
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_khat
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_chouki
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_tv
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_refrig
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_bike
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_moto
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_sewmach
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
asset_mobile
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
delta_momage
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
delta_momheight
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
268
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
146.40
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
286
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
148.75
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
264
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
25
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
152.15
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
252
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
28
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
140.25
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
336
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
19
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
150.95
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
304
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
154.20
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table></div>
</div>
<p>We can see that any character columns in the WASH Benefits dataset were
converted to factors and all factors (<code>tr</code>, <code>momedu</code>, <code>hfiacat</code> and <code>fracode</code>)
were one-hot encoded. We can also see that the missingness indicators reviewed
above are the last two columns in <code>task$X</code>: <code>delta_momage</code> and <code>delta_momage</code>.
The imputed <code>momage</code> and <code>momheight</code> are also in the task’s <code>X</code> object.</p>
</div>
</div>
<div id="learner-documentation" class="section level2">
<h2>
<span class="header-section-number">3.8</span> Learner Documentation<a class="anchor" aria-label="anchor" href="#learner-documentation"><i class="fas fa-link"></i></a>
</h2>
<p>Documentation for the learners and some of their tuning parameters can be found
in the R session (e.g., to see <code>Lrnr_glmnet</code>’s parameters, one could type
“?Lrnr_glmnet” in RStudio’s R console) or online at the <a href="https://tlverse.org/sl3/reference/index.html#section-sl-learners"><code>sl3</code> Learners
Reference</a>.
All of the learners in <code>sl3</code> are simply wrappers around existing functions from
other software packages in R. For example, <code>sl3</code>’s <code>Lrnr_xgboost</code> is a learner
in <code>sl3</code> for fitting the XGBoost (eXtreme Gradient Boosting) algorithm. As
described in the <code>Lrnr_xgboost</code> documentation, “this learner provides fitting
procedures for <code>xgboost</code> models, using the <code>xgboost</code> package, via <code>xgb.train</code>”.
In general, the documentation in <code>sl3</code> for a learner refers the reader to the
original function and package that <code>sl3</code> has wrapped a learner around. With
that in mind, the <code>sl3</code> learner documentation is a good first place to look up
any learner, as it will show us exactly which package and function the learner
is based on. However, any thorough investigation of a learner (such as a
detailed explanation of all tuning parameters or how it models the data)
typically involves referencing the original package. Continuing the
example from above, this means that, while some information will be provided in
<code>Lrnr_xgboost</code> documentation, such as learning that <code>Lrnr_xgboost</code> uses the
<code>xgboost</code> package’s <code>xgb.train</code> function, the deepest understanding of the
XGBoost algorithm available in <code>sl3</code> will come from referencing the <code>xgboost</code>
R package and its <code>xgb.train</code> function.</p>
</div>
<div id="naming-learners" class="section level2">
<h2>
<span class="header-section-number">3.9</span> Naming Learners<a class="anchor" aria-label="anchor" href="#naming-learners"><i class="fas fa-link"></i></a>
</h2>
<p>Recall that our <code>Stack</code> from the example above had long names.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="sl3.html#cb82-1"></a>stack</span>
<span id="cb82-2"><a href="sl3.html#cb82-2"></a> [<span class="dv">1</span>] <span class="st">"Lrnr_glm_TRUE"</span>                          </span>
<span id="cb82-3"><a href="sl3.html#cb82-3"></a> [<span class="dv">2</span>] <span class="st">"Lrnr_mean"</span>                              </span>
<span id="cb82-4"><a href="sl3.html#cb82-4"></a> [<span class="dv">3</span>] <span class="st">"Lrnr_glmnet_NULL_deviance_10_0_100_TRUE"</span></span>
<span id="cb82-5"><a href="sl3.html#cb82-5"></a> [<span class="dv">4</span>] <span class="st">"Lrnr_glmnet_NULL_deviance_10_1_100_TRUE"</span></span>
<span id="cb82-6"><a href="sl3.html#cb82-6"></a> [<span class="dv">5</span>] <span class="st">"Lrnr_polspline"</span>                         </span>
<span id="cb82-7"><a href="sl3.html#cb82-7"></a> [<span class="dv">6</span>] <span class="st">"Lrnr_earth_2_3_backward_0_1_0_0"</span>        </span>
<span id="cb82-8"><a href="sl3.html#cb82-8"></a> [<span class="dv">7</span>] <span class="st">"Lrnr_hal9001_2_1_c(3, 2)_5"</span>             </span>
<span id="cb82-9"><a href="sl3.html#cb82-9"></a> [<span class="dv">8</span>] <span class="st">"Lrnr_ranger_500_TRUE_none_1"</span>            </span>
<span id="cb82-10"><a href="sl3.html#cb82-10"></a> [<span class="dv">9</span>] <span class="st">"Lrnr_xgboost_20_1"</span>                      </span>
<span id="cb82-11"><a href="sl3.html#cb82-11"></a>[<span class="dv">10</span>] <span class="st">"Lrnr_gam_NULL_NULL_GCV.Cp"</span>              </span>
<span id="cb82-12"><a href="sl3.html#cb82-12"></a>[<span class="dv">11</span>] <span class="st">"Lrnr_bayesglm_TRUE"</span>                     </span></code></pre></div>
<p>Here, we show a few different ways for the user to name learners. The first way
to name a learner is upon instantiation, as shown below:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrn_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm.html">Lrnr_glm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"GLM"</span><span class="op">)</span></span></code></pre></div>
<p>We can specify the <code>name</code> for any learner upon instantiating it. Above,
we named the GLM learner “GLM”.</p>
<p>Also, we can specify the names of the learners upon creation of the <code>Stack</code>:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="sl3.html#cb84-1"></a>learners_pretty_names &lt;-<span class="st"> </span><span class="kw">c</span>(</span>
<span id="cb84-2"><a href="sl3.html#cb84-2"></a>  <span class="st">"GLM"</span> =<span class="st"> </span>lrn_glm, <span class="st">"Mean"</span> =<span class="st"> </span>lrn_mean, <span class="st">"Ridge"</span> =<span class="st"> </span>lrn_ridge,</span>
<span id="cb84-3"><a href="sl3.html#cb84-3"></a>  <span class="st">"Lasso"</span> =<span class="st"> </span>lrn_lasso, <span class="st">"Polspline"</span> =<span class="st"> </span>lrn_polspline, <span class="st">"Earth"</span> =<span class="st"> </span>lrn_earth,</span>
<span id="cb84-4"><a href="sl3.html#cb84-4"></a>  <span class="st">"HAL"</span> =<span class="st"> </span>lrn_hal, <span class="st">"RF"</span> =<span class="st"> </span>lrn_ranger, <span class="st">"XGBoost"</span> =<span class="st"> </span>lrn_xgb, <span class="st">"GAM"</span> =<span class="st"> </span>lrn_gam,</span>
<span id="cb84-5"><a href="sl3.html#cb84-5"></a>  <span class="st">"BayesGLM"</span> =<span class="st"> </span>lrn_bayesglm</span>
<span id="cb84-6"><a href="sl3.html#cb84-6"></a>)</span>
<span id="cb84-7"><a href="sl3.html#cb84-7"></a>stack_pretty_names &lt;-<span class="st"> </span>Stack<span class="op">$</span><span class="kw">new</span>(learners_pretty_names)</span>
<span id="cb84-8"><a href="sl3.html#cb84-8"></a>stack_pretty_names</span>
<span id="cb84-9"><a href="sl3.html#cb84-9"></a> [<span class="dv">1</span>] <span class="st">"GLM"</span>       <span class="st">"Mean"</span>      <span class="st">"Ridge"</span>     <span class="st">"Lasso"</span>     <span class="st">"Polspline"</span> <span class="st">"Earth"</span>    </span>
<span id="cb84-10"><a href="sl3.html#cb84-10"></a> [<span class="dv">7</span>] <span class="st">"HAL"</span>       <span class="st">"RF"</span>        <span class="st">"XGBoost"</span>   <span class="st">"GAM"</span>       <span class="st">"BayesGLM"</span> </span></code></pre></div>
</div>
<div id="defining-learners-over-grid-of-tuning-parameters" class="section level2">
<h2>
<span class="header-section-number">3.10</span> Defining Learners over Grid of Tuning Parameters<a class="anchor" aria-label="anchor" href="#defining-learners-over-grid-of-tuning-parameters"><i class="fas fa-link"></i></a>
</h2>
<p>Customized learners can be created over a grid of tuning parameters. For
highly flexible learners that require careful tuning, it is oftentimes
very helpful to consider different tuning parameter specifications. However,
this is time consuming, so computational feasibility should be considered.
Also, when the effective sample size is small, highly flexible learners
will likely not perform well since they typically require a lot of data to fit
their models. See <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span> for information on the effective sample size,
and step-by-step guidelines for tailoring the SL specification to perform well
for the prediction task at hand.</p>
<p>We show two ways to customize learners over a grid of tuning parameters. The
first, “do-it-yourself” approach requires that the user or a collaborator has
knowledge of the algorithm and their tuning parameters, so they can adequately
specify a set of tuning parameters themselves. The second approach does not
require the user to have specialized knowledge of an algorithm (although some
understanding is still helpful); it uses the <code>caret</code> software to automatically
select an “optimal” set of tuning parameters over a grid of them.</p>
<div id="do-it-yourself-grid" class="section level3">
<h3>
<span class="header-section-number">3.10.1</span> Do-it-yourself grid<a class="anchor" aria-label="anchor" href="#do-it-yourself-grid"><i class="fas fa-link"></i></a>
</h3>
<p>Below, we show how we can create several variations of an XGBoost learner,
<code>Lrnr_xgboost</code>, by hand. This example is just for demonstrative purposes; users
should consult the documentation, and consider computational feasibility and
their prediction task to specify an appropriate grid of tuning parameters for
their task.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="sl3.html#cb85-1"></a>grid_params &lt;-<span class="st"> </span><span class="kw">list</span>(</span>
<span id="cb85-2"><a href="sl3.html#cb85-2"></a>  <span class="dt">max_depth =</span> <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">8</span>),</span>
<span id="cb85-3"><a href="sl3.html#cb85-3"></a>  <span class="dt">eta =</span> <span class="kw">c</span>(<span class="fl">0.001</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>),</span>
<span id="cb85-4"><a href="sl3.html#cb85-4"></a>  <span class="dt">nrounds =</span> <span class="dv">100</span></span>
<span id="cb85-5"><a href="sl3.html#cb85-5"></a>)</span>
<span id="cb85-6"><a href="sl3.html#cb85-6"></a>grid &lt;-<span class="st"> </span><span class="kw">expand.grid</span>(grid_params, <span class="dt">KEEP.OUT.ATTRS =</span> <span class="ot">FALSE</span>)</span>
<span id="cb85-7"><a href="sl3.html#cb85-7"></a></span>
<span id="cb85-8"><a href="sl3.html#cb85-8"></a>xgb_learners &lt;-<span class="st"> </span><span class="kw">apply</span>(grid, <span class="dt">MARGIN =</span> <span class="dv">1</span>, <span class="cf">function</span>(tuning_params) {</span>
<span id="cb85-9"><a href="sl3.html#cb85-9"></a>  <span class="kw">do.call</span>(Lrnr_xgboost<span class="op">$</span>new, <span class="kw">as.list</span>(tuning_params))</span>
<span id="cb85-10"><a href="sl3.html#cb85-10"></a>})</span>
<span id="cb85-11"><a href="sl3.html#cb85-11"></a>xgb_learners</span>
<span id="cb85-12"><a href="sl3.html#cb85-12"></a>[[<span class="dv">1</span>]]</span>
<span id="cb85-13"><a href="sl3.html#cb85-13"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_3_0.001"</span></span>
<span id="cb85-14"><a href="sl3.html#cb85-14"></a></span>
<span id="cb85-15"><a href="sl3.html#cb85-15"></a>[[<span class="dv">2</span>]]</span>
<span id="cb85-16"><a href="sl3.html#cb85-16"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_5_0.001"</span></span>
<span id="cb85-17"><a href="sl3.html#cb85-17"></a></span>
<span id="cb85-18"><a href="sl3.html#cb85-18"></a>[[<span class="dv">3</span>]]</span>
<span id="cb85-19"><a href="sl3.html#cb85-19"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_8_0.001"</span></span>
<span id="cb85-20"><a href="sl3.html#cb85-20"></a></span>
<span id="cb85-21"><a href="sl3.html#cb85-21"></a>[[<span class="dv">4</span>]]</span>
<span id="cb85-22"><a href="sl3.html#cb85-22"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_3_0.1"</span></span>
<span id="cb85-23"><a href="sl3.html#cb85-23"></a></span>
<span id="cb85-24"><a href="sl3.html#cb85-24"></a>[[<span class="dv">5</span>]]</span>
<span id="cb85-25"><a href="sl3.html#cb85-25"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_5_0.1"</span></span>
<span id="cb85-26"><a href="sl3.html#cb85-26"></a></span>
<span id="cb85-27"><a href="sl3.html#cb85-27"></a>[[<span class="dv">6</span>]]</span>
<span id="cb85-28"><a href="sl3.html#cb85-28"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_8_0.1"</span></span>
<span id="cb85-29"><a href="sl3.html#cb85-29"></a></span>
<span id="cb85-30"><a href="sl3.html#cb85-30"></a>[[<span class="dv">7</span>]]</span>
<span id="cb85-31"><a href="sl3.html#cb85-31"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_3_0.3"</span></span>
<span id="cb85-32"><a href="sl3.html#cb85-32"></a></span>
<span id="cb85-33"><a href="sl3.html#cb85-33"></a>[[<span class="dv">8</span>]]</span>
<span id="cb85-34"><a href="sl3.html#cb85-34"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_5_0.3"</span></span>
<span id="cb85-35"><a href="sl3.html#cb85-35"></a></span>
<span id="cb85-36"><a href="sl3.html#cb85-36"></a>[[<span class="dv">9</span>]]</span>
<span id="cb85-37"><a href="sl3.html#cb85-37"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_xgboost_100_1_8_0.3"</span></span></code></pre></div>
<p>In the example above, we considered every possible combination in the grid to
create nine XGBoost learners. If we wanted to create custom names for each of
these learners we could do that as well:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">xgb_learners</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"XGBoost_depth3_eta.001"</span>, <span class="st">"XGBoost_depth5_eta.001"</span>, <span class="st">"XGBoost_depth8_eta.001"</span>,</span>
<span>  <span class="st">"XGBoost_depth3_eta.1"</span>, <span class="st">"XGBoost_depth5_eta.1"</span>, <span class="st">"XGBoost_depth8_eta.1"</span>,</span>
<span>  <span class="st">"XGBoost_depth3_eta.3"</span>, <span class="st">"XGBoost_depth5_eta.3"</span>, <span class="st">"XGBoost_depth8_eta.3"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="automatic-grid-and-selection-with-caret" class="section level3">
<h3>
<span class="header-section-number">3.10.2</span> Automatic grid and selection with <code>caret</code><a class="anchor" aria-label="anchor" href="#automatic-grid-and-selection-with-caret"><i class="fas fa-link"></i></a>
</h3>
<p>We can use the <code>Lrnr_caret</code> to use the <code>caret</code> software. As described in the
<code>Lrnr_caret</code> documentation, <code>Lrnr_caret</code> “uses the <code>caret</code> package’s <code>train</code>
function to automatically tune a predictive model”. Below, we instantiate a
neural network that will be automatically tuned with <code>caret</code> and we name the
learner “NNET_autotune”.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrnr_nnet_autotune</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_caret.html">Lrnr_caret</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"nnet"</span>, name <span class="op">=</span> <span class="st">"NNET_autotune"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="learners-with-interactions-and-formula-interface" class="section level2">
<h2>
<span class="header-section-number">3.11</span> Learners with Interactions and <code>formula</code> Interface<a class="anchor" aria-label="anchor" href="#learners-with-interactions-and-formula-interface"><i class="fas fa-link"></i></a>
</h2>
<p>As described in in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>, if it’s known/possible that there are
interactions among covariates then we can include learners that pick up on that
explicitly (e.g., by including in the library a parametric regression learner
with interactions specified in a formula) or implicitly (e.g., by including in
the library tree-based algorithms that learn interactions empirically).</p>
<p>One way to define interaction terms among covariates in <code>sl3</code> is with a
<code>formula</code>. The argument exists in <code>Lrnr_base</code>, which is inherited by every
learner in <code>sl3</code>; even though <code>formula</code> does not explicitly appear as a
learner argument, it is via this inheritance. This implementation allows
<code>formula</code> to be supplied to all learners, even those without native <code>formula</code>
support. Below, we show how to specify a GLM learner that considers two-way
interactions among all covariates.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lrnr_glm_interaction</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm.html">Lrnr_glm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>formula <span class="op">=</span> <span class="st">"~.^2"</span><span class="op">)</span></span></code></pre></div>
<p>As we can see from above, the general behavior of <code>formula</code>in R applies in
<code>sl3</code>. See Details of <code>formula</code> in the <code>stats</code> R package for more details on
this syntax (e.g,. in RStudio, type “?formula” in the Console and information
will appear in the Help tab).</p>
</div>
<div id="covariate-screening" class="section level2">
<h2>
<span class="header-section-number">3.12</span> Covariate Screening<a class="anchor" aria-label="anchor" href="#covariate-screening"><i class="fas fa-link"></i></a>
</h2>
<p>One characteristic of a rich library of learners is that it is effective at
handling covariates of high dimension. When there are many covariates in the
data relative to the effective sample size (see Figure 1 Flowchart in
<span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>), candidate learners should be coupled with a range of so-called
“screeners”. A screener is simply a function that returns a subset of
covariates. A screener is intended to be coupled with a candidate learner, to
define a new candidate learner that considers the reduced set of
screener-returned covariates as its covariates.</p>
<p>As stated in <span class="citation">Phillips et al. (<a href="references.html#ref-rvp2022super" role="doc-biblioref">2022</a>)</span>, “covariate screening is essential when the
dimensionality of the data is very large, and it can be practically useful in
any SL or machine learning application. Screening of covariates that considers
associations with the outcome must be cross validated to avoid biasing the
estimate of an algorithm’s predictive performance”. By including
screener-learner couplings as additional candidates in the SL library, we are
cross validating the screening of covariates. Covariates retained in each CV
fold may vary.</p>
<p>A “range of screeners” is a set of screeners that exhibits varying
degrees of dimension reduction and incorporates different fitting procedures
(e.g., lasso-based screeners that retain covariates with non-zero
coefficients, and importance-based screeners that retain the top <span class="math inline">\(j\)</span> most
important covariates according to some importance metric. The current set of
screeners available in <code>sl3</code> is described in each part below.</p>
<p>We will see that, to define a screener and learner coupling in <code>sl3</code>,
we need to create a <code>Pipeline</code>. A <code>Pipeline</code> is a set of learners
to be fit sequentially, where the fit from one learner is used to define the
task for the next learner.</p>
<div id="variable-importance-based-screeners" class="section level3">
<h3>
<span class="header-section-number">3.12.1</span> Variable importance-based screeners<a class="anchor" aria-label="anchor" href="#variable-importance-based-screeners"><i class="fas fa-link"></i></a>
</h3>
<p>Variable importance-based screeners retain the top <span class="math inline">\(j\)</span> most important covariates
according to some importance metric. This screener is provided by
<code>Lrnr_screener_importance</code> in <code>sl3</code> and the parameter <span class="math inline">\(j\)</span> (default is five) is
provided by the user via the <code>num_screen</code> argument. The user also gets to
choose the importance metric considered via the <code>learner</code> argument. Any
learner with an importance method can be used in <code>Lrnr_screener_importance</code>;
this currently includes the following:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="sl3.html#cb89-1"></a><span class="kw">sl3_list_learners</span>(<span class="dt">properties =</span> <span class="st">"importance"</span>)</span>
<span id="cb89-2"><a href="sl3.html#cb89-2"></a>[<span class="dv">1</span>] <span class="st">"Lrnr_lightgbm"</span>     <span class="st">"Lrnr_randomForest"</span> <span class="st">"Lrnr_ranger"</span>      </span>
<span id="cb89-3"><a href="sl3.html#cb89-3"></a>[<span class="dv">4</span>] <span class="st">"Lrnr_xgboost"</span>     </span></code></pre></div>
<p>Let’s consider screening covariates based on <code>Lrnr_ranger</code> variable importance
ranking that selects the top ten most important covariates, according to
<code>ranger</code>’s “impurity_corrected” importance. We will couple this screener with
<code>Lrnr_glm</code> to define a new learner that (1) selects the top ten most important
covariates, according to <code>ranger</code>’s “impurity_corrected” importance, and then
(2) passes the screener-selected covariates to <code>Lrnr_glm</code>, so <code>Lrnr_glm</code>
fits a model according to this reduced set of covariates. As mentioned above,
this coupling establishes a new learner and requires defining a <code>Pipeline</code>.
The <code>Pipeline</code> is <code>sl3</code>’s way of going from (1) to (2).</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ranger_with_importance</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_ranger.html">Lrnr_ranger</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>importance <span class="op">=</span> <span class="st">"impurity_corrected"</span><span class="op">)</span></span>
<span><span class="va">RFscreen_top10</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_screener_importance.html">Lrnr_screener_importance</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  learner <span class="op">=</span> <span class="va">ranger_with_importance</span>, num_screen <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">RFscreen_top10_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">RFscreen_top10</span>, <span class="va">lrn_glm</span><span class="op">)</span></span></code></pre></div>
<p>We could even define the <code>Pipeline</code> for the entire <code>Stack</code>, so that every
learner in it is fit to the screener-selected, reduced set of ten covariates.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RFscreen_top10_stack</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">RFscreen_top10</span>, <span class="va">stack</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="coefficient-threshold-based-screeners" class="section level3">
<h3>
<span class="header-section-number">3.12.2</span> Coefficient threshold-based screeners<a class="anchor" aria-label="anchor" href="#coefficient-threshold-based-screeners"><i class="fas fa-link"></i></a>
</h3>
<p><code>Lrnr_screener_coefs</code> provides screening of covariates based on the magnitude
of their estimated coefficients in a (possibly regularized) GLM. The
<code>threshold</code> (default = 1e-3) defines the minimum absolute size of the
coefficients, and thus covariates, to be kept. Also, a <code>max_retain</code> argument
can be optionally provided to restrict the number of selected covariates to be
no more than <code>max_retain</code>.</p>
<p>Let’s consider screening covariates with <code>Lrnr_screener_coefs</code> to select the
variables with non-zero lasso regression coefficients. We will couple this
screener with <code>Lrnr_glm</code> to define a new learner that (1) selects the covariates
with non-zero lasso regression coefficients, and then (2) passes the
screener-selected covariates to <code>Lrnr_glm</code>, so <code>Lrnr_glm</code> fits a model
according to this reduced set of covariates. The structure is very similar to
above.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lasso_screen</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_screener_coefs.html">Lrnr_screener_coefs</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>learner <span class="op">=</span> <span class="va">lrn_lasso</span>, threshold <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">lasso_screen_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">lasso_screen</span>, <span class="va">lrn_glm</span><span class="op">)</span></span></code></pre></div>
<p>We could even define the <code>Pipeline</code> for the entire <code>Stack</code>, so that every
learner in it is fit to the lasso screener-selected, reduced set of covariates.</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lasso_screen_stack</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">lasso_screen</span>, <span class="va">stack</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="correlation-based-screeners" class="section level3">
<h3>
<span class="header-section-number">3.12.3</span> Correlation-based screeners<a class="anchor" aria-label="anchor" href="#correlation-based-screeners"><i class="fas fa-link"></i></a>
</h3>
<p><code>Lrnr_screener_correlation</code> provides covariate screening procedures by
running a test of correlation (Pearson default), and then selecting the (1) top
ranked variables (default), or (2) the variables with a p-value lower than
some user-specified threshold.</p>
<p>Let’s consider screening covariates with <code>Lrnr_screener_coefs</code>. We will
illustrate how to set up a pipeline with a <code>Stack</code>, which looks the same as
previous examples. The <code>Pipeline</code> with a single learner also looks the same as
previous examples.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># select top 10 most correlated covariates</span></span>
<span><span class="va">corRank_screen</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_screener_correlation.html">Lrnr_screener_correlation</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"rank"</span>, num_screen <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="va">corRank_screen_stack</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">corRank_screen</span>, <span class="va">stack</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select covariates with correlation p-value below 0.05, and a minimum of 3</span></span>
<span><span class="va">corP_screen</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_screener_correlation.html">Lrnr_screener_correlation</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"threshold"</span>, pvalue_threshold <span class="op">=</span> <span class="fl">0.05</span>, min_screen <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="va">corP_screen_stack</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">corP_screen</span>, <span class="va">stack</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="augmented-screeners" class="section level3">
<h3>
<span class="header-section-number">3.12.4</span> Augmented screeners<a class="anchor" aria-label="anchor" href="#augmented-screeners"><i class="fas fa-link"></i></a>
</h3>
<p>Augmented screeners are special in that they enforce certain covariates to
always be included. That is, if a screener removes a “mandatory” covariate then
<code>Lrnr_screener_augment</code> will reincorporate it before the learner(s) in the
<code>Pipeline</code> are fit. An example of how to use this screener is included below.
We assume <code>aged</code> and <code>momage</code> are covariates that must be kept in learner
fitting.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keepme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aged"</span>, <span class="st">"momage"</span><span class="op">)</span></span>
<span><span class="co"># using corRank_screen as an example, but any instantiated screener can be</span></span>
<span><span class="co"># supplied as screener.</span></span>
<span><span class="va">corRank_screen_augmented</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_screener_augment.html">Lrnr_screener_augment</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  screener <span class="op">=</span> <span class="va">corRank_screen</span>, default_covariates <span class="op">=</span> <span class="va">keepme</span></span>
<span><span class="op">)</span></span>
<span><span class="va">corRank_screen_augmented_glm</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Pipeline.html">Pipeline</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">corRank_screen_augmented</span>, <span class="va">lrn_glm</span><span class="op">)</span></span></code></pre></div>
<p><code>Lrnr_screener_augment</code> is useful when subject-matter experts feel strongly
that certain covariate sets must be included, even under screening procedures.</p>
</div>
<div id="stack-with-range-of-screeners" class="section level3">
<h3>
<span class="header-section-number">3.12.5</span> <code>Stack</code> with range of screeners<a class="anchor" aria-label="anchor" href="#stack-with-range-of-screeners"><i class="fas fa-link"></i></a>
</h3>
<p>Above, we mentioned that we’d like to consider a range of screeners to
diversify the library. Here we show how we can create a new <code>Stack</code> from other
learners stacks which includes learners with no screening, and learners coupled
with various screeners.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">screeners_stack</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Stack.html">Stack</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="va">stack</span>, <span class="va">corP_screen_stack</span>, <span class="va">corRank_screen_stack</span>,</span>
<span>  <span class="va">lasso_screen_stack</span>, <span class="va">RFscreen_top10_stack</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This <code>screeners_stack</code> could be inputted as <code>learners</code> in <code>Lrnr_sl</code> to
define the SL that considers as candidates learners with no screening, and
learners coupled with various screeners.</p>
<!--
#### Defining Novel Performance Metrics with `ROCR`
-->
</div>
</div>
<div id="advanced-sl3-functionality" class="section level2 unnumbered">
<h2>Advanced <code>sl3</code> Functionality:<a class="anchor" aria-label="anchor" href="#advanced-sl3-functionality"><i class="fas fa-link"></i></a>
</h2>
</div>
<div id="variable-importance-measures" class="section level2">
<h2>
<span class="header-section-number">3.13</span> Variable Importance Measures<a class="anchor" aria-label="anchor" href="#variable-importance-measures"><i class="fas fa-link"></i></a>
</h2>
<p>Variable importance can be interesting and informative. It can also be
contradictory and confusing. Nevertheless, our collaborators tend to like it,
so we created a function to assess variable importance in <code>sl3</code>. The <code>sl3</code>
<code>importance</code> function returns a table with variables listed in decreasing order
of importance (i.e., most important listed on the first row).</p>
<p>The measure of importance in <code>sl3</code> is based on a ratio or difference of
predictive performance between the SL fit with a removed or permuted
covariate (or covariate grouping), and the SL fit with the observed covariate (or
covariate grouping), across all of them. In this manner, the larger the
ratio/difference in predictive performance, the more important the covariate
(or covariate group) is in the SL prediction.</p>
<p>The intuition of this measure is that it calculates the predictive risk (e.g.,
MSE) of losing one covariate (or one group of covariates), while keeping
everything else fixed, comparing this predictive risk to the one from the
analytic dataset. If the ratio in predictive risks is one, or the difference is
zero, then losing that covariate (group) had no impact, and it is thus not
important according to this measure. This procedure is repeated across all of
the covariates/groups. As stated above, we can remove each covariate (or
covariate group) and refit the SL without it, or we just permute it (faster) and
hope for this shuffling to distort any meaningful information that was present.
This idea of permuting instead of removing saves a lot of time, and is also
incorporated in <code>randomForest</code> variable importance measures. However, the
permutation approach is more risky. The <code>sl3</code> <code>importance</code> default is to remove
each covariate and then refit. Below, we use the <code>permute</code> approach because it
is so much faster.</p>
<p>Let’s explore the <code>sl3</code> variable importance measurements for <code>sl_fit</code>, the
SL we fit above to the WASH Benefits example dataset. We define a grouping
of covariates to consider in the importance evaluation that is based on
household assets, as this collection of variables reflects the socio-economic
status (SES) of the study’s participants.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">assets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"asset_wardrobe"</span>, <span class="st">"asset_table"</span>, <span class="st">"asset_chair"</span>, <span class="st">"asset_khat"</span>,</span>
<span>  <span class="st">"asset_chouki"</span>, <span class="st">"asset_tv"</span>, <span class="st">"asset_refrig"</span>, <span class="st">"asset_bike"</span>,</span>
<span>  <span class="st">"asset_moto"</span>, <span class="st">"asset_sewmach"</span>, <span class="st">"asset_mobile"</span>, <span class="st">"Nlt18"</span>, <span class="st">"Ncomp"</span>,</span>
<span>  <span class="st">"watmin"</span>, <span class="st">"elec"</span>, <span class="st">"floor"</span>, <span class="st">"walls"</span>, <span class="st">"roof"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">983</span><span class="op">)</span></span>
<span><span class="va">washb_varimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/importance.html">importance</a></span><span class="op">(</span></span>
<span>  fit <span class="op">=</span> <span class="va">sl_fit</span>, eval_fun <span class="op">=</span> <span class="va">loss_squared_error</span>, type <span class="op">=</span> <span class="st">"permute"</span>,</span>
<span>  covariate_groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"assets"</span> <span class="op">=</span> <span class="va">assets</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">washb_varimp</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
covariate_group
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
MSE_difference
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
aged
</td>
<td style="text-align:right;">
0.0337
</td>
</tr>
<tr>
<td style="text-align:left;">
assets
</td>
<td style="text-align:right;">
0.0315
</td>
</tr>
<tr>
<td style="text-align:left;">
momedu
</td>
<td style="text-align:right;">
0.0109
</td>
</tr>
<tr>
<td style="text-align:left;">
month
</td>
<td style="text-align:right;">
0.0092
</td>
</tr>
<tr>
<td style="text-align:left;">
tr
</td>
<td style="text-align:right;">
0.0059
</td>
</tr>
<tr>
<td style="text-align:left;">
momheight
</td>
<td style="text-align:right;">
0.0019
</td>
</tr>
<tr>
<td style="text-align:left;">
hfiacat
</td>
<td style="text-align:right;">
0.0007
</td>
</tr>
<tr>
<td style="text-align:left;">
sex
</td>
<td style="text-align:right;">
0.0005
</td>
</tr>
<tr>
<td style="text-align:left;">
momage
</td>
<td style="text-align:right;">
0.0002
</td>
</tr>
<tr>
<td style="text-align:left;">
fracode
</td>
<td style="text-align:right;">
0.0001
</td>
</tr>
<tr>
<td style="text-align:left;">
delta_momheight
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
<tr>
<td style="text-align:left;">
delta_momage
</td>
<td style="text-align:right;">
0.0000
</td>
</tr>
</tbody>
</table></div>
</div>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot variable importance</span></span>
<span><span class="fu"><a href="https://tlverse.org/sl3/reference/importance_plot.html">importance_plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">washb_varimp</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:varimp-plot"></span>
<img src="07-sl3_files/figure-html/varimp-plot-1.png" alt="sl3 variable importance for predicting weight-for-height z-score with WASH Benefits example dataset" width="80%"><p class="caption">
FIGURE 3.2: sl3 variable importance for predicting weight-for-height z-score with WASH Benefits example dataset
</p>
</div>
<p>According to the <code>sl3</code> variable importance measures, which were assessed by
the mean squared error (MSE) difference under permutations of each covariate,
the fitted SL’s (<code>sl_fit</code>) most important variables for predicting
weight-for-height z-score (<code>whz</code>) are child age (<code>aged</code>) and household assets
(<code>assets</code>) that reflect the socio-economic status of the study’s subjects.</p>
</div>
<div id="conditional-density-estimation" class="section level2">
<h2>
<span class="header-section-number">3.14</span> Conditional Density Estimation<a class="anchor" aria-label="anchor" href="#conditional-density-estimation"><i class="fas fa-link"></i></a>
</h2>
<p>In certain scenarios it may be useful to estimate the conditional density of a
dependent variable, given predictors/covariates that precede it. In the
context of causal inference, this arises most readily when working with
continuous-valued treatments. Specifically, conditional density estimation (CDE)
is necessary when estimating the treatment mechanism for a continuous-valued
treatment, often called the <em>generalized propensity score</em>. Compared the
classical propensity score (PS) for binary treatments (the conditional
probability of receiving the treatment given covariates),
<span class="math inline">\(\mathbb{P}(A = 1 \mid W)\)</span>, the generalized PS is the conditional density of
treatment <span class="math inline">\(A\)</span>, given covariates <span class="math inline">\(W\)</span>, <span class="math inline">\(\mathbb{P}(A \mid W)\)</span>.</p>
<p>CDE often requires specialized approaches tied to very specific algorithmic
implementations. To our knowledge, general and flexible algorithms for
CDE have been proposed only sparsely in the literature. We have implemented two
such approaches in <code>sl3</code>: a semiparametric CDE approach that makes certain
assumptions about the constancy of (higher) moments of the underlying
distribution, and second approach that exploits the relationship between the
conditional hazard and density functions to allow CDE via pooled hazard
regression. Both approaches are flexible in that they allow
the use of arbitrary regression functions or machine learning algorithms for the
estimation of nuisance quantities (the conditional mean or the conditional
hazard, respectively). We elaborate on these two frameworks below. Importantly,
per <span class="citation">Dudoit and van der Laan (<a href="references.html#ref-dudoit2005asymptotics" role="doc-biblioref">2005</a>)</span> and related works, a loss function appropriate for
density estimation is the negative log-density loss <span class="math inline">\(L(\cdot) = -\log(p_n(\cdot))\)</span>.</p>
<div id="moment-restricted-location-scale" class="section level3">
<h3>
<span class="header-section-number">3.14.1</span> Moment-restricted location-scale<a class="anchor" aria-label="anchor" href="#moment-restricted-location-scale"><i class="fas fa-link"></i></a>
</h3>
<p>This family of semiparametric CDE approaches exploits the general form <span class="math inline">\(\rho(Y - \mu(X) / \sigma(X))\)</span>, where <span class="math inline">\(Y\)</span> is the dependent variable of interest (e.g.,
treatment <span class="math inline">\(A\)</span> in the PS), <span class="math inline">\(X\)</span> are the predictors (e.g., covariates <span class="math inline">\(W\)</span> in the
PS), $ is a specified marginal density function, and <span class="math inline">\(\mu(X) = \E(Y \mid X)\)</span>
and <span class="math inline">\(\sigma(X) = \E[(Y - \mu(X))^2 \mid X]\)</span> are nuisance functions of the
dependent variable that may be estimated flexibly. CDE procedures formulated
within this framework may be characterized as belonging to a
<em>conditional location-scale</em> family, that is, in which
<span class="math inline">\(p_n(Y \mid X) = \rho((Y - \mu_n(X)) / \sigma_n(X))\)</span>. While CDE with
conditional location-scale families is not without potential disadvantages
(e.g., the restriction on the density’s functional form could lead to
misspecification bias), this strategy is flexible in that it allows for
arbitrary machine learning algorithms to be used in estimating the conditional
mean of <span class="math inline">\(Y\)</span> given <span class="math inline">\(X\)</span>, (X) = (Y X)$, and the conditional variance
of <span class="math inline">\(Y\)</span> given <span class="math inline">\(X\)</span>, <span class="math inline">\(\sigma(X) = \E[(Y - \mu(X))^2 \mid X]\)</span>.</p>
<p>In settings with limited data, the additional structure imposed by the
assumption that the target density belongs to a location-scale family may prove
advantageous by smoothing over areas of low support in the data. However, in
practice, it is impossible to know whether and when this assumption holds. This
procedure is not a novel contribution of our own (and we have been unable to
locate a formal description of it in the literature); nevertheless, we provide
an informal algorithm sketch below. This algorithm considers access to <span class="math inline">\(n\)</span>
independendent and identically distributed (i.i.d.) copies of an observed data
random variable <span class="math inline">\(O = (Y, X)\)</span>, an <em>a priori</em>-specified kernel function <span class="math inline">\(\rho\)</span>, a
candidate regression procedure <span class="math inline">\(f_{\mu}\)</span> to estimate <span class="math inline">\(\mu(X)\)</span>, and a candidate
regression procedure <span class="math inline">\(f_{\sigma}\)</span> to estimate <span class="math inline">\(\sigma(X)\)</span>.</p>
<ol style="list-style-type: decimal">
<li>Estimate <span class="math inline">\(\mu(X) = \E[Y \mid X]\)</span>, the conditional mean of <span class="math inline">\(Y\)</span> given <span class="math inline">\(X\)</span>, by
applying the regression estimator <span class="math inline">\(f_{\mu}\)</span>, yielding <span class="math inline">\(\hat{\mu}(X)\)</span>.</li>
<li>Estimate <span class="math inline">\(\sigma(X) = \mathbb{V}[Y \mid X]\)</span>, the conditional variance of <span class="math inline">\(Y\)</span>
given <span class="math inline">\(X\)</span>, by applying the regression estimator <span class="math inline">\(f_{\sigma}\)</span>, yielding
<span class="math inline">\(\hat{\sigma}^2(X)\)</span>. Note that this step involves only estimation of the
conditional mean <span class="math inline">\(\E[(Y - \hat{\mu}(X))^2 \mid X]\)</span>.</li>
<li>Estimate the one-dimensional density of <span class="math inline">\((Y - \hat{\mu}(X))^2 / \hat{\sigma}^2(X)\)</span>, using kernel smoothing to obtain <span class="math inline">\(\hat{\rho}(Y)\)</span>.</li>
<li>Construct the estimated conditional density <span class="math inline">\(p_n(Y \mid X) = \hat{\rho}((Y - \hat{\mu}(X)) / \hat{\sigma}(X))\)</span>.</li>
</ol>
<p>This algorithm sketch encompasses two forms of this CDE approach, which diverge
at the second step above. To simplify the approach, one may elect to estimate
only the conditional mean <span class="math inline">\(\mu(X)\)</span>, leaving the conditional variance to be
assumed constant (i.e., estimated simply as the marginal mean of the
residuals <span class="math inline">\(\E[(Y - \hat{\mu}(X))^2]\)</span>). This subclass of CDE approaches have
<em>homoscedastic error</em> based on the variance assumption made. The conditional
variance can instead by estimated as the conditional mean of the residuals
<span class="math inline">\((Y - \hat{\mu}(X))^2\)</span> given <span class="math inline">\(X\)</span>, <span class="math inline">\(\E[(Y - \hat{\mu}(X))^2 \mid X]\)</span>, where the
candidate algorithm <span class="math inline">\(f_{\sigma}\)</span> is used to evaluate the expectation.
Both approaches have been implemented in <code>sl3</code>, in the learner
<code>Lrnr_density_semiparametric</code>. The <code>mean_learner</code> argument specifies
<span class="math inline">\(f_{\mu}\)</span> and the optional <code>var_learner</code> argument specifies <span class="math inline">\(f_{\sigma}\)</span>. We
demonstrate CDE with this approach below.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># semiparametric density estimator with homoscedastic errors (HOSE)</span></span>
<span><span class="va">hose_hal_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_density_semiparametric.html">Lrnr_density_semiparametric</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  mean_learner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_hal9001.html">Lrnr_hal9001</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># semiparametric density estimator with heteroscedastic errors (HESE)</span></span>
<span><span class="va">hese_rf_glm_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_density_semiparametric.html">Lrnr_density_semiparametric</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  mean_learner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_ranger.html">Lrnr_ranger</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  var_learner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm.html">Lrnr_glm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># SL for the conditional treatment density</span></span>
<span><span class="va">sl_dens_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  learners <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">hose_hal_lrnr</span>, <span class="va">hese_rf_glm_lrnr</span><span class="op">)</span>,</span>
<span>  metalearner <span class="op">=</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_solnp_density.html">Lrnr_solnp_density</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="pooled-hazard-regression" class="section level3">
<h3>
<span class="header-section-number">3.14.2</span> Pooled hazard regression<a class="anchor" aria-label="anchor" href="#pooled-hazard-regression"><i class="fas fa-link"></i></a>
</h3>
<p>Another approach for CDE available in <code>sl3</code>, and originally proposed in
<span class="citation">Dı́az and van der Laan (<a href="references.html#ref-diaz2011super" role="doc-biblioref">2011</a>)</span>, leverages the relationship between the (conditional) hazard and
density functions. To develop their CDE framework, <span class="citation">Dı́az and van der Laan (<a href="references.html#ref-diaz2011super" role="doc-biblioref">2011</a>)</span> proposed
discretizing a continuous dependent variable <span class="math inline">\(Y\)</span> with support <span class="math inline">\(\mathcal{Y}\)</span>
based on a number of bins <span class="math inline">\(T\)</span> and a binning procedure (e.g., cutting
<span class="math inline">\(\mathcal{Y}\)</span> into <span class="math inline">\(T\)</span> bins of exactly the same length). The tuning parameter
<span class="math inline">\(T\)</span> conceptually corresponds to the choice of bandwidth in classical kernel
density estimation. Following discretization, each unit is represented by
a collection of records, and the number of records representing a given unit
depends on the rank of the bin (along the discretized support) into which the
unit falls.</p>
<p>To take an example, an instantiation of this procedure might divide the support
of <span class="math inline">\(Y\)</span> into, say, <span class="math inline">\(T = 4\)</span>, bins of equal length (note this requires <span class="math inline">\(T+1\)</span> cut
points): <span class="math inline">\([\alpha_1, \alpha_2), [\alpha_2, \alpha_3), [\alpha_3, \alpha_4), [\alpha_4, \alpha_5]\)</span> (n.b., the rightmost interval is fully closed while the
others are only partially closed). Next, an artificial, repeated measures
dataset would be created in which each unit would be represented by up to <span class="math inline">\(T\)</span>
records. To better see this structure, consider an individual unit
<span class="math inline">\(O_i = (Y_i, X_i)\)</span> whose <span class="math inline">\(Y_i\)</span> value is within <span class="math inline">\([\alpha_3, \alpha_4)\)</span>, the
third bin. This unit would be represented by three distinct records:
<span class="math inline">\(\{Y_{ij}, X_{ij}\}_{j=1}^3\)</span>, where <span class="math inline">\(\{\{Y_{ij} = 0\}_{j=1}^2\)</span>, <span class="math inline">\(Y_{i3} = 1\}\)</span><br>
and three exact copies of <span class="math inline">\(X_i\)</span>, <span class="math inline">\(\{X_{ij}\}_{j=1}^3\)</span>. This representation in
terms of multiple records for the same unit allows for the conditional hazard
probability of <span class="math inline">\(Y_i\)</span> falling in a given bin along the discretized support to
be evaluated via standard binary regression techniques.</p>
<p>In fact, this proposal reformulates the binary regression problem into a
corresponding set of hazard regressions: <span class="math inline">\(\mathbb{P} (Y \in [\alpha_{t-1}, \alpha_t) \mid X) = \mathbb{P} (Y \in [\alpha_{t-1}, \alpha_t) \mid Y \geq \alpha_{t-1}, X) \times \prod_{j = 1}^{t -1} \{1 - \mathbb{P} (Y \in [\alpha_{j-1}, \alpha_j) \mid Y \geq \alpha_{j-1}, X) \}\)</span>. Here, the probability
of <span class="math inline">\(Y \in \mathcal{Y}\)</span> falling in bin <span class="math inline">\([\alpha_{t-1}, \alpha_t)\)</span> may be directly
estimated via a binary regression procedure, by re-expressing the corresponding
likelihood in terms of the likelihood of a binary variable in a dataset with
this repeated measures structure. Finally, the hazard estimates can be mapped into
density estimates by re-scaling the hazard estimates by the bin sizes <span class="math inline">\(\lvert \alpha_t - \alpha_{t-1} \rvert\)</span>, that is, <span class="math inline">\(p_{n, \alpha}(Y \mid X) = \mathbb{P}(Y \in [\alpha_{t-1}, \alpha_t) \mid X) / \lvert \alpha_t - \alpha_{t-1} \rvert\)</span>, for <span class="math inline">\(\alpha_{t-1} \leq a &lt; \alpha_t\)</span>. We provide an
informal sketch of this algorithm below.</p>
<ol style="list-style-type: decimal">
<li>Apply a procedure to divide the observed support of <span class="math inline">\(Y\)</span>, <span class="math inline">\(\max(Y) - \min(Y)\)</span>,
into <span class="math inline">\(T\)</span> bins: <span class="math inline">\([\alpha_1, \alpha_2), \ldots, [\alpha_{t-1}, \alpha_t), [\alpha_t, \alpha_{t+1}]\)</span>.</li>
<li>Expand the observed data into a repeated measures data structure, expressing
each individual observation as a set of up to <span class="math inline">\(T\)</span> records, recording the
observation ID alongside each such record. For a single unit <span class="math inline">\(i\)</span>, the set of
records takes the form <span class="math inline">\(\{Y_{ij}, X_{ij}\}_{j=1}^{T_i}\)</span>, where <span class="math inline">\(X_{ij}\)</span> are
constant in the index set <span class="math inline">\(\mathcal{J}\)</span>, <span class="math inline">\(Y_{ij}\)</span> is a binary counting
process that jumps from <span class="math inline">\(0\)</span> to <span class="math inline">\(1\)</span> at its final index (at the bin into which
<span class="math inline">\(Y_i\)</span> falls), and <span class="math inline">\(T_i \leq T\)</span> indicates the bin along its support into which
<span class="math inline">\(Y_i\)</span> falls.</li>
<li>Estimate the hazard probability, conditional on <span class="math inline">\(X\)</span>, of bin membership
<span class="math inline">\(\mathbb{P}(Y_i \in [\alpha_{t-1}, \alpha_t) \mid X)\)</span> using any binary
regression estimator or appropriate machine learning algorithm.</li>
<li>Rescale the conditional hazard probability estimates to the conditional
density scale by dividing the cumulative hazard by the width of the bin into
which <span class="math inline">\(X_i\)</span> falls, for each observation <span class="math inline">\(i = 1, \ldots, n\)</span>. If the support
set is partitioned into bins of equal size (approximately <span class="math inline">\(n/T\)</span> samples in
each bin), this amounts to rescaling by a constant. If the support
set is partitioned into bins of equal range, then the rescaling might vary
across bins.</li>
</ol>
<p>A key element of this proposal is the flexibility to use any binary regression
procedure or appropriate machine learning algorithm to estimate <span class="math inline">\(\mathbb{P}(Y \in [\alpha_{t-1}, \alpha_t) \mid X)\)</span>, facilitating the incorporation of
flexibletechniques like ensemble learning <span class="citation">(Breiman <a href="references.html#ref-breiman1996stacked" role="doc-biblioref">1996</a>; van der Laan, Polley, and Hubbard <a href="references.html#ref-vdl2007super" role="doc-biblioref">2007</a>)</span>.
This extreme degree of flexibility integrates perfectly with the underlying
design principles of <code>sl3</code>; however, we have not yet implemented this approach
in its full generality. A version of this CDE approach, which limits the
original proposal by replacing the use of arbitrary binary regression with the
highly adaptive lasso (HAL) algorithm <span class="citation">(Benkeser and van der Laan <a href="references.html#ref-benkeser2016hal" role="doc-biblioref">2016</a>)</span> is supported in the
<a href="https://github.com/nhejazi/haldensify"><code>haldensify</code> package</a>
<span class="citation">(Hejazi, Benkeser, and van der Laan <a href="references.html#ref-hejazi2020haldensify" role="doc-biblioref">2022</a>)</span> (the HAL implementation in <code>haldensify</code> is provided the
<a href="https://github.com%20tlverse/hal9001"><code>hal9001</code> package</a>
<span class="citation">(Coyle et al. <a href="references.html#ref-coyle2020hal9001" role="doc-biblioref">2022</a>; Hejazi, Coyle, and van der Laan <a href="references.html#ref-hejazi2020hal9001" role="doc-biblioref">2020</a>)</span>). This CDE algorithm that uses
<code>haldensify</code> is incorporated as learner <code>Lrnr_haldensify</code> in <code>sl3</code>, as we
demonstrate below.</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># learners used for conditional densities for (g_n)</span></span>
<span><span class="va">haldensify_lrnr</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_haldensify.html">Lrnr_haldensify</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  n_bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<!--

## Time series forecasting

-->
</div>
</div>
<div id="exercises-1" class="section level2 unnumbered">
<h2>Exercises:<a class="anchor" aria-label="anchor" href="#exercises-1"><i class="fas fa-link"></i></a>
</h2>
<div id="binary-outcome-prediction" class="section level3 unnumbered">
<h3>Binary outcome prediction<a class="anchor" aria-label="anchor" href="#binary-outcome-prediction"><i class="fas fa-link"></i></a>
</h3>
<p>Follow the steps below to predict the probability for myocardial infarction
(<code>mi</code>) using the available covariate data. We thank Dr. David Benkeser,
Assistant Professor of Biostatistics and Bioinformatics at Emory University, for
making this Cardiovascular Health Study (CHS) publicly data available.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load the data set</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org">readr</a></span><span class="op">)</span></span>
<span><span class="va">db_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://raw.githubusercontent.com/benkeser/sllecture/master/"</span>,</span>
<span>    <span class="st">"chspred.csv"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">chspred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">db_data</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Let’s take a quick peek at the data:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">chspred</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%; ">
<div class="inline-table"><table class="table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
waist
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
alcoh
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
hdl
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
beta
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
smoke
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
ace
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
ldl
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
bmi
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
aspirin
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
gend
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
age
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
estrgn
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
glu
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
ins
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
cysgfr
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
dm
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
fetuina
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
whr
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
hsed
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
race
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
logcystat
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
logtrig
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
logcrp
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
logcre
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
health
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
logkcal
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
sysbp
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;position: sticky; top:0; background-color: #FFFFFF;">
mi
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
110.164
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
66.497
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
114.216
</td>
<td style="text-align:right;">
27.997
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
73.518
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
159.931
</td>
<td style="text-align:right;">
70.3343
</td>
<td style="text-align:right;">
75.008
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.17516
</td>
<td style="text-align:right;">
1.16898
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-0.34202
</td>
<td style="text-align:right;">
5.4063
</td>
<td style="text-align:right;">
2.01260
</td>
<td style="text-align:right;">
-0.67385
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
4.3926
</td>
<td style="text-align:right;">
177.135
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
89.976
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
50.065
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
103.777
</td>
<td style="text-align:right;">
20.893
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
61.772
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
153.389
</td>
<td style="text-align:right;">
33.9695
</td>
<td style="text-align:right;">
82.743
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.57165
</td>
<td style="text-align:right;">
0.90114
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.08465
</td>
<td style="text-align:right;">
4.8592
</td>
<td style="text-align:right;">
3.29328
</td>
<td style="text-align:right;">
-0.55509
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6.2071
</td>
<td style="text-align:right;">
136.374
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
106.194
</td>
<td style="text-align:right;">
8.4174
</td>
<td style="text-align:right;">
40.506
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
165.716
</td>
<td style="text-align:right;">
28.455
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
72.931
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
121.715
</td>
<td style="text-align:right;">
-17.3017
</td>
<td style="text-align:right;">
74.699
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.35168
</td>
<td style="text-align:right;">
1.17971
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
-0.44511
</td>
<td style="text-align:right;">
4.5088
</td>
<td style="text-align:right;">
0.30132
</td>
<td style="text-align:right;">
-0.01152
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
6.7320
</td>
<td style="text-align:right;">
135.199
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
90.057
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
36.175
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
45.203
</td>
<td style="text-align:right;">
23.961
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
79.119
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
53.969
</td>
<td style="text-align:right;">
11.7315
</td>
<td style="text-align:right;">
95.782
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.54391
</td>
<td style="text-align:right;">
1.13599
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.48072
</td>
<td style="text-align:right;">
5.1832
</td>
<td style="text-align:right;">
3.02426
</td>
<td style="text-align:right;">
-0.57507
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
7.3972
</td>
<td style="text-align:right;">
139.018
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
78.614
</td>
<td style="text-align:right;">
2.9790
</td>
<td style="text-align:right;">
71.064
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
131.312
</td>
<td style="text-align:right;">
10.966
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
69.018
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
94.315
</td>
<td style="text-align:right;">
9.7112
</td>
<td style="text-align:right;">
72.711
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.49159
</td>
<td style="text-align:right;">
1.10276
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.31206
</td>
<td style="text-align:right;">
4.2190
</td>
<td style="text-align:right;">
-0.70568
</td>
<td style="text-align:right;">
0.00534
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
8.2779
</td>
<td style="text-align:right;">
88.047
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:right;">
91.659
</td>
<td style="text-align:right;">
0.0000
</td>
<td style="text-align:right;">
59.496
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
171.187
</td>
<td style="text-align:right;">
29.132
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
81.835
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
212.907
</td>
<td style="text-align:right;">
-28.2269
</td>
<td style="text-align:right;">
69.218
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.46215
</td>
<td style="text-align:right;">
0.95291
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
-0.28716
</td>
<td style="text-align:right;">
5.1773
</td>
<td style="text-align:right;">
0.97046
</td>
<td style="text-align:right;">
0.21268
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
5.9942
</td>
<td style="text-align:right;">
69.594
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table></div>
</div>
<ol style="list-style-type: decimal">
<li>Create an <code>sl3</code> task, setting myocardial infarction <code>mi</code> as the outcome and
using all available covariate data.</li>
<li>Make a library of seven relatively fast base learning algorithms (i.e., do
not consider BART or HAL). Customize tuning parameters for one of your
learners. Incorporate at least one screener-learner coupling.</li>
<li>Make the SL and train it on the task.</li>
<li>Print the SL fit results by adding <code>$cv_risk(loss_squared_error)</code> to your
fit object.</li>
</ol>
<!--
## Categorical outcome prediction {-}
--><!--
## Multivariate outcome prediction {-}
-->
</div>
</div>
<div id="concluding-remarks" class="section level2">
<h2>
<span class="header-section-number">3.15</span> Concluding Remarks<a class="anchor" aria-label="anchor" href="#concluding-remarks"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>Super Learner (SL) is a general approach that can be applied to a diversity of
estimation and prediction problems which can be defined by a loss function.</p></li>
<li>
<p>It would be straightforward to plug in the estimator returned by SL into the
target parameter mapping.</p>
<ul>
<li>For example, suppose we are after the average treatment effect (ATE) of a
binary treatment intervention:
<span class="math inline">\(\Psi_0 = E_{0,W}[E_0(Y|A=1,W) - E_0(Y|A=0,W)]\)</span>.</li>
<li>We could use the SL that was trained on the original data (let’s call
this <code>sl_fit</code>) to predict the outcome for all subjects under each
intervention. All we would need to do is take the average difference
between the counterfactual outcomes under each intervention of interest.</li>
<li>Considering <span class="math inline">\(\Psi_0\)</span> above, we would first need two <span class="math inline">\(n\)</span>-length vectors of
predicted outcomes under each intervention. One vector would represent
the predicted outcomes under an intervention that sets all subjects to
receive <span class="math inline">\(A=1\)</span>, <span class="math inline">\(Y_i|A_i=1,W_i\)</span> for all <span class="math inline">\(i=1,\ldots,n\)</span>. The other vector
would represent the predicted outcomes under an intervention that sets
all subjects to receive <span class="math inline">\(A=0\)</span>, <span class="math inline">\(Y_i|A_i=0,W_i\)</span> for all <span class="math inline">\(i=1,\ldots,n\)</span>.</li>
<li>After obtaining these vectors of counterfactual predicted outcomes, all
we would need to do is average and then take the difference in order to
“plug-in” the SL estimator into the target parameter mapping.</li>
<li>In <code>sl3</code> and with our current ATE example, this could be achieved with
<code>mean(sl_fit$predict(A1_task)) - mean(sl_fit$predict(A0_task))</code>;
where <code>A1_task$data</code> would contain all 1’s (or the level that pertains to
receiving the treatment) for the treatment column in the data (keeping
all else the same), and <code>A0_task$data</code> would contain all 0’s (or the
level that pertains to not receiving the treatment) for the treatment
column in the data.</li>
</ul>
</li>
<li><p>It’s a worthwhile exercise to obtain the predicted counterfactual outcomes
and create these counterfactual <code>sl3</code> tasks. It’s too biased, however, to
plug the SL fit into the target parameter mapping, (e.g., calling the result
of <code>mean(sl_fit$predict(A1_task)) - mean(sl_fit$predict(A0_task))</code> the
estimated ATE. We would end up with an estimator for the ATE that was
optimized for estimation of the prediction function, and not the ATE!</p></li>
<li>
<p>Ultimately, we want an estimator that is does the best job in approximating
our question of interest. That is, we care about doing a the best job
possible estimating <span class="math inline">\(\psi_0\)</span>. The SL is an essential step to help us get
there: the counterfactual predicted outcome estimates (like those
explained above), and other SL-derived estimates (like a propensity score)
play a key role in estimating <span class="math inline">\(\psi_0\)</span>. However, SL is not the end of the
estimation procedure. Specifically, if we simply plugged in the SL estimates
into the target parameter, we would not have an asymptotically linear
estimator of the target estimand; the SL is not an efficient substitution
estimator and does not admit statistical inference. Why does this matter?</p>
<ul>
<li><p>An asymptotically linear estimator is one that converges to the estimand a
<span class="math inline">\(\frac{1}{\sqrt{n}}\)</span> rate, thereby permitting formal statistical inference,
i.e., confidence intervals and <span class="math inline">\(p\)</span>-values, (see Chapters 4–6 of
<span class="citation">van der Laan and Rose (<a href="references.html#ref-vdl2011targeted" role="doc-biblioref">2011</a>)</span>).</p></li>
<li><p>Substitution, or plug-in, estimators are desirable because they respect
both the local and global constraints of the statistical model, such as
bounds on an outcome, and have they have better finite-sample properties
(see Chapter 6 of <span class="citation">van der Laan and Rose (<a href="references.html#ref-vdl2011targeted" role="doc-biblioref">2011</a>)</span>).</p></li>
<li>
<p>An efficient estimator is optimal in the sense that it has the lowest
possible variance, and is thus the most precise. An estimator is efficient
if and only if is asymptotically linear with influence curve equal to the
canonical gradient (see Chapter 6 of <span class="citation">van der Laan and Rose (<a href="references.html#ref-vdl2011targeted" role="doc-biblioref">2011</a>)</span>).</p>
<ul>
<li>The canonical gradient is a mathematical object that is specific to
the target estimand, and it provides information on the level of
difficulty of the estimation problem (Chapter 5 of <span class="citation">van der Laan and Rose (<a href="references.html#ref-vdl2011targeted" role="doc-biblioref">2011</a>)</span>).
Various canonical gradients are shown in the chapters that follow.</li>
<li>Practitioners do not need to know how to calculate a canonical
gradient to explain properties that are desirable for an
estimator to possess (like substitution/plug-in, admits valid inference,
efficient, and ability to optimize finite sample performance).
These properties motivate the use TMLE, since TMLE satisfies them.</li>
</ul>
</li>
</ul>
</li>
<li><p>TMLE is a general strategy that succeeds in constructing efficient and
asymptotically linear plug-in estimators that are robust in finite samples.</p></li>
<li><p>SL is fantastic for pure prediction, and for obtaining initial
estimates of components in the likelihood (the first step of TMLE), but we
need the second, targeting/updating/fluctuation, step to have the desirable
statistical properties mentioned above.</p></li>
<li><p>In the chapters that follow, we focus on various targeted maximum likelihood
estimator and the targeted minimum loss-based estimator, both referred to as
TMLE.</p></li>
</ul>
</div>
<div id="appendix" class="section level2">
<h2>
<span class="header-section-number">3.16</span> Appendix<a class="anchor" aria-label="anchor" href="#appendix"><i class="fas fa-link"></i></a>
</h2>
<div id="sl3ex1-sol" class="section level3">
<h3>
<span class="header-section-number">3.16.1</span> Exercise 1 Solution<a class="anchor" aria-label="anchor" href="#sl3ex1-sol"><i class="fas fa-link"></i></a>
</h3>
<p>Here is a potential solution to the <a href="https://tlverse.org/tlverse-handbook/sl3.html#predicting-myocardial-infarction-with-sl3"><code>sl3</code> Exercise 1 – Predicting Myocardial
Infarction with
<code>sl3</code></a>.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html">url</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://raw.githubusercontent.com/benkeser/sllecture/master/chspred.csv"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">chspred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">db_data</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html">setDT</a></span><span class="op">(</span><span class="va">chspred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make task</span></span>
<span><span class="va">chspred_task</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/sl3_Task.html">make_sl3_Task</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">chspred</span>,</span>
<span>  covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">chspred</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"mi"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make learners</span></span>
<span><span class="va">glm_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm.html">Lrnr_glm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">lasso_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ridge_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">enet_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glmnet.html">Lrnr_glmnet</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co"># curated_glm_learner uses formula = "mi ~ smoke + beta"</span></span>
<span><span class="va">curated_glm_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"smoke"</span>, <span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mean_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_mean.html">Lrnr_mean</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span> <span class="co"># That is one mean learner!</span></span>
<span><span class="va">glm_fast_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_glm_fast.html">Lrnr_glm_fast</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ranger_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_ranger.html">Lrnr_ranger</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">svm_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_svm.html">Lrnr_svm</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">xgb_learner</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_xgboost.html">Lrnr_xgboost</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># screening</span></span>
<span><span class="va">screen_cor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Lrnr_screener_correlation</span><span class="op">)</span></span>
<span><span class="va">glm_pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span><span class="va">Pipeline</span>, <span class="va">screen_cor</span>, <span class="va">glm_learner</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># stack learners together</span></span>
<span><span class="va">stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tlverse.org/sl3/reference/Lrnr_base.html">make_learner</a></span><span class="op">(</span></span>
<span>  <span class="va">Stack</span>,</span>
<span>  <span class="va">glm_pipeline</span>, <span class="va">glm_learner</span>,</span>
<span>  <span class="va">lasso_learner</span>, <span class="va">ridge_learner</span>, <span class="va">enet_learner</span>,</span>
<span>  <span class="va">curated_glm_learner</span>, <span class="va">mean_learner</span>, <span class="va">glm_fast_learner</span>,</span>
<span>  <span class="va">ranger_learner</span>, <span class="va">svm_learner</span>, <span class="va">xgb_learner</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># make and train SL</span></span>
<span><span class="va">sl</span> <span class="op">&lt;-</span> <span class="va"><a href="https://tlverse.org/sl3/reference/Lrnr_sl.html">Lrnr_sl</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  learners <span class="op">=</span> <span class="va">stack</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sl_fit</span> <span class="op">&lt;-</span> <span class="va">sl</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">chspred_task</span><span class="op">)</span></span>
<span><span class="va">sl_fit</span><span class="op">$</span><span class="fu">cv_risk</span><span class="op">(</span><span class="va">loss_squared_error</span><span class="op">)</span></span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="origami.html"><span class="header-section-number">2</span> Cross-validation</a></div>
<div class="next"><a href="tmle3.html"><span class="header-section-number">4</span> The TMLE Framework</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li>
<a class="nav-link" href="#sl3"><span class="header-section-number">3</span> Super Learning</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#learning-objectives-2">Learning Objectives</a></li></ul>
</li>
<li><a class="nav-link" href="#introduction-3"><span class="header-section-number">3.1</span> Introduction</a></li>
<li><a class="nav-link" href="#super-learning-with-sl3">Super Learning with sl3:</a></li>
<li>
<a class="nav-link" href="#how-to-fit-the-super-learner"><span class="header-section-number">3.2</span> How to Fit the Super Learner</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#define-the-prediction-task-with-make_sl3_task">1. Define the prediction task with make_sl3_Task</a></li>
<li><a class="nav-link" href="#instantiate-the-super-learner-with-lrnr_sl">2. Instantiate the Super Learner with Lrnr_sl</a></li>
<li><a class="nav-link" href="#fit-the-super-learner-to-the-prediction-task-with-train">3. Fit the Super Learner to the prediction task with train</a></li>
</ul>
</li>
<li><a class="nav-link" href="#additional-sl3-topics">Additional sl3 Topics:</a></li>
<li>
<a class="nav-link" href="#obtaining-predictions"><span class="header-section-number">3.3</span> Obtaining Predictions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#super-learner-and-candidate-learner-predictions"><span class="header-section-number">3.3.1</span> Super learner and candidate learner predictions</a></li>
<li><a class="nav-link" href="#cross-validated-predictions"><span class="header-section-number">3.3.2</span> Cross-validated predictions</a></li>
<li><a class="nav-link" href="#predictions-with-new-data"><span class="header-section-number">3.3.3</span> Predictions with new data</a></li>
<li><a class="nav-link" href="#counterfactual-predictions"><span class="header-section-number">3.3.4</span> Counterfactual predictions</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#summarizing-super-learner-fits"><span class="header-section-number">3.4</span> Summarizing Super Learner Fits</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#super-learner-coefficients-fitted-meta-learner-summary"><span class="header-section-number">3.4.1</span> Super Learner coefficients / fitted meta-learner summary</a></li>
<li><a class="nav-link" href="#cross-validated-predictive-performance"><span class="header-section-number">3.4.2</span> Cross-validated predictive performance</a></li>
<li><a class="nav-link" href="#cross-validated-super-learner"><span class="header-section-number">3.4.3</span> Cross-validated Super Learner</a></li>
<li><a class="nav-link" href="#revere-cross-validated-predictive-performance-of-super-learner"><span class="header-section-number">3.4.4</span> Revere-cross-validated predictive performance of Super Learner</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#discrete-super-learner"><span class="header-section-number">3.5</span> Discrete Super Learner</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#including-ensemble-super-learners-as-candidates-in-discrete-super-learner"><span class="header-section-number">3.5.1</span> Including ensemble Super Learner(s) as candidate(s) in discrete Super Learner</a></li></ul>
</li>
<li><a class="nav-link" href="#parallel-processing"><span class="header-section-number">3.6</span> Parallel Processing</a></li>
<li>
<a class="nav-link" href="#default-data-pre-processing"><span class="header-section-number">3.7</span> Default Data Pre-processing</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#imputation-and-missingness-indicators"><span class="header-section-number">3.7.1</span> Imputation and missingness indicators</a></li>
<li><a class="nav-link" href="#character-and-categorical-covariates"><span class="header-section-number">3.7.2</span> Character and categorical covariates</a></li>
</ul>
</li>
<li><a class="nav-link" href="#learner-documentation"><span class="header-section-number">3.8</span> Learner Documentation</a></li>
<li><a class="nav-link" href="#naming-learners"><span class="header-section-number">3.9</span> Naming Learners</a></li>
<li>
<a class="nav-link" href="#defining-learners-over-grid-of-tuning-parameters"><span class="header-section-number">3.10</span> Defining Learners over Grid of Tuning Parameters</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#do-it-yourself-grid"><span class="header-section-number">3.10.1</span> Do-it-yourself grid</a></li>
<li><a class="nav-link" href="#automatic-grid-and-selection-with-caret"><span class="header-section-number">3.10.2</span> Automatic grid and selection with caret</a></li>
</ul>
</li>
<li><a class="nav-link" href="#learners-with-interactions-and-formula-interface"><span class="header-section-number">3.11</span> Learners with Interactions and formula Interface</a></li>
<li>
<a class="nav-link" href="#covariate-screening"><span class="header-section-number">3.12</span> Covariate Screening</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#variable-importance-based-screeners"><span class="header-section-number">3.12.1</span> Variable importance-based screeners</a></li>
<li><a class="nav-link" href="#coefficient-threshold-based-screeners"><span class="header-section-number">3.12.2</span> Coefficient threshold-based screeners</a></li>
<li><a class="nav-link" href="#correlation-based-screeners"><span class="header-section-number">3.12.3</span> Correlation-based screeners</a></li>
<li><a class="nav-link" href="#augmented-screeners"><span class="header-section-number">3.12.4</span> Augmented screeners</a></li>
<li><a class="nav-link" href="#stack-with-range-of-screeners"><span class="header-section-number">3.12.5</span> Stack with range of screeners</a></li>
</ul>
</li>
<li><a class="nav-link" href="#advanced-sl3-functionality">Advanced sl3 Functionality:</a></li>
<li><a class="nav-link" href="#variable-importance-measures"><span class="header-section-number">3.13</span> Variable Importance Measures</a></li>
<li>
<a class="nav-link" href="#conditional-density-estimation"><span class="header-section-number">3.14</span> Conditional Density Estimation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#moment-restricted-location-scale"><span class="header-section-number">3.14.1</span> Moment-restricted location-scale</a></li>
<li><a class="nav-link" href="#pooled-hazard-regression"><span class="header-section-number">3.14.2</span> Pooled hazard regression</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#exercises-1">Exercises:</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#binary-outcome-prediction">Binary outcome prediction</a></li></ul>
</li>
<li><a class="nav-link" href="#concluding-remarks"><span class="header-section-number">3.15</span> Concluding Remarks</a></li>
<li>
<a class="nav-link" href="#appendix"><span class="header-section-number">3.16</span> Appendix</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#sl3ex1-sol"><span class="header-section-number">3.16.1</span> Exercise 1 Solution</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tlverse/enar2023-workshop/blob/master/07-sl3.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tlverse/enar2023-workshop/edit/master/07-sl3.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>[ENAR 2023 Short Course] Targeted Learning</strong>: Advanced Methods for Causal Machine Learning" was written by Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips. It was last built on updated: March 08, 2023.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
